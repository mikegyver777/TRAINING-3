<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Elite Athlete Training System ‚Äî v12</title>
<style>
  :root{
    --bg:#0b0d0f;--panel:#15181b;--panel2:#0f1215;--ink:#e7eef6;
    --muted:#9fb2c7;--accent:#00ffb3;--accent2:#00ccff;--warn:#ff6b6b;
    --ok:#38ef7d;--border:#26323f;--card:#101418;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;
    background:linear-gradient(180deg,#0b0d0f,#0b0d0f 60%,#0a0f13);
    color:var(--ink);line-height:1.45;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  h1{
    margin:6px 0 2px;text-align:center;font-size:34px;letter-spacing:.4px;
    background:linear-gradient(90deg,#ff7a45, var(--accent), var(--accent2));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  }
  .sub{color:#8aa3ba;text-align:center;margin:0 0 18px;font-size:14px}
  .toolbar{display:flex;gap:10px;justify-content:space-between;align-items:center;
    background:var(--panel);padding:14px;border:1px solid var(--border);border-radius:12px;flex-wrap:wrap}
  .btn{background:#1e2530;border:1px solid #2a3746;color:var(--ink);padding:10px 14px;
    border-radius:8px;cursor:pointer;font-weight:600}
  .btn:hover{border-color:#3c536b}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#001b1b;border:none}
  .month{font-size:20px;color:var(--accent)}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:12px}
  .dow{padding:8px;text-align:center;color:#8aa3ba;font-weight:700}
  .cell{min-height:105px;background:var(--panel);border:1px solid var(--border);border-radius:10px;
    padding:8px;position:relative;cursor:pointer}
  .cell.other{opacity:.35}
  .cell.today{outline:2px solid var(--accent);box-shadow:0 0 16px rgba(0,255,179,.15)}
  .num{font-weight:800;color:#fff;margin-bottom:6px}
  .badge{display:inline-block;font-size:10px;padding:2px 6px;border-radius:4px;margin:1px;background:#10383a;color:#8afddf;border:1px solid #17544d}
  .cns{position:absolute;right:8px;top:8px;width:10px;height:10px;border-radius:50%}
  .cns.low{background:#3ef7a4}.cns.mod{background:#ffbb33}.cns.high{background:#ff5a5a}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
  .modal.show{display:flex}
  .panel{width:min(1100px,96vw);max-height:92vh;overflow:auto;background:var(--panel2);
    border:1px solid var(--border);border-radius:14px;padding:16px 16px 22px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{background:#0f161c;border:1px solid #223140;padding:8px 12px;border-radius:999px;font-weight:700;color:#b9cee2}
  .kpi{flex:1;min-width:240px;background:var(--card);border:1px solid var(--border);border-left:4px solid var(--accent2);
    padding:14px;border-radius:12px}
  .kpi .v{font-size:28px;font-weight:900;color:var(--accent)}
  .sec{margin-top:14px;border:1px solid var(--border);border-radius:12px;background:var(--panel)}
  .sec .hd{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--border);font-weight:800;color:#a7c6e4}
  .sec .bd{padding:12px}
  .grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  label{display:block;font-size:12px;color:#8aa3ba;margin-bottom:6px;font-weight:700}
  input,select,textarea{width:100%;background:#0e1419;border:1px solid #2a3746;color:#e7eef6;border-radius:8px;padding:10px}
  input:focus,select:focus,textarea:focus{outline:none;border-color:#3c8bd9}
  .muted{color:#8aa3ba;font-size:12px}
  .danger{color:var(--warn)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f2a35;padding:8px;text-align:left}
  .right{text-align:right}
  .green{color:var(--ok)}
  .note{background:#0d1714;border:1px dashed #1e6a4f;border-radius:8px;padding:10px;color:#9de8c5}
  .hr-box{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .hr-prev{max-width:100%;border:1px dashed #2a3746;border-radius:10px;padding:8px;text-align:center}
  .hr-prev img{max-width:100%;border-radius:8px}
  .sticky{position:sticky;bottom:0;background:linear-gradient(180deg,transparent,rgba(0,0,0,.8));padding-top:8px}
  .footer{display:flex;gap:10px;justify-content:space-between;align-items:center;padding-top:10px}
  .sm{font-size:12px}
  @media (max-width:820px){.hr-box{grid-template-columns:1fr}}
  .chip{display:inline-block;padding:4px 8px;border:1px solid #274b5b;border-radius:999px;color:#9ad7ef;background:#0c151c;margin-right:6px;margin-top:6px;font-size:12px}
  .tExercise{min-width:135px;max-width:135px;font-size:12px;font-weight:600;padding:6px 4px}
  .tUnit{min-width:68px;max-width:68px;font-size:12px;padding:6px 4px}
  #trkRows td{padding:4px 2px;vertical-align:middle}
  #trkRows select{padding:6px 4px;font-size:12px}
  #trkRows input{padding:6px 4px;font-size:12px;max-width:100%}
  #trkRows .tDist,#trkRows .tReps,#trkRows .tJumps,#trkRows .tSteps,#trkRows .tCols,#trkRows .tTime{width:55px;max-width:55px}
  #trkRows .tRPE{width:45px;max-width:45px}
  #trkRows .tNote{width:75px;max-width:75px}
  .altLegCell{text-align:center;min-width:70px;max-width:70px;padding:2px !important}
  .altLegCell input{font-size:11px;padding:3px;width:32px;max-width:32px;min-width:32px}
  .altLegCell div{display:flex;gap:2px;justify-content:center}
  #trkRows .btn{padding:4px 6px;font-size:11px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>üèÜ ELITE ATHLETE TRAINING SYSTEM<span id="fcIndicator" style="display:none;margin-left:12px;font-size:16px;color:#00ffb3"></span></h1>
    <p class="sub">Load Management ‚Ä¢ sRPE/TRIMP ‚Ä¢ Contacts-Accurate Plyometrics ‚Ä¢ Assault Bike Lab ‚Ä¢ HR Zones</p>

    <div class="toolbar">
      <div class="row">
        <button class="btn" id="prevBtn">‚Äπ Prev</button>
        <button class="btn" id="todayBtn">Today</button>
        <button class="btn" id="nextBtn">Next ‚Ä∫</button>
      </div>
      <div class="month" id="monthTitle">‚Äî</div>
      <div class="row">
        <button class="btn" id="profileBtn">üë§ Profile</button>
        <button class="btn primary" id="weeklyBtn">üìä Weekly Analysis</button>
        <button class="btn" id="periodBtn">üìà Periodization (LP1-LP4)</button>
      </div>
    </div>

    <div id="zoneChips" style="margin-top:8px"></div>

    <div class="grid" id="calHead"></div>
    <div class="grid" id="calBody"></div>
  </div>

  <div class="modal" id="profileModal">
    <div class="panel">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="pill">üë§ Athlete Profile</div>
        <button class="btn" onclick="closeProfile()">‚úï Close</button>
      </div>
      <div class="grid2">
        <div><label>Age (y)</label><input id="pfAge" type="number" min="5" max="100"></div>
        <div><label>Sex</label><select id="pfSex"><option></option><option>Male</option><option>Female</option></select></div>
        <div><label>Height (in)</label><input id="pfHt" type="number" step="0.1"></div>
        <div><label>Weight (lb)</label><input id="pfWt" type="number" step="0.1"></div>
        <div><label>Training Age (years)</label><input id="pfTA" type="number" step="0.1"></div>
        <div><label>Resting HR (bpm)</label><input id="pfRHR" type="number"></div>
        <div><label>Max HR (bpm) <span class="muted sm">auto-calculates</span></label><input id="pfMHR" type="number" placeholder="auto from age"></div>
        <div><label>Sport / Focus</label>
          <select id="pfSport" onchange="toggleFightCampFields()">
            <option value="">Choose...</option>
            <option value="Hybrid">Hybrid (Strength + Power + Endurance + Hypertrophy)</option>
            <option value="MMA">MMA / Fighting</option>
            <option value="Strength">Strength & Powerlifting</option>
            <option value="Endurance">Endurance / Cardio</option>
            <option value="Hypertrophy">Hypertrophy / Bodybuilding</option>
            <option value="BJJ">BJJ / Grappling</option>
            <option value="General">General Fitness</option>
            <option value="Other">Other</option>
            <option value="FIGHT CAMP">ü•ä FIGHT CAMP (Elite Mode)</option>
          </select>
        </div>
        <div><label>Primary Goal</label><input id="pfGoal" placeholder="e.g., fight camp, strength, VO2"></div>
        <div><label>Weekly Availability (days)</label><input id="pfAvail" type="number" min="1" max="14"></div>
      </div>
      
      <!-- FIGHT CAMP MODE FIELDS -->
      <div id="fightCampFields" style="display:none;margin-top:20px">
        <div class="sec">
          <div class="hd">ü•ä Fight Camp Configuration</div>
          <div class="bd">
            <div class="note" style="margin-bottom:12px">
              <b>Elite Fight Camp Mode:</b> AI-driven training prescriptions based on all 16 God-Mode features. System adapts daily based on your logged data to maximize strength, power, conditioning while preventing overtraining.
            </div>
            <div class="grid2">
              <div>
                <label>Camp Length (weeks)</label>
                <input id="fcLength" type="number" min="4" max="20" placeholder="e.g., 8">
              </div>
              <div>
                <label>Current Week</label>
                <input id="fcCurrentWeek" type="number" min="1" placeholder="Auto-starts at 1">
              </div>
              <div>
                <label>Current Weight (lb)</label>
                <input id="fcCurrentWeight" type="number" step="0.1" placeholder="e.g., 185">
              </div>
              <div>
                <label>Fight Week Target Weight (lb)</label>
                <input id="fcTargetWeight" type="number" step="0.1" placeholder="e.g., 170">
              </div>
              <div style="grid-column:span 2">
                <label>Camp Priority</label>
                <select id="fcPriority">
                  <option value="">Choose focus...</option>
                  <option value="Strength">Strength (Maximize 1RM gains)</option>
                  <option value="Conditioning">Conditioning (CP/W‚Ä≤, VO2 max)</option>
                  <option value="Power">Power/Speed (RSI, explosive work)</option>
                  <option value="Technical">Technical Skills (Drilling, sparring)</option>
                  <option value="Weight">Weight Management (Safe cut)</option>
                  <option value="Balanced">Balanced (All domains equally)</option>
                </select>
              </div>
              <div style="grid-column:span 2">
                <label>Current Fitness Level</label>
                <select id="fcFitness">
                  <option value="">Rate your current shape...</option>
                  <option value="10">10 - Fight Ready (Peak condition, competition weight)</option>
                  <option value="9">9 - Very Good (2-3 weeks from peak)</option>
                  <option value="8">8 - Very Good (Minor refinements needed)</option>
                  <option value="7">7 - Good Shape (4-6 weeks from peak)</option>
                  <option value="6">6 - Good Shape (Solid foundation)</option>
                  <option value="5">5 - Moderate (8-10 weeks needed)</option>
                  <option value="4">4 - Moderate (Significant work required)</option>
                  <option value="3">3 - Poor (12+ weeks needed)</option>
                  <option value="2">2 - Poor (Base building required)</option>
                  <option value="1">1 - Out of Shape (16+ weeks needed)</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="sec" style="margin-top:12px">
          <div class="hd">üìÖ Weekly Training Schedule</div>
          <div class="bd">
            <div class="note" style="margin-bottom:12px">
              Define your weekly training structure. The AI will generate specific prescriptions for each session based on your camp goals and real-time fatigue data.
            </div>
            <div id="weeklySchedule"></div>
          </div>
        </div>
      </div>
      
      <div class="sec" id="baselineTestsSection" style="margin-top:12px;display:none">
        <div class="hd" style="background:#00ffb3;color:#0a0f0d;font-size:16px">üî¨ FIGHT CAMP BASELINE ASSESSMENT</div>
        <div class="bd">
          <div class="note" style="margin-bottom:16px;font-size:13px">
            These 4 tests create your complete athletic profile. Do them at camp start, mid-camp, and 2 weeks before fight.<br>
            <b>NO expensive equipment needed</b> - just bodyweight, free weights, medicine ball, and assault bike.
          </div>
          
          <!-- TEST #1: 3-MINUTE BIKE -->
          <div style="margin-bottom:20px;padding:12px;background:#0d1714;border:2px solid #1e6a4f;border-radius:6px">
            <div style="font-weight:700;color:#00ffb3;margin-bottom:8px;font-size:14px">TEST #1: 3-MINUTE ALL-OUT ASSAULT BIKE</div>
            <div style="margin-bottom:10px;font-size:12px;color:#ccc">
              <b>WHAT IT MEASURES:</b> Your gas tank - can you keep pressure on your opponent or do you fade?<br><br>
              <b>WHY IT MATTERS:</b><br>
              ‚Ä¢ Shows if you'll gas out in round 2-3<br>
              ‚Ä¢ Predicts how fast you recover between scrambles<br>
              ‚Ä¢ Tracks if your conditioning is improving week-to-week<br><br>
              <b>HOW TO DO IT:</b><br>
              1. Warm up 5-10 minutes<br>
              2. Go MAX EFFORT for entire 3 minutes (should feel impossible at end)<br>
              3. Record average watts shown on bike console<br>
              4. Record peak heart rate (if you have HR monitor)<br>
              5. Wait 60 seconds ‚Üí record heart rate again (for HRR-60)<br><br>
              <b>WHAT GOOD LOOKS LIKE:</b><br>
              Men: 250+ watts = Elite | 200-249 watts = Good | 150-199 watts = Needs work<br>
              Women: 180+ watts = Elite | 140-179 watts = Good | 100-139 watts = Needs work
            </div>
            <div class="grid2">
              <div>
                <label>Average Watts (3-min test)</label>
                <input id="pfBike3Min" type="number" placeholder="e.g., 245">
              </div>
              <div>
                <label>Peak HR (optional)</label>
                <input id="pfBikePeakHR" type="number" placeholder="e.g., 185">
              </div>
              <div>
                <label>HR at 60 seconds (optional)</label>
                <input id="pfBikeHR60" type="number" placeholder="e.g., 145">
              </div>
              <div style="display:flex;align-items:center;padding-top:20px">
                <span id="hrrDisplay" style="color:#9de8c5;font-size:12px"></span>
              </div>
            </div>
          </div>
          
          <!-- TEST #2: MED BALL THROW -->
          <div style="margin-bottom:20px;padding:12px;background:#0d1714;border:2px solid #1e6a4f;border-radius:6px">
            <div style="font-weight:700;color:#00ffb3;margin-bottom:8px;font-size:14px">TEST #2: MED BALL ROTATIONAL THROW</div>
            <div style="margin-bottom:10px;font-size:12px;color:#ccc">
              <b>WHAT IT MEASURES:</b> Striking power and explosive hip rotation<br><br>
              <b>WHY IT MATTERS:</b><br>
              ‚Ä¢ Measures true power (hip-to-hand transfer, NOT just arm strength)<br>
              ‚Ä¢ Predicts knockout power and throw explosiveness<br>
              ‚Ä¢ Shows left/right imbalances that create injury risk<br><br>
              <b>HOW TO DO IT:</b><br>
              1. Use 8-12 lb medicine ball (men) or 6-10 lb (women)<br>
              2. Stand sideways to wall, 3-4 feet away<br>
              3. Load hip ‚Üí rotate explosively ‚Üí throw ball into wall<br>
              4. Do 3 max throws each side<br>
              5. Record best distance ball travels (or rate power 1-10)<br><br>
              <b>WHAT GOOD LOOKS LIKE:</b><br>
              12+ ft throw = Elite power | 8-11 ft = Good power | 5-7 ft = Developing<br>
              <10% difference side-to-side = Balanced (good)<br>
              >20% difference = Injury risk (needs corrective work)
            </div>
            <div class="grid2">
              <div>
                <label>Med Ball Weight (lb)</label>
                <input id="pfMedBallWeight" type="number" placeholder="e.g., 10">
              </div>
              <div>
                <label>Right Side (ft or 1-10 rating)</label>
                <input id="pfMedBallRight" type="number" step="0.1" placeholder="e.g., 10.5">
              </div>
              <div>
                <label>Left Side (ft or 1-10 rating)</label>
                <input id="pfMedBallLeft" type="number" step="0.1" placeholder="e.g., 9.8">
              </div>
              <div style="display:flex;align-items:center;padding-top:20px">
                <span id="medBallImbalance" style="color:#9de8c5;font-size:12px"></span>
              </div>
            </div>
          </div>
          
          <!-- TEST #3: BROAD JUMP -->
          <div style="margin-bottom:20px;padding:12px;background:#0d1714;border:2px solid #1e6a4f;border-radius:6px">
            <div style="font-weight:700;color:#00ffb3;margin-bottom:8px;font-size:14px">TEST #3: STANDING BROAD JUMP</div>
            <div style="margin-bottom:10px;font-size:12px;color:#ccc">
              <b>WHAT IT MEASURES:</b> Explosive lower body power for scrambles and takedowns<br><br>
              <b>WHY IT MATTERS:</b><br>
              ‚Ä¢ Predicts double-leg penetration power<br>
              ‚Ä¢ Shows if you can explode out of bad positions<br>
              ‚Ä¢ Measures cage pressure and explosive stand-ups<br><br>
              <b>HOW TO DO IT:</b><br>
              1. Feet hip-width apart<br>
              2. Swing arms back ‚Üí explode forward horizontally<br>
              3. Land soft and controlled (NO forward stumble)<br>
              4. Measure heel-to-heel distance<br>
              5. Take best of 3 attempts<br><br>
              <b>WHAT GOOD LOOKS LIKE:</b><br>
              Men: 9+ ft (108+ in) = Elite | 8-8.9 ft (96-107 in) = Good | 7-7.9 ft (84-95 in) = Average<br>
              Women: 7.5+ ft (90+ in) = Elite | 6.5-7.4 ft (78-89 in) = Good | 5.5-6.4 ft (66-77 in) = Average
            </div>
            <div class="grid2">
              <div>
                <label>Best Jump Distance</label>
                <input id="pfBroadJump" type="number" step="0.1" placeholder="e.g., 8.5">
              </div>
              <div>
                <label>Unit</label>
                <select id="pfBroadJumpUnit">
                  <option value="ft">Feet</option>
                  <option value="in">Inches</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- TEST #4: STRENGTH BASE -->
          <div style="margin-bottom:20px;padding:12px;background:#0d1714;border:2px solid #1e6a4f;border-radius:6px">
            <div style="font-weight:700;color:#00ffb3;margin-bottom:8px;font-size:14px">TEST #4: STRENGTH BASE (Choose ONE)</div>
            <div style="margin-bottom:10px;font-size:12px;color:#ccc">
              <b>WHAT IT MEASURES:</b> Grappling strength - can you control, pin, drag your opponent?<br><br>
              <b>WHY IT MATTERS:</b><br>
              ‚Ä¢ Predicts snap-down, underhook, and back control strength<br>
              ‚Ä¢ Shows if you can finish takedowns under fatigue<br>
              ‚Ä¢ Measures collar tie and clinch pressure
            </div>
            <div style="margin-bottom:12px">
              <label style="font-weight:700">Test Type:</label>
              <select id="pfStrengthType" onchange="toggleStrengthFields()">
                <option value="">Choose test...</option>
                <option value="pullup">Weighted Pull-Up 3-5RM (Preferred)</option>
                <option value="deadlift">Trap Bar Deadlift 3-5RM (Alternative)</option>
              </select>
            </div>
            
            <div id="pullupFields" style="display:none">
              <div style="margin-bottom:10px;font-size:12px;color:#ccc">
                <b>HOW TO DO IT:</b><br>
                1. Full dead hang ‚Üí pull chin over bar ‚Üí controlled descent<br>
                2. Add weight until you can only do 3-5 reps with good form<br>
                3. Record your bodyweight + added weight + reps<br><br>
                <b>WHAT GOOD LOOKS LIKE:</b><br>
                Bodyweight + 50% = Elite (e.g., 180 lb + 90 lb)<br>
                Bodyweight + 25-49% = Good<br>
                Bodyweight + 10-24% = Average
              </div>
              <div class="grid2">
                <div>
                  <label>Bodyweight (lb)</label>
                  <input id="pfPullupBW" type="number" placeholder="e.g., 180">
                </div>
                <div>
                  <label>Added Weight (lb)</label>
                  <input id="pfPullupWeight" type="number" placeholder="e.g., 45">
                </div>
                <div>
                  <label>Reps Completed (3-5)</label>
                  <input id="pfPullupReps" type="number" min="1" max="10" placeholder="e.g., 5">
                </div>
                <div style="display:flex;align-items:center;padding-top:20px">
                  <span id="pullupRating" style="color:#9de8c5;font-size:12px"></span>
                </div>
              </div>
            </div>
            
            <div id="deadliftFields" style="display:none">
              <div style="margin-bottom:10px;font-size:12px;color:#ccc">
                <b>HOW TO DO IT:</b><br>
                1. Use trap bar (hex bar)<br>
                2. Find weight you can lift 3-5 times with perfect form<br>
                3. Last rep should be hard but controlled<br><br>
                <b>WHAT GOOD LOOKS LIKE:</b><br>
                Men: 2.5√ó bodyweight = Elite | 2.0-2.4√ó = Good | 1.5-1.9√ó = Average<br>
                Women: 2.0√ó bodyweight = Elite | 1.5-1.9√ó = Good | 1.2-1.4√ó = Average
              </div>
              <div class="grid2">
                <div>
                  <label>Weight Lifted (lb)</label>
                  <input id="pfDeadliftWeight" type="number" placeholder="e.g., 405">
                </div>
                <div>
                  <label>Reps Completed (3-5)</label>
                  <input id="pfDeadliftReps" type="number" min="1" max="10" placeholder="e.g., 5">
                </div>
                <div>
                  <label>Bodyweight (for ratio)</label>
                  <input id="pfDeadliftBW" type="number" placeholder="e.g., 180">
                </div>
                <div style="display:flex;align-items:center;padding-top:20px">
                  <span id="deadliftRating" style="color:#9de8c5;font-size:12px"></span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="note" style="margin-top:16px;padding:12px;background:#0d1f1a;border:1px solid #00ffb3">
            <b>üí° WHEN TO TEST:</b><br>
            ‚úì Week 1 of camp (baseline)<br>
            ‚úì Mid-camp Week 4-5 (progress check)<br>
            ‚úì 2 weeks before fight (final assessment)<br><br>
            <b>These numbers don't lie.</b> If they're improving, your training is working. If they're flat or dropping, you're overtraining.
          </div>
        </div>
      </div>
      
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button class="btn primary" onclick="saveProfile()">‚úì Save Profile</button>
      </div>
    </div>
  </div>

  <div class="modal" id="dayModal">
    <div class="panel">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="pill" id="dayTitle">‚Äî</div>
        <button class="btn" onclick="closeDay()">‚úï Close</button>
      </div>

      <div class="row">
        <div class="kpi"><div class="muted">Estimated CNS Load</div><div class="v" id="kpiCNS">0</div></div>
        <div class="kpi"><div class="muted">Total TSS (TRIMP/sRPE)</div><div class="v" id="kpiTSS">0</div></div>
        <div class="kpi"><div class="muted">Strength Volume (lb)</div><div class="v" id="kpiVOL">0</div></div>
      </div>
      
      <div id="bjjInfoBox" style="display:none;margin-top:10px;padding:10px;background:#0d1f1a;border:1px solid #00ffb3;border-radius:4px">
        <!-- GOD-MODE: BJJ Rehydration & GlycoIndex Info -->
      </div>

      <div class="sec">
        <div class="hd">Modalities (toggle)</div>
        <div class="bd">
          <div class="row">
            <label class="pill"><input type="checkbox" id="mChest" onchange="toggleSection('secChest')"> Chest</label>
            <label class="pill"><input type="checkbox" id="mBack" onchange="toggleSection('secBack')"> Back</label>
            <label class="pill"><input type="checkbox" id="mLegs" onchange="toggleSection('secLegs')"> Legs</label>
            <label class="pill"><input type="checkbox" id="mTrack" onchange="toggleSection('secTrack')"> Track/Plyo</label>
            <label class="pill"><input type="checkbox" id="mStrongman" onchange="toggleSection('secStrongman')"> üèãÔ∏è Strongman</label>
            <label class="pill"><input type="checkbox" id="mBike" onchange="toggleSection('secBike')"> Assault Bike</label>
            <label class="pill"><input type="checkbox" id="mBJJ" onchange="toggleSection('secBJJ')"> BJJ</label>
            <label class="pill"><input type="checkbox" id="mWalk" onchange="toggleSection('secWalk')"> Walking/Recovery</label>
          </div>
        </div>
      </div>

      <div class="sec" id="secChest" style="display:none">
        <div class="hd">üí™ CHEST / UPPER PUSH ‚Äî Strength Session</div>
        <div class="bd">
          <div style="margin-bottom:12px">
            <label style="font-weight:700">Select Exercise:</label>
            <select id="chestExercise" onchange="updateChestFields()" style="width:100%;padding:8px;margin-top:4px">
              <option value="">Choose exercise...</option>
              <optgroup label="Horizontal Press">
                <option value="Bench Press">Bench Press</option>
                <option value="Close-Grip Bench">Close-Grip Bench Press</option>
                <option value="Incline Bench Press">Incline Bench Press</option>
                <option value="Floor Press">Floor Press</option>
              </optgroup>
              <optgroup label="Vertical Press">
                <option value="Overhead Press">Overhead Press (Strict)</option>
                <option value="Push Press">Push Press (w/ Leg Drive)</option>
                <option value="Weighted Dips">Weighted Dips</option>
              </optgroup>
              <optgroup label="Bodyweight">
                <option value="Push-Ups">Push-Ups (Standard)</option>
                <option value="Diamond Push-Ups">Diamond Push-Ups (Triceps)</option>
                <option value="Wide-Grip Push-Ups">Wide-Grip Push-Ups (Chest)</option>
                <option value="Decline Push-Ups">Decline Push-Ups (Upper Chest)</option>
              </optgroup>
              <optgroup label="Power/Explosive">
                <option value="Speed Bench">Speed Bench Press</option>
                <option value="Med Ball Chest Pass">Med Ball Chest Pass</option>
                <option value="Plyo Push-Up">Plyo Push-Up</option>
              </optgroup>
            </select>
          </div>
          <div id="chestBox"></div>
        </div>
      </div>
      <div class="sec" id="secBack" style="display:none">
        <div class="hd">üí™ BACK / UPPER PULL ‚Äî Strength Session</div>
        <div class="bd">
          <div style="margin-bottom:12px">
            <label style="font-weight:700">Select Exercise:</label>
            <select id="backExercise" onchange="updateBackFields()" style="width:100%;padding:8px;margin-top:4px">
              <option value="">Choose exercise...</option>
              <optgroup label="Vertical Pull">
                <option value="Weighted Pull-Ups">Weighted Pull-Ups</option>
                <option value="Chin-Ups">Chin-Ups (Supinated)</option>
                <option value="Lat Pulldown">Lat Pulldown</option>
              </optgroup>
              <optgroup label="Horizontal Pull">
                <option value="Barbell Row">Barbell Row</option>
                <option value="Pendlay Row">Pendlay Row (Dead Stop)</option>
                <option value="Chest-Supported Row">Chest-Supported Row</option>
                <option value="Seated Cable Row">Seated Cable Row</option>
              </optgroup>
              <optgroup label="Grip/Clinch Specific">
                <option value="Towel Pull-Ups">Towel Pull-Ups</option>
                <option value="Gi Pull-Ups">Gi Pull-Ups</option>
                <option value="Fat Grip Pull-Ups">Fat Grip Pull-Ups</option>
                <option value="Rope Climb">Rope Climb</option>
              </optgroup>
              <optgroup label="Power">
                <option value="Hang High Pull">Hang High Pull</option>
              </optgroup>
              <optgroup label="Accessories">
                <option value="Face Pulls">Face Pulls</option>
              </optgroup>
            </select>
          </div>
          <div id="backBox"></div>
        </div>
      </div>
      <div class="sec" id="secLegs" style="display:none">
        <div class="hd">üí™ LEGS ‚Äî Strength Session</div>
        <div class="bd">
          <div style="margin-bottom:12px">
            <label style="font-weight:700">Select Exercise:</label>
            <select id="legsExercise" onchange="updateLegsFields()" style="width:100%;padding:8px;margin-top:4px">
              <option value="">Choose exercise...</option>
              <optgroup label="Squat Variations">
                <option value="Back Squat">Back Squat</option>
                <option value="Front Squat">Front Squat</option>
                <option value="Zercher Squat">Zercher Squat</option>
                <option value="Box Squat">Box Squat</option>
                <option value="Safety Bar Squat">Safety Bar Squat</option>
                <option value="Goblet Squat">Goblet Squat</option>
              </optgroup>
              <optgroup label="Deadlift Variations">
                <option value="Trap Bar Deadlift">Trap Bar Deadlift</option>
                <option value="Sumo Deadlift">Sumo Deadlift</option>
                <option value="Romanian Deadlift">Romanian Deadlift (RDL)</option>
              </optgroup>
              <optgroup label="Unilateral">
                <option value="Bulgarian Split Squat">Bulgarian Split Squat</option>
                <option value="Reverse Lunge">Reverse Lunge</option>
                <option value="Walking Lunge">Walking Lunge</option>
                <option value="Step-Up (High Box)">Step-Up (High Box)</option>
                <option value="Single-Leg RDL">Single-Leg RDL</option>
              </optgroup>
              <optgroup label="Olympic/Power">
                <option value="Power Clean">Power Clean</option>
                <option value="Hang Power Clean">Hang Power Clean</option>
                <option value="Clean Pull">Clean Pull</option>
                <option value="Speed Deadlift">Speed Deadlift</option>
                <option value="Speed Squat">Speed Squat</option>
              </optgroup>
              <optgroup label="Ballistic">
                <option value="Kettlebell Swing">Kettlebell Swing</option>
                <option value="Kettlebell Snatch">Kettlebell Snatch</option>
                <option value="Double KB Clean">Double KB Clean</option>
              </optgroup>
            </select>
          </div>
          <div id="legsBox"></div>
        </div>
      </div>

      <div class="sec" id="secTrack" style="display:none">
        <div class="hd">üèÉ Track / Plyometrics ‚Äî Per-Rep Logging</div>
        <div class="bd">
          <div style="margin-bottom:12px">
            <label style="font-weight:700">Select Exercise:</label>
            <select id="trackExercise" onchange="updateTrackFields()" style="width:100%;padding:8px;margin-top:4px">
              <option value="">Choose exercise...</option>
              <optgroup label="Horizontal Power">
                <option value="Broad Jump">Broad Jump</option>
                <option value="Bounding">Bounding</option>
                <option value="Lateral Bounds">Lateral Bounds</option>
              </optgroup>
              <optgroup label="Vertical Power">
                <option value="Box Jump">Box Jump</option>
                <option value="Hurdle Hops">Hurdle Hops</option>
                <option value="Tuck Jumps">Tuck Jumps</option>
                <option value="Split Jump">Split Jump</option>
                <option value="Box Jump to Sprint">Box Jump to Sprint</option>
              </optgroup>
              <optgroup label="Reactive/Advanced">
                <option value="Depth Jump">‚ö†Ô∏è Depth Jump (LP3 Only)</option>
                <option value="Drop Landing">Drop Landing (Technique)</option>
              </optgroup>
              <optgroup label="Lateral">
                <option value="Lateral Skater Hops">Lateral Skater Hops</option>
              </optgroup>
              <optgroup label="Elastic/Spring">
                <option value="Pogo Hops">Pogo Hops</option>
                <option value="Single-Leg Hop">Single-Leg Hop</option>
              </optgroup>
              <optgroup label="Rotational Power">
                <option value="Med Ball Rotational Throw">Med Ball Rotational Throw</option>
                <option value="Med Ball Shotput">Med Ball Shotput Throw</option>
                <option value="Med Ball Overhead Slam">Med Ball Overhead Slam</option>
                <option value="Med Ball Scoop Toss">Med Ball Scoop Toss</option>
              </optgroup>
              <optgroup label="Rotational Strength">
                <option value="Landmine Rotational Press">Landmine Rotational Press</option>
                <option value="Landmine Rainbow">Landmine Rainbow</option>
                <option value="Cable Woodchopper High-Low">Cable Woodchopper (High-Low)</option>
                <option value="Cable Woodchopper Low-High">Cable Woodchopper (Low-High)</option>
                <option value="Pallof Press">Pallof Press (Anti-Rotation)</option>
                <option value="Turkish Get-Up">Turkish Get-Up</option>
              </optgroup>
            </select>
          </div>
          <div id="trackFieldsCustom" style="display:none;margin-bottom:16px"></div>
          
          <div class="sec" style="margin-top:0;background:#0d1714;border:1px solid #1e6a4f">
            <div class="hd" style="background:#0f1b17;border-bottom:1px solid #1e6a4f;color:#9de8c5;display:flex;justify-content:space-between;align-items:center">
              <span>‚úì Warmup Routine Checklist</span>
              <span id="warmupProgress" style="font-size:14px;color:#38ef7d">0/9 Complete</span>
            </div>
            <div class="bd" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:8px">
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Walk on toes 20yd fwd ‚Üí 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Walk on heels 20yd fwd ‚Üí 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Lunge 10yd fwd / 10yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Single yard hops 20yd fwd ‚Üí 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Single yard hops LEFT 20yd fwd ‚Üí RIGHT 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Double yard hops 20yd fwd ‚Üí 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Single leg double yard hops LEFT 20yd fwd ‚Üí RIGHT 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Skipping 20yd fwd ‚Üí 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> High knees 15yd total
              </label>
            </div>
          </div>

          <div class="note" style="margin-top:10px">
            <b>How it works:</b><br>
            ‚Ä¢ Click <b>"+ Add Exercise"</b> to add each exercise<br>
            ‚Ä¢ Enter exercise name (e.g., "Broad Jump", "Single Leg Stair Jump")<br>
            ‚Ä¢ Choose <b>Bilateral</b> (both legs) or <b>Unilateral</b> (single leg)<br>
            ‚Ä¢ Enter number of sets and reps per set<br>
            ‚Ä¢ For unilateral: enter R Leg and L Leg reps separately<br>
            <br>
            <b>Surface Type Impact on Tendon Load:</b><br>
            ‚Ä¢ <b>Turf (0.9√ó)</b> - Softer, reduced impact stress<br>
            ‚Ä¢ <b>Track (1.1√ó)</b> - Standard surface (default)<br>
            ‚Ä¢ <b>Concrete (1.4√ó)</b> - Hard surface, maximum impact stress<br>
            <br>
            <b>UFC PI Tendon Load System (Impact Coefficients):</b><br>
            ‚Ä¢ Low Impact Bounding = 0.6√ó (gentle elastic work)<br>
            ‚Ä¢ Jump Rope / Fast Contacts = 0.8√ó (moderate impact)<br>
            ‚Ä¢ Box Jumps / Drop Landing = 1.2√ó (higher eccentric load)<br>
            ‚Ä¢ Depth Jumps / Stadium Stairs = 1.5√ó+ (maximum tendon stress)<br>
            <br>
            <b>Tendon Load Safety Zones:</b><br>
            ‚Ä¢ 60-120 contacts/week = Base conditioning<br>
            ‚Ä¢ 120-200 = Power development<br>
            ‚Ä¢ 200-350 = High elastic training<br>
            ‚Ä¢ >350 = Injury risk zone (deload required)<br>
            <br>
            <b>RPE (Rate of Perceived Exertion):</b><br>
            ‚Ä¢ 1-3: Easy/Warmup | 4-6: Moderate | 7-8: Hard | 9-10: Max Effort<br>
            ‚Ä¢ Higher RPE = Higher CNS load & TSS (affects recovery needs)
          </div>
          <div class="grid2">
            <div>
              <label>Sleep (h)</label>
              <input id="trkSleep" type="number" step="0.5" placeholder="7.5" />
            </div>
            <div>
              <label>Achilles/Calf</label>
              <select id="trkAch">
                <option value="">Choose...</option>
                <option>Fresh</option><option>Tight</option><option>Sore</option>
              </select>
            </div>
            <div>
              <label>Surface Type</label>
              <select id="trkSurface">
                <option value="track">Track (1.0√ó)</option>
                <option value="turf">Turf (0.9√ó)</option>
                <option value="concrete">Concrete (1.4√ó)</option>
              </select>
            </div>
          </div>

          <div class="sec" style="margin-top:10px">
            <div class="hd">Exercises</div>
            <div class="bd">
              <div class="row">
                <button class="btn" onclick="addTrackExercise()">+ Add Exercise</button>
                <div class="muted sm">Add each exercise with sets and reps.</div>
              </div>
              <div id="trackExercises" style="margin-top:10px">
                <!-- Exercises will be added here -->
              </div>
            </div>
          </div>

          <div class="hr-box" style="margin-top:10px">
            <div>
              <label>HR Screenshot (optional)</label>
              <div class="hr-prev" id="trkPrev">No image</div>
              <input id="trkImg" type="file" accept="image/*" onchange="previewImg(this,'trkPrev')" />
            </div>
            <div>
              <label>Manual HR summary</label>
              <div class="grid2">
                <div><label>Avg HR</label><input id="trkAvgHR" type="number"></div>
                <div><label>Peak HR</label><input id="trkPeakHR" type="number"></div>
                <div><label>Min in Zone 5</label><input id="trkZ5" type="number"></div>
                <div><label>Min in Zone 4</label><input id="trkZ4" type="number"></div>
                <div style="grid-column:span 2">
                  <label>DFA-Œ±1 (HRV Complexity)</label>
                  <input id="trkDFA" type="number" step="0.01" placeholder="Optional - Advanced HRV metric">
                </div>
              </div>
              <p class="muted sm">From Polar app summary for best accuracy. DFA-Œ±1 <0.75 during easy work = autonomic overtraining.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="sec" id="secStrongman" style="display:none">
        <div class="hd">üèãÔ∏è STRONGMAN ‚Äî Old School Power</div>
        <div class="bd">
          <div style="margin-bottom:12px">
            <label style="font-weight:700">Select Exercise:</label>
            <select id="strongmanExercise" onchange="updateStrongmanFields()" style="width:100%;padding:8px;margin-top:4px">
              <option value="">Choose exercise...</option>
              <optgroup label="Implement Work">
                <option value="Tire Flip">Tire Flip</option>
                <option value="Sledgehammer Slam">Sledgehammer Slam</option>
                <option value="Atlas Stone Lift">Atlas Stone Lift</option>
                <option value="Log Press">Log Press</option>
              </optgroup>
              <optgroup label="Loaded Carries">
                <option value="Keg Carry">Keg Carry</option>
                <option value="Sandbag Shouldering">Sandbag Shouldering</option>
                <option value="Tire Drag">Tire Drag</option>
                <option value="Yoke Walk">Yoke Walk</option>
              </optgroup>
              <optgroup label="Heavy Bag">
                <option value="Heavy Bag Punches">Heavy Bag Punches</option>
                <option value="Heavy Bag Kicks">Heavy Bag Kicks</option>
              </optgroup>
            </select>
          </div>
          <div id="strongmanBox"></div>
        </div>
      </div>

      <div class="sec" id="secBike" style="display:none">
        <div class="hd">üö¥ Assault Bike Lab</div>
        <div class="bd">
          <div class="grid2">
            <div>
              <label>Protocol</label>
              <select id="bikeProto" onchange="applyBikeUI()">
                <optgroup label="Custom Protocols">
                  <option value="c1">C1 ‚Äî Max RPM per round</option>
                  <option value="c2">C2 ‚Äî Max RPM ‚Üí Z5 ‚Üí stop (time-cap)</option>
                  <option value="c3">C3 ‚Äî Max RPM then 70% hold (30s)</option>
                </optgroup>
                <optgroup label="Standard Intervals">
                  <option value="steady">Steady Z2 (aerobic base)</option>
                  <option value="alt">Alt 30s hard / 30s easy</option>
                  <option value="z5">Zone 5 Intervals</option>
                  <option value="peak" selected>Peak RPM Sprints</option>
                </optgroup>
                <optgroup label="UFC PI Protocols (Optional)">
                  <option value="ngannou">Ngannou Power (10√ó30s/30s)</option>
                  <option value="progressive">Progressive Cal (5min continuous)</option>
                  <option value="extended">Extended Capacity (6√ó5min/2min)</option>
                  <option value="tabata">Tabata (8√ó20s/10s)</option>
                  <option value="sprints">Power Sprints (10s max/50s rest)</option>
                </optgroup>
              </select>
            </div>
            <div id="roundBlock"><label>Rounds</label><input id="bikeRounds" type="number" min="1" value="6"></div>
            <div id="workBlock"><label>Work (s)</label><input id="bikeWork" type="number" value="20"></div>
            <div id="restBlock"><label>Rest (s)</label><input id="bikeRest" type="number" value="100"></div>
            <div id="timeCapBlock" style="display:none"><label>Time Cap (min)</label><input id="bikeCap" type="number" value="25"></div>
            <div><label style="color:#38ef7d">Total Routine Time (min)</label><input id="bikeTotalTime" type="number" step="0.5" placeholder="e.g., 25.5" style="border-color:#38ef7d"></div>
            <div><label id="bikeTargetLabel">Target HR</label><input id="bikeTarget" type="number" value="90"></div>
            <div><label>Sleep (h)</label><input id="bikeSleep" type="number" step="0.5" placeholder="7.5"></div>
          </div>

          <div id="protocolHints" class="muted sm" style="margin-top:8px;padding:8px;background:#0a0f0d;border-left:3px solid #1e6a4f">
            <span id="hintsText">Select protocol to see relevant fields...</span>
          </div>

          <div id="bikeProtocolDetails" class="note" style="margin-top:10px;font-size:12px;background:#0d1714;border:1px solid #1e6a4f;padding:12px">
            <b>üìã Protocol Instructions:</b><br>
            <span id="protocolInstructions">Select a protocol above to see detailed instructions...</span>
          </div>

          <div class="sec" style="margin-top:10px">
            <div class="hd">Rounds / Reps</div>
            <div class="bd">
              <div class="row" id="c2Buttons" style="display:none">
                <button class="btn" onclick="addBikeRow({})">+ Add Rep</button>
                <div class="muted sm">Stop when time-cap elapses. Track Max RPM, Time‚ÜíZ5, Total Rep Time, Time‚ÜíZ2, HHR60 (HR recovery quality)</div>
              </div>
              <table id="bikeTable" style="font-size:12px">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Max RPM</th>
                    <th>Avg RPM</th>
                    <th>Cals</th>
                    <th>Watts</th>
                    <th>Time ‚Üí Z5 (s)</th>
                    <th>Total Rep Time (s)</th>
                    <th>Time ‚Üí Z2 (s)</th>
                    <th>HHR60</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="hr-box" style="margin-top:10px">
            <div>
              <label>HR Screenshot</label>
              <div class="hr-prev" id="bikePrev">No image</div>
              <input id="bikeImg" type="file" accept="image/*" onchange="previewImg(this,'bikePrev')" />
            </div>
            <div>
              <label>Manual HR summary</label>
              <div class="grid2">
                <div><label>Avg HR</label><input id="bikeAvgHR" type="number"></div>
                <div><label>Peak HR</label><input id="bikePeakHR" type="number"></div>
                <div><label>Min in Z5</label><input id="bikeZ5" type="number"></div>
                <div><label>Min in Z4</label><input id="bikeZ4" type="number"></div>
                <div style="grid-column:span 2">
                  <label>DFA-Œ±1 (HRV Complexity)</label>
                  <input id="bikeDFA" type="number" step="0.01" placeholder="Optional - Advanced">
                </div>
              </div>
              <div class="note" style="margin-top:6px;font-size:11px">
                <b>God-Mode:</b> Avg HR enables Banister TRIMP calculation (exponential internal load formula). DFA-Œ±1 <0.75 during easy work = autonomic overtraining.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="sec" id="secBJJ" style="display:none">
        <div class="hd">ü•ã BJJ</div>
        <div class="bd grid2">
          <div><label>Spar time (min)</label><input id="bjjTime" type="number" placeholder="45"></div>
          <div><label>Intensity</label>
            <select id="bjjInt">
              <option value="">Choose‚Ä¶</option><option>High</option><option>Medium</option><option>Light</option>
            </select>
          </div>
          <div><label>Weight before (lb)</label><input id="bjjW1" type="number" step="0.1"></div>
          <div><label>Weight after (lb)</label><input id="bjjW2" type="number" step="0.1"></div>
          <div><label>Feel</label>
            <select id="bjjFeel">
              <option value="">Choose‚Ä¶</option><option>Great</option><option>Good</option><option>Tired</option><option>Beat</option>
            </select>
          </div>
          <div><label>Sleep (h)</label><input id="bjjSleep" type="number" step="0.5"></div>
          <div><label>Z4 Time (min) - GlycoIndex</label><input id="bjjZ4" type="number" placeholder="Optional"></div>
          <div><label>Z5 Time (min) - GlycoIndex</label><input id="bjjZ5" type="number" placeholder="Optional"></div>
          <div><label>Bursts/Scrambles - GlycoIndex</label><input id="bjjBursts" type="number" placeholder="Optional"></div>
          <div style="grid-column:span 2">
            <div class="note" style="font-size:11px">
              <b>God-Mode GlycoIndex:</b> Measures glycolytic stress. Formula: t_Z4 + 2√ót_Z5 + 0.5√óBursts. High glycolytic stress (>30) requires extended carb repletion.
            </div>
          </div>
        </div>
      </div>

      <div class="sec" id="secWalk" style="display:none">
        <div class="hd">üö∂ Walking / Recovery</div>
        <div class="bd grid2">
          <div><label>Duration (min)</label><input id="wDur" type="number"></div>
          <div><label>Distance (mi)</label><input id="wDist" type="number" step="0.01"></div>
          <div><label>Pace (min/mi)</label><input id="wPace" type="number" step="0.1"></div>
          <div><label>Terrain</label>
            <select id="wTer"><option>Flat</option><option>Hills</option><option>Steep</option></select>
          </div>
          <div><label>Purpose</label>
            <select id="wPur"><option>Recovery</option><option>Zone 2</option><option>General</option></select>
          </div>
        </div>
      </div>

      <div class="sticky">
        <div class="footer">
          <button class="btn primary" onclick="saveDay()">‚úì Save Day & Recompute</button>
          <div class="muted sm" id="saveNote">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="weekModal">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="pill">üìä Weekly Analysis</div>
        <button class="btn" onclick="closeWeek()">‚úï Close</button>
      </div>
      <div id="weekBody" style="margin-top:10px"></div>
    </div>
  </div>

  <div class="modal" id="periodModal">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="pill">üìà Periodization (LP1-LP4)</div>
        <button class="btn" onclick="closePeriod()">‚úï Close</button>
      </div>
      <div id="periodBody" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- FIGHT CAMP PRESCRIPTION MODAL -->
  <div class="modal" id="prescriptionModal">
    <div class="panel" style="max-width:800px">
      <div class="row" style="justify-content:space-between">
        <div class="pill">üìã Workout Prescription</div>
        <button class="btn" onclick="closePrescription()">‚úï Close</button>
      </div>
      <div id="prescriptionBody" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- FIGHT CAMP DAILY DASHBOARD (replaces calendar when in fight camp mode) -->
  <div id="fightCampDashboard" style="display:none"></div>

<script>
  const fmt=(n)=>Number(n||0);
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const parseSets=(s)=>{ if(!s) return 0; if(String(s).includes('x')){ const [a,b]=String(s).toLowerCase().split('x').map(v=>parseInt(v||0)); return (isNaN(a)||isNaN(b))?0:a*b; } const n=parseInt(s); return isNaN(n)?0:n; };
  const LS={get(k,def){try{return JSON.parse(localStorage.getItem(k))??def}catch(_){return def}},set(k,v){localStorage.setItem(k,JSON.stringify(v))}};

  // ============================================
  // EXERCISE DATABASE (UFC PI Standard)
  // ============================================
  const EXERCISES = {
    strengthLower: [
      {name:'Trap Bar Deadlift',sets:[4,5],reps:[3,5],int:0.85,rest:180,tempo:'Explosive up, controlled down'},
      {name:'Back Squat',sets:[4,5],reps:[3,5],int:0.80,rest:180,tempo:'Controlled descent, explosive drive'},
      {name:'Front Squat',sets:[4,5],reps:[4,6],int:0.78,rest:150,tempo:'Controlled descent, explosive drive'},
      {name:'Zercher Squat',sets:[3,4],reps:[5,8],int:0.70,rest:120,tempo:'Slow eccentric, explosive concentric'},
      {name:'Bulgarian Split Squat',sets:[3,4],reps:[6,8],int:0.70,rest:90,tempo:'2-sec pause at bottom'},
      {name:'Reverse Lunge',sets:[3,4],reps:[6,8],int:0.65,rest:90,tempo:'Controlled descent, explosive return'},
      {name:'Romanian Deadlift',sets:[3,4],reps:[6,8],int:0.75,rest:120,tempo:'Hinge at hips, hamstring stretch'},
      {name:'Sumo Deadlift',sets:[4,5],reps:[3,5],int:0.82,rest:180,tempo:'Wide stance, vertical torso'},
      {name:'Box Squat',sets:[5,6],reps:[3,5],int:0.75,rest:150,tempo:'Pause on box, explosive up'},
      {name:'Safety Bar Squat',sets:[4,5],reps:[4,6],int:0.78,rest:150,tempo:'Upright torso, deep squat'},
      {name:'Walking Lunge',sets:[3,4],reps:[10,12],int:0.60,rest:90,tempo:'Long strides, knee to ground'},
      {name:'Step-Up (High Box)',sets:[3,4],reps:[6,8],int:0.70,rest:90,tempo:'Drive through front leg'},
      {name:'Single-Leg RDL',sets:[3,4],reps:[8,10],int:0.60,rest:75,tempo:'Balance and posterior chain'},
      {name:'Goblet Squat',sets:[3,4],reps:[10,12],int:0.65,rest:60,tempo:'Upright torso, deep squat'}
    ],
    strengthUpper: [
      {name:'Bench Press',sets:[4,5],reps:[3,5],int:0.85,rest:180,tempo:'Touch chest, explosive press'},
      {name:'Close-Grip Bench',sets:[4,5],reps:[4,6],int:0.82,rest:180,tempo:'Pause at chest, explosive press'},
      {name:'Incline Bench Press',sets:[4,5],reps:[4,6],int:0.80,rest:150,tempo:'30-45 degree angle'},
      {name:'Floor Press',sets:[4,5],reps:[4,6],int:0.82,rest:150,tempo:'Elbows touch floor, explosive press'},
      {name:'Weighted Pull-Ups',sets:[4,5],reps:[4,6],int:0.80,rest:150,tempo:'Controlled up, pause, controlled down'},
      {name:'Chin-Ups',sets:[4,5],reps:[5,8],int:0.75,rest:120,tempo:'Supinated grip, full ROM'},
      {name:'Weighted Dips',sets:[3,4],reps:[5,8],int:0.75,rest:120,tempo:'Full ROM, controlled tempo'},
      {name:'Push-Ups',sets:[3,5],reps:[15,25],int:0.65,rest:60,tempo:'Chest to floor, full lockout'},
      {name:'Diamond Push-Ups',sets:[3,4],reps:[10,15],int:0.70,rest:75,tempo:'Hands together, tricep focus'},
      {name:'Wide-Grip Push-Ups',sets:[3,4],reps:[12,20],int:0.68,rest:60,tempo:'Hands wide, chest focus'},
      {name:'Decline Push-Ups',sets:[3,4],reps:[12,18],int:0.72,rest:75,tempo:'Feet elevated, upper chest focus'},
      {name:'Overhead Press',sets:[3,4],reps:[5,8],int:0.75,rest:120,tempo:'Strict form, no leg drive'},
      {name:'Push Press',sets:[4,5],reps:[4,6],int:0.80,rest:120,tempo:'Leg drive into press'},
      {name:'Barbell Row',sets:[4,5],reps:[5,8],int:0.78,rest:120,tempo:'Pull to sternum, control descent'},
      {name:'Pendlay Row',sets:[4,5],reps:[5,8],int:0.80,rest:120,tempo:'Dead stop each rep'},
      {name:'Chest-Supported Row',sets:[3,4],reps:[8,10],int:0.75,rest:90,tempo:'No momentum, strict'},
      {name:'Seated Cable Row',sets:[3,4],reps:[8,12],int:0.70,rest:75,tempo:'Squeeze shoulder blades'},
      {name:'Face Pulls',sets:[3,4],reps:[12,15],int:0.60,rest:60,tempo:'High pull to face'},
      {name:'Lat Pulldown',sets:[3,4],reps:[8,12],int:0.72,rest:90,tempo:'Pull to upper chest'}
    ],
    power: [
      {name:'Power Clean',sets:[4,5],reps:[2,3],int:0.75,rest:180,tempo:'Explosive triple extension'},
      {name:'Power Snatch',sets:[4,5],reps:[2,3],int:0.70,rest:180,tempo:'Fast pull, aggressive catch'},
      {name:'Hang Power Clean',sets:[4,5],reps:[2,3],int:0.72,rest:180,tempo:'From mid-thigh'},
      {name:'Hang Power Snatch',sets:[4,5],reps:[2,3],int:0.68,rest:180,tempo:'From mid-thigh'},
      {name:'Clean Pull',sets:[4,5],reps:[3,5],int:0.85,rest:150,tempo:'Explosive pull, no catch'},
      {name:'Snatch Pull',sets:[4,5],reps:[3,5],int:0.80,rest:150,tempo:'Explosive pull, no catch'},
      {name:'Hang High Pull',sets:[4,5],reps:[3,5],int:0.70,rest:150,tempo:'Explosive shrug and pull'},
      {name:'Speed Deadlift',sets:[6,8],reps:[2,3],int:0.60,rest:90,tempo:'Max speed off floor'},
      {name:'Speed Squat',sets:[6,8],reps:[2,3],int:0.60,rest:90,tempo:'Explosive concentric'},
      {name:'Speed Bench',sets:[6,8],reps:[3,5],int:0.60,rest:60,tempo:'Explosive press, fast lockout'},
      {name:'Kettlebell Swing',sets:[4,5],reps:[10,15],int:0.70,rest:90,tempo:'Ballistic hip snap'},
      {name:'Kettlebell Snatch',sets:[4,5],reps:[6,8],int:0.72,rest:120,tempo:'Hip snap, overhead lockout'},
      {name:'Double KB Clean',sets:[4,5],reps:[5,8],int:0.70,rest:120,tempo:'Explosive pull to rack'},
      {name:'Dumbbell Snatch',sets:[4,5],reps:[6,8],int:0.68,rest:90,tempo:'Single-arm power'}
    ],
    rotational: [
      {name:'Med Ball Rotational Throw',sets:[3,4],reps:[6,8],int:0.70,rest:90,tempo:'Explosive hip rotation, both sides'},
      {name:'Med Ball Shotput',sets:[3,4],reps:[5,6],int:0.75,rest:90,tempo:'Max power, step into throw'},
      {name:'Med Ball Overhead Slam',sets:[3,4],reps:[8,10],int:0.70,rest:75,tempo:'Triple extension, aggressive slam'},
      {name:'Med Ball Scoop Toss',sets:[3,4],reps:[6,8],int:0.68,rest:90,tempo:'Low to high explosive'},
      {name:'Landmine Rotational Press',sets:[3,4],reps:[6,8],int:0.70,rest:75,tempo:'Rotate from hips, explosive press'},
      {name:'Landmine Rainbow',sets:[3,4],reps:[8,10],int:0.65,rest:75,tempo:'Arc motion, control'},
      {name:'Cable Woodchopper High-Low',sets:[3],reps:[8,10],int:0.65,rest:60,tempo:'Controlled rotation, explosive chop'},
      {name:'Cable Woodchopper Low-High',sets:[3],reps:[8,10],int:0.65,rest:60,tempo:'Drive from legs, rotate core'},
      {name:'Pallof Press',sets:[3,4],reps:[10,12],int:0.60,rest:60,tempo:'Anti-rotation hold'},
      {name:'Turkish Get-Up',sets:[3,4],reps:[3,5],int:0.65,rest:120,tempo:'Controlled, all positions'},
      {name:'Rotational KB Swing',sets:[3,4],reps:[8,10],int:0.65,rest:90,tempo:'Light weight, max rotation speed'},
      {name:'Single-Arm Landmine Press',sets:[3,4],reps:[6,8],int:0.72,rest:90,tempo:'Resist rotation'}
    ],
    plyometric: [
      {name:'Broad Jump',sets:[3,5],reps:[3,5],int:0.90,rest:120,tempo:'Max effort, soft landing'},
      {name:'Box Jump',sets:[3,5],reps:[3,5],int:0.85,rest:120,tempo:'Explosive takeoff, stick landing'},
      {name:'Depth Jump',sets:[3,4],reps:[3,5],int:0.95,rest:180,tempo:'LP3 ONLY - Max reactive'},
      {name:'Hurdle Hops',sets:[3,4],reps:[6,8],int:0.82,rest:120,tempo:'Quick ground contact'},
      {name:'Lateral Skater Hops',sets:[3,4],reps:[6,8],int:0.75,rest:90,tempo:'Quick lateral power'},
      {name:'Bounding',sets:[3,4],reps:[20,30],int:0.80,rest:120,tempo:'Long strides, max distance'},
      {name:'Pogo Hops',sets:[3,4],reps:[10,15],int:0.70,rest:90,tempo:'Minimal ground contact'},
      {name:'Single-Leg Hop',sets:[3,4],reps:[5,8],int:0.75,rest:90,tempo:'Balance and power'},
      {name:'Tuck Jumps',sets:[3,4],reps:[6,8],int:0.85,rest:120,tempo:'Knees to chest'},
      {name:'Split Jump',sets:[3,4],reps:[8,10],int:0.78,rest:90,tempo:'Explosive lunge jump'},
      {name:'Lateral Bounds',sets:[3,4],reps:[6,8],int:0.80,rest:120,tempo:'Single-leg lateral'},
      {name:'Drop Landing',sets:[3,4],reps:[5,6],int:0.75,rest:120,tempo:'Absorption drill'},
      {name:'Box Jump to Sprint',sets:[3,4],reps:[4,5],int:0.88,rest:180,tempo:'Jump + 10yd sprint'}
    ],
    conditioning: [
      {name:'Assault Bike C2 Protocol',sets:[6,8],reps:['25s cap'],int:0.95,rest:'HR<140',tempo:'Max RPM until HR Zone 5'},
      {name:'Assault Bike Sprints',sets:[8,10],reps:[20,30],int:0.90,rest:90,tempo:'All-out'},
      {name:'Assault Bike Tabata',sets:[8],reps:[20],int:0.95,rest:10,tempo:'20s on / 10s off'},
      {name:'Track 200m Repeats',sets:[6,8],reps:['200m'],int:0.85,rest:120,tempo:'<35s men, <40s women'},
      {name:'Track 150m Repeats',sets:[8,10],reps:['150m'],int:0.90,rest:90,tempo:'Near-sprint pace'},
      {name:'Track 400m Repeats',sets:[4,6],reps:['400m'],int:0.80,rest:180,tempo:'<80s men, <90s women'},
      {name:'Hill Sprints',sets:[6,8],reps:['30-50m'],int:0.92,rest:120,tempo:'Max effort uphill'},
      {name:'Row Intervals 500m',sets:[6,8],reps:['500m'],int:0.85,rest:120,tempo:'<1:50 men, <2:10 women'},
      {name:'Row Intervals 250m',sets:[10,12],reps:['250m'],int:0.90,rest:60,tempo:'Sprint pace'},
      {name:'Sled Push Sprints',sets:[6,8],reps:['20-40m'],int:0.90,rest:90,tempo:'Max drive'},
      {name:'Prowler Push',sets:[6,8],reps:['40m'],int:0.88,rest:120,tempo:'Steady powerful drive'},
      {name:'Battle Ropes',sets:[6,8],reps:[30],int:0.85,rest:60,tempo:'Max intensity waves'}
    ],
    endurance: [
      {name:'Zone 2 Bike',sets:[1],reps:['45-75min'],int:0.65,rest:0,tempo:'HR 130-150, conversational'},
      {name:'Zone 2 Run',sets:[1],reps:['30-60min'],int:0.65,rest:0,tempo:'Easy pace, nasal breathing'},
      {name:'Zone 2 Row',sets:[1],reps:['20-40min'],int:0.65,rest:0,tempo:'Steady sustainable pace'},
      {name:'Long Sled Push/Pull',sets:[3,4],reps:['100-200m'],int:0.60,rest:180,tempo:'Steady pace'},
      {name:'Farmer Carry Distance',sets:[3,4],reps:['100-200m'],int:0.70,rest:120,tempo:'Moderate load'},
      {name:'Shadowboxing Flow',sets:[5,6],reps:['3-5min'],int:0.50,rest:60,tempo:'Continuous movement'},
      {name:'Light Sparring',sets:[4,6],reps:['3-5min'],int:0.60,rest:90,tempo:'Technical flow'},
      {name:'Swimming',sets:[1],reps:['20-40min'],int:0.65,rest:0,tempo:'Easy continuous'}
    ],
    clinch: [
      {name:'Rope Climb',sets:[3,5],reps:[3,5],int:0.85,rest:120,tempo:'No legs if possible'},
      {name:'Towel Pull-Ups',sets:[3,4],reps:[6,10],int:0.80,rest:120,tempo:'Slow controlled'},
      {name:'Gi Pull-Ups',sets:[3,4],reps:[6,10],int:0.80,rest:120,tempo:'Grip endurance'},
      {name:'Fat Grip Pull-Ups',sets:[3,4],reps:[6,10],int:0.78,rest:120,tempo:'Thick bar'},
      {name:'Farmer Carry Heavy',sets:[3,4],reps:['40-60m'],int:0.90,rest:120,tempo:'Fast walk, tight core'},
      {name:'Suitcase Carry',sets:[3,4],reps:['40-60m'],int:0.85,rest:90,tempo:'Single-arm, anti-rotation'},
      {name:'Zercher Carry',sets:[3,4],reps:['30-50m'],int:0.85,rest:120,tempo:'Frame control'},
      {name:'Overhead Carry',sets:[3,4],reps:['30-50m'],int:0.75,rest:120,tempo:'Stability overhead'},
      {name:'Sandbag Carry',sets:[3,4],reps:['40-60m'],int:0.82,rest:120,tempo:'Bear hug position'},
      {name:'Plate Pinch Hold',sets:[3,4],reps:['30-60s'],int:0.80,rest:90,tempo:'Pinch grip'},
      {name:'Dead Hang',sets:[3,4],reps:['max'],int:0.75,rest:120,tempo:'Full hang to failure'},
      {name:'Bodylock Hold',sets:[3,4],reps:['30-45s'],int:0.80,rest:90,tempo:'Squeeze and hold'}
    ],
    strongman: [
      {name:'Tire Flip',sets:[4,6],reps:[5,8],int:0.90,rest:120,tempo:'Explosive hip drive, push overhead'},
      {name:'Sledgehammer Slam',sets:[4,6],reps:[10,15],int:0.85,rest:90,tempo:'Overhead slam, alternate sides'},
      {name:'Heavy Bag Punches',sets:[6,8],reps:['3min'],int:0.80,rest:60,tempo:'Max power combos'},
      {name:'Heavy Bag Kicks',sets:[4,6],reps:['3min'],int:0.82,rest:90,tempo:'Full power kicks, both sides'},
      {name:'Atlas Stone Lift',sets:[3,5],reps:[3,5],int:0.92,rest:180,tempo:'Bear hug, explosive lift to platform'},
      {name:'Sandbag Shouldering',sets:[4,6],reps:[6,10],int:0.85,rest:120,tempo:'Ground to shoulder, alternate sides'},
      {name:'Tire Drag',sets:[4,6],reps:['40-60m'],int:0.88,rest:120,tempo:'Low stance, powerful drive'},
      {name:'Keg Carry',sets:[3,4],reps:['30-50m'],int:0.87,rest:120,tempo:'Bear hug, steady pace'},
      {name:'Log Press',sets:[4,5],reps:[3,5],int:0.82,rest:180,tempo:'Clean to shoulders, press overhead'},
      {name:'Yoke Walk',sets:[3,5],reps:['30-50m'],int:0.95,rest:180,tempo:'Fast controlled walk, stay upright'}
    ]
  };
  
  const SESSION_MAP = {
    'Strength Upper':['strengthUpper','rotational','clinch'],
    'Strength Lower':['strengthLower','power'],
    'Strength Full Body':['strengthLower','strengthUpper','strongman'],
    'Striking':['rotational','power','conditioning','strongman'],
    'Track/Plyometrics':['plyometric','conditioning']
  };

  function calcZones(profile){
    const age=fmt(profile.age), rhr=fmt(profile.rhr)||null;
    const mhr = fmt(profile.mhr)|| (220 - age);
    const useKarv = !!rhr && mhr>rhr;
    function zone(pLo,pHi){
      if(useKarv){ const lo = Math.round(((mhr-rhr)*pLo + rhr)); const hi = Math.round(((mhr-rhr)*pHi + rhr)); return [lo,hi]; }
      else{ return [Math.round(mhr*pLo), Math.round(mhr*pHi)]; }
    }
    return { mhr, z1:zone(0.50,0.60), z2:zone(0.60,0.70), z3:zone(0.70,0.80), z4:zone(0.80,0.90), z5:zone(0.90,1.00), type: useKarv?'Karvonen (%HRR + RHR)':'%Max only' };
  }
  function renderZoneChips(){
    const p=LS.get('elite_profile',null);
    const wrap=document.getElementById('zoneChips');
    if(!p){ wrap.innerHTML=''; return; }
    const z=calcZones(p);
    wrap.innerHTML = `
      <span class="chip">MaxHR: ${z.mhr} (${z.type})</span>
      <span class="chip">Z1 ${z.z1[0]}‚Äì${z.z1[1]}</span>
      <span class="chip">Z2 ${z.z2[0]}‚Äì${z.z2[1]}</span>
      <span class="chip">Z3 ${z.z3[0]}‚Äì${z.z3[1]}</span>
      <span class="chip">Z4 ${z.z4[0]}‚Äì${z.z4[1]}</span>
      <span class="chip">Z5 ${z.z5[0]}‚Äì${z.z5[1]}</span>
    `;
  }

  const head=document.getElementById('calHead'); const body=document.getElementById('calBody');
  const monthTitle=document.getElementById('monthTitle');
  const DOW=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  let cur=new Date();
  let store=LS.get('elite_days',{});
  let hist=LS.get('elite_tss',[]);

  function renderCal(){
    head.innerHTML=''; body.innerHTML='';
    
    // Hide Fight Camp indicator when in calendar view
    const indicator = document.getElementById('fcIndicator');
    if(indicator) indicator.style.display = 'none';
    
    DOW.forEach(d=>{const el=document.createElement('div'); el.className='dow'; el.textContent=d; head.appendChild(el)});
    const y=cur.getFullYear(), m=cur.getMonth();
    monthTitle.textContent=cur.toLocaleDateString(undefined,{month:'long',year:'numeric'});
    const first=new Date(y,m,1).getDay();
    const days=new Date(y,m+1,0).getDate();
    const prevDays=new Date(y,m,0).getDate();
    const todayStr = toKey(new Date());
    for(let i=first-1;i>=0;i--){const d=prevDays-i; body.appendChild(dayCell(new Date(y,m-1,d),true,todayStr))}
    for(let d=1;d<=days;d++){body.appendChild(dayCell(new Date(y,m,d),false,todayStr))}
    const total=first+days; const rem=(total<=35?35-total:42-total);
    for(let d=1;d<=rem;d++){body.appendChild(dayCell(new Date(y,m+1,d),true,todayStr))}
  }
  function dayCell(date,other,todayStr){
    const el=document.createElement('div'); el.className='cell'+(other?' other':'');
    const key=toKey(date);
    if(key===todayStr) el.classList.add('today');
    const num=document.createElement('div'); num.className='num'; num.textContent=date.getDate(); el.appendChild(num);
    const day=store[key];
    if(day?.modalities){
      Object.keys(day.modalities).forEach(k=>{
        const b=document.createElement('span'); b.className='badge'; b.textContent=k.toUpperCase(); el.appendChild(b);
      });
      const c=document.createElement('div'); c.className='cns '+(day.totalCNS<60?'low':day.totalCNS<75?'mod':'high'); el.appendChild(c);
    }
    el.onclick=()=>openDay(date);
    return el;
  }
  function toKey(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`}
  document.getElementById('prevBtn').onclick=()=>{cur.setMonth(cur.getMonth()-1);renderCal()}
  document.getElementById('nextBtn').onclick=()=>{cur.setMonth(cur.getMonth()+1);renderCal()}
  document.getElementById('todayBtn').onclick=()=>{cur=new Date();renderCal()}

  const profileModal=document.getElementById('profileModal');
  const pfAge=document.getElementById('pfAge');
  const pfSex=document.getElementById('pfSex');
  const pfHt=document.getElementById('pfHt');
  const pfWt=document.getElementById('pfWt');
  const pfTA=document.getElementById('pfTA');
  const pfRHR=document.getElementById('pfRHR');
  const pfMHR=document.getElementById('pfMHR');
  const pfSport=document.getElementById('pfSport');
  const pfGoal=document.getElementById('pfGoal');
  const pfAvail=document.getElementById('pfAvail');
  
  // Auto-calculate Max HR when age changes (using Tanaka formula - most accurate)
  pfAge.addEventListener('input', function() {
    const age = parseFloat(pfAge.value);
    if(age && age >= 5 && age <= 100) {
      // Tanaka formula (2001): 208 - (0.7 √ó age) - most accurate for adults
      const maxHR = Math.round(208 - (0.7 * age));
      pfMHR.placeholder = `auto: ${maxHR} bpm (Tanaka formula)`;
      // Always update if empty (auto-calculation mode)
      if(!pfMHR.value) {
        pfMHR.value = maxHR;
      }
    } else {
      pfMHR.placeholder = 'auto from age';
      // Clear max HR if age is cleared and it was auto-calculated
      if(!pfAge.value && pfMHR.value) {
        const savedProfile = LS.get('elite_profile', {});
        // Only clear if it's not a saved manual override
        if(!savedProfile.mhr) {
          pfMHR.value = '';
        }
      }
    }
  });
  
  // Allow user to clear Max HR to return to auto-calculation
  pfMHR.addEventListener('input', function() {
    if(!pfMHR.value && pfAge.value) {
      // Re-trigger age calculation when Max HR is cleared
      pfAge.dispatchEvent(new Event('input'));
    }
  });
  
  document.getElementById('profileBtn').onclick=()=>{
    const p=LS.get('elite_profile',{});
    pfAge.value=p.age||''; pfSex.value=p.sex||''; pfHt.value=p.ht||''; pfWt.value=p.wt||'';
    pfTA.value=p.ta||''; pfRHR.value=p.rhr||''; pfMHR.value=p.mhr||''; pfSport.value=p.sport||''; pfGoal.value=p.goal||''; pfAvail.value=p.avail||'';
    
    // BASELINE TESTS: Load test values
    if(p.baselineTests) {
      const bt = p.baselineTests;
      
      // Test #1: 3-Min Bike
      if(document.getElementById('pfBike3Min')) document.getElementById('pfBike3Min').value = bt.bike3Min || '';
      if(document.getElementById('pfBikePeakHR')) document.getElementById('pfBikePeakHR').value = bt.bikePeakHR || '';
      if(document.getElementById('pfBikeHR60')) document.getElementById('pfBikeHR60').value = bt.bikeHR60 || '';
      
      // Test #2: Med Ball
      if(document.getElementById('pfMedBallWeight')) document.getElementById('pfMedBallWeight').value = bt.medBallWeight || '';
      if(document.getElementById('pfMedBallRight')) document.getElementById('pfMedBallRight').value = bt.medBallRight || '';
      if(document.getElementById('pfMedBallLeft')) document.getElementById('pfMedBallLeft').value = bt.medBallLeft || '';
      
      // Test #3: Broad Jump
      if(document.getElementById('pfBroadJump')) document.getElementById('pfBroadJump').value = bt.broadJump || '';
      if(document.getElementById('pfBroadJumpUnit')) document.getElementById('pfBroadJumpUnit').value = bt.broadJumpUnit || 'ft';
      
      // Test #4: Strength
      if(document.getElementById('pfStrengthType')) {
        document.getElementById('pfStrengthType').value = bt.strengthType || '';
        toggleStrengthFields(); // Show appropriate fields
      }
      
      if(bt.strengthType === 'pullup') {
        if(document.getElementById('pfPullupBW')) document.getElementById('pfPullupBW').value = bt.pullupBW || '';
        if(document.getElementById('pfPullupWeight')) document.getElementById('pfPullupWeight').value = bt.pullupWeight || '';
        if(document.getElementById('pfPullupReps')) document.getElementById('pfPullupReps').value = bt.pullupReps || '';
      }
      
      if(bt.strengthType === 'deadlift') {
        if(document.getElementById('pfDeadliftWeight')) document.getElementById('pfDeadliftWeight').value = bt.deadliftWeight || '';
        if(document.getElementById('pfDeadliftReps')) document.getElementById('pfDeadliftReps').value = bt.deadliftReps || '';
        if(document.getElementById('pfDeadliftBW')) document.getElementById('pfDeadliftBW').value = bt.deadliftBW || '';
      }
      
      // Update real-time metrics
      updateBaselineMetrics();
    }
    
    // Initialize event listeners for baseline tests
    initBaselineListeners();
    
    // Check sport and toggle appropriate sections
    toggleFightCampFields();
    
    // FIGHT CAMP: Load data if in fight camp mode
    if(p.sport === 'FIGHT CAMP' && p.fightCamp) {
      loadFightCampData(p);
    }
    
    // Trigger max HR calculation if age exists but max HR doesn't
    if(pfAge.value && !pfMHR.value) {
      pfAge.dispatchEvent(new Event('input'));
    }
    
    profileModal.classList.add('show');
  };
  
  // FIGHT CAMP: Toggle visibility of fight camp fields
  function toggleFightCampFields(forceShow = false) {
    const sport = document.getElementById('pfSport').value;
    const fcFields = document.getElementById('fightCampFields');
    const baselineTests = document.getElementById('baselineTestsSection');
    
    // Show Fight Camp fields only for Fight Camp mode
    if(sport === 'FIGHT CAMP' || forceShow) {
      fcFields.style.display = 'block';
      buildWeeklySchedule();
    } else {
      fcFields.style.display = 'none';
    }
    
    // Show Baseline Tests for combat-related sports
    const combatSports = ['MMA', 'MMA / Fighting', 'BJJ', 'BJJ / Grappling', 'FIGHT CAMP'];
    if(combatSports.includes(sport)) {
      baselineTests.style.display = 'block';
    } else {
      baselineTests.style.display = 'none';
    }
  }
  
  // FIGHT CAMP: Build weekly schedule UI
  function buildWeeklySchedule() {
    const container = document.getElementById('weeklySchedule');
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const sessionTypes = [
      'Off',
      'Strength Upper',
      'Strength Lower', 
      'Strength Full Body',
      'Striking',
      'BJJ/Grappling',
      'MMA Sparring',
      'Conditioning (Bike)',
      'Track/Plyometrics',
      'Active Recovery',
      'Mobility/Yoga'
    ];
    
    let html = '<div style="display:grid;gap:10px">';
    
    days.forEach((day, idx) => {
      html += `
        <div style="background:#0d1714;padding:10px;border:1px solid #1e6a4f;border-radius:4px">
          <div style="font-weight:700;color:#9de8c5;margin-bottom:8px">${day}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div>
              <label style="font-size:11px;color:#ccc">AM Session</label>
              <select id="fcDay${idx}AM" class="fcSchedule" style="width:100%;font-size:12px">
                ${sessionTypes.map(t => `<option value="${t}">${t}</option>`).join('')}
              </select>
            </div>
            <div>
              <label style="font-size:11px;color:#ccc">PM Session</label>
              <select id="fcDay${idx}PM" class="fcSchedule" style="width:100%;font-size:12px">
                ${sessionTypes.map(t => `<option value="${t}">${t}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
  }
  
  // FIGHT CAMP: Load saved fight camp data
  function loadFightCampData(p) {
    if(!p.fightCamp) return;
    
    const fc = p.fightCamp;
    document.getElementById('fcLength').value = fc.length || '';
    document.getElementById('fcCurrentWeek').value = fc.currentWeek || 1;
    document.getElementById('fcCurrentWeight').value = fc.currentWeight || '';
    document.getElementById('fcTargetWeight').value = fc.targetWeight || '';
    document.getElementById('fcPriority').value = fc.priority || '';
    document.getElementById('fcFitness').value = fc.fitness || '';
    
    // Load schedule
    if(fc.schedule) {
      fc.schedule.forEach((day, idx) => {
        const amEl = document.getElementById(`fcDay${idx}AM`);
        const pmEl = document.getElementById(`fcDay${idx}PM`);
        if(amEl) amEl.value = day.am || 'Off';
        if(pmEl) pmEl.value = day.pm || 'Off';
      });
    }
  }
  function closeProfile(){profileModal.classList.remove('show')}
  function saveProfile(){
    const p={
      age:fmt(pfAge.value),
      sex:pfSex.value,
      ht:fmt(pfHt.value),
      wt:fmt(pfWt.value),
      ta:fmt(pfTA.value),
      rhr:fmt(pfRHR.value),
      mhr:fmt(pfMHR.value),
      sport:pfSport.value,
      goal:pfGoal.value,
      avail:fmt(pfAvail.value)
    };
    
    // BASELINE TESTS: Save all test data
    p.baselineTests = {
      // Test #1: 3-Min Bike
      bike3Min: fmt(document.getElementById('pfBike3Min')?.value),
      bikePeakHR: fmt(document.getElementById('pfBikePeakHR')?.value),
      bikeHR60: fmt(document.getElementById('pfBikeHR60')?.value),
      
      // Test #2: Med Ball
      medBallWeight: fmt(document.getElementById('pfMedBallWeight')?.value),
      medBallRight: fmt(document.getElementById('pfMedBallRight')?.value),
      medBallLeft: fmt(document.getElementById('pfMedBallLeft')?.value),
      
      // Test #3: Broad Jump
      broadJump: fmt(document.getElementById('pfBroadJump')?.value),
      broadJumpUnit: document.getElementById('pfBroadJumpUnit')?.value || 'ft',
      
      // Test #4: Strength
      strengthType: document.getElementById('pfStrengthType')?.value,
      pullupBW: fmt(document.getElementById('pfPullupBW')?.value),
      pullupWeight: fmt(document.getElementById('pfPullupWeight')?.value),
      pullupReps: fmt(document.getElementById('pfPullupReps')?.value),
      deadliftWeight: fmt(document.getElementById('pfDeadliftWeight')?.value),
      deadliftReps: fmt(document.getElementById('pfDeadliftReps')?.value),
      deadliftBW: fmt(document.getElementById('pfDeadliftBW')?.value)
    };
    
    // FIGHT CAMP: Save fight camp data
    if(p.sport === 'FIGHT CAMP') {
      const schedule = [];
      for(let i = 0; i < 7; i++) {
        schedule.push({
          am: document.getElementById(`fcDay${i}AM`)?.value || 'Off',
          pm: document.getElementById(`fcDay${i}PM`)?.value || 'Off'
        });
      }
      
      p.fightCamp = {
        length: fmt(document.getElementById('fcLength')?.value),
        currentWeek: fmt(document.getElementById('fcCurrentWeek')?.value) || 1,
        currentWeight: fmt(document.getElementById('fcCurrentWeight')?.value),
        targetWeight: fmt(document.getElementById('fcTargetWeight')?.value),
        priority: document.getElementById('fcPriority')?.value,
        fitness: fmt(document.getElementById('fcFitness')?.value),
        schedule,
        startDate: Date.now() // Track when camp started
      };
    }
    
    LS.set('elite_profile',p); 
    renderZoneChips(); 
    profileModal.classList.remove('show');
    
    // FIGHT CAMP: Render daily dashboard if in fight camp mode
    if(p.sport === 'FIGHT CAMP') {
      renderFightCampDashboard();
    } else {
      renderCal(); // Regular calendar view
    }
  }

  let curKey=null;
  const dayModal=document.getElementById('dayModal');
  function openDay(date){
    curKey=toKey(date);
    document.getElementById('dayTitle').textContent=date.toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    ['mChest','mBack','mLegs','mTrack','mStrongman','mBike','mBJJ','mWalk'].forEach(id=>document.getElementById(id).checked=false);
    ['secChest','secBack','secLegs','secTrack','secStrongman','secBike','secBJJ','secWalk'].forEach(id=>document.getElementById(id).style.display='none');
    const saved=store[curKey];
    if(saved){
      Object.keys(saved.modalities||{}).forEach(k=>{
        const map={chest:'mChest',back:'mBack',legs:'mLegs',track:'mTrack',bike:'mBike',bjj:'mBJJ',walking:'mWalk'};
        const id=map[k]; if(id){document.getElementById(id).checked=true; toggleSection('sec'+k.charAt(0).toUpperCase()+k.slice(1))}
      });
      hydrateStrength('chestBox',saved.modalities?.chest);
      hydrateStrength('backBox',saved.modalities?.back);
      hydrateStrength('legsBox',saved.modalities?.legs);
      hydrateTrack(saved.modalities?.track);
      hydrateBike(saved.modalities?.bike);
      hydrateBJJ(saved.modalities?.bjj);
      hydrateWalk(saved.modalities?.walking);
      setKPIs(saved);
    }else{
      initStrength('chestBox'); initStrength('backBox'); initStrength('legsBox');
      resetTrack(); resetBike(); resetBJJ(); resetWalk();
      setKPIs({totalCNS:0,tss:0,totalVolume:0});
    }
    dayModal.classList.add('show');
  }
  function setKPIs(d){
    document.getElementById('kpiCNS').textContent=Math.round(d.totalCNS||0);
    document.getElementById('kpiTSS').textContent=Math.round(d.tss||0);
    document.getElementById('kpiVOL').textContent=Math.round(d.totalVolume||0);
    
    // GOD-MODE: Display normalized CNS if available
    if(d.normalizedCNS && d.cnsZScore && d.cnsBaseline) {
      const cnsEl = document.getElementById('kpiCNS');
      cnsEl.innerHTML = `${Math.round(d.totalCNS||0)}<br><span style="font-size:11px;color:#9de8c5">z=${d.cnsZScore} (base:${d.cnsBaseline})</span>`;
    }
    
    // GOD-MODE: Display BJJ rehydration and GlycoIndex info
    const bjjInfoBox = document.getElementById('bjjInfoBox');
    if(d.modalities?.bjj && (d.modalities.bjj.rehydration > 0 || d.modalities.bjj.glycoIndex > 0)) {
      let html = '<div style="font-weight:700;color:#00ffb3;margin-bottom:8px">ü•ã BJJ Recovery Prescription:</div>';
      
      if(d.modalities.bjj.rehydration > 0) {
        html += `
          <div style="margin-bottom:8px">
            <b>Rehydration Target:</b> ${d.modalities.bjj.rehydration}L over 2-4 hours
            <br><span style="font-size:12px;color:#ccc">Add ${d.modalities.bjj.sodiumNeeds}mg sodium (electrolytes)</span>
          </div>
        `;
      }
      
      if(d.modalities.bjj.glycoIndex > 0) {
        const glycoLevel = d.modalities.bjj.glycoIndex > 30 ? 'HIGH' : d.modalities.bjj.glycoIndex > 20 ? 'MODERATE' : 'LOW';
        const glycoColor = d.modalities.bjj.glycoIndex > 30 ? '#ff6b6b' : d.modalities.bjj.glycoIndex > 20 ? '#ffbb33' : '#00ffb3';
        html += `
          <div>
            <b>GlycoIndex:</b> <span style="color:${glycoColor};font-weight:700">${d.modalities.bjj.glycoIndex} (${glycoLevel})</span>
            <br><span style="font-size:12px;color:#ccc">${d.modalities.bjj.glycoIndex > 30 ? 'High glycolytic stress - prioritize carb repletion 1-1.2g/kg within 2h' : d.modalities.bjj.glycoIndex > 20 ? 'Moderate glycolytic stress - standard post-training nutrition' : 'Low glycolytic stress - normal recovery'}</span>
          </div>
        `;
      }
      
      bjjInfoBox.innerHTML = html;
      bjjInfoBox.style.display = 'block';
    } else {
      bjjInfoBox.style.display = 'none';
    }
  }
  function closeDay(){dayModal.classList.remove('show')}
  function toggleSection(id){const el=document.getElementById(id); el.style.display=(el.style.display==='none'?'block':'none')}

  // ============================================
  // EXERCISE-SPECIFIC FIELD UPDATES
  // ============================================
  
  function updateChestFields() {
    const exercise = document.getElementById('chestExercise').value;
    const box = document.getElementById('chestBox');
    
    if(!exercise) {
      box.innerHTML = '';
      return;
    }
    
    // Standard strength exercises
    if(['Bench Press', 'Close-Grip Bench', 'Incline Bench Press', 'Floor Press', 'Overhead Press', 'Push Press', 'Weighted Dips'].includes(exercise)) {
      initStrength('chestBox');
      box.insertAdjacentHTML('afterbegin', `<div class="note" style="margin-bottom:8px"><b>${exercise}</b> - Standard sets √ó reps format</div>`);
    }
    // Bodyweight push-ups
    else if(['Push-Ups', 'Diamond Push-Ups', 'Wide-Grip Push-Ups', 'Decline Push-Ups'].includes(exercise)) {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Bodyweight conditioning</div>
        <div class="grid2">
          <div><label>Sets</label><input id="chestSets" type="number" placeholder="4"></div>
          <div><label>Target Reps per Set</label><input id="chestReps" type="number" placeholder="20"></div>
          <div><label>Actual Reps per Set</label><input id="chestActualReps" type="text" placeholder="20,18,17,15"></div>
          <div><label>RPE (1-10)</label><input id="chestRPE" type="number" min="1" max="10" placeholder="7"></div>
          <div><label>Tempo</label><select id="chestTempo"><option>Controlled 2-0-1</option><option>Explosive up</option><option>Pause at bottom</option></select></div>
          <div><label>Form Quality</label><select id="chestForm"><option>Perfect ROM</option><option>Good</option><option>Breakdown</option></select></div>
        </div>
      `;
    }
    // Speed work
    else if(exercise === 'Speed Bench') {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Dynamic Effort (6-8 sets)</div>
        <div class="grid2">
          <div><label>Weight (% 1RM)</label><input id="chestWeight" type="number" placeholder="60"></div>
          <div><label>Sets (6-8)</label><input id="chestSets" type="number" placeholder="8"></div>
          <div><label>Reps per Set (3)</label><input id="chestReps" type="number" value="3" readonly></div>
          <div><label>Bar Speed</label><select id="chestSpeed"><option>Explosive</option><option>Fast</option><option>Moderate</option></select></div>
        </div>
      `;
    }
    // Power exercises
    else if(exercise === 'Med Ball Chest Pass') {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Explosive power exercise</div>
        <div class="grid2">
          <div><label>Ball Weight (lb)</label><input id="chestBallWeight" type="number" placeholder="10"></div>
          <div><label>Total Throws</label><input id="chestThrows" type="number" placeholder="20"></div>
          <div><label>Distance (ft) - Best</label><input id="chestDistance" type="number" step="0.1" placeholder="12.5"></div>
          <div><label>RPE (1-10)</label><input id="chestRPE" type="number" min="1" max="10" placeholder="8"></div>
        </div>
      `;
    }
    else if(exercise === 'Plyo Push-Up') {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Explosive bodyweight</div>
        <div class="grid2">
          <div><label>Sets</label><input id="chestSets" type="number" placeholder="3"></div>
          <div><label>Reps per Set</label><input id="chestReps" type="number" placeholder="8"></div>
          <div><label>Height off ground</label><select id="chestHeight"><option>Hands leave ground</option><option>Clap capable</option><option>Full clap achieved</option></select></div>
          <div><label>RPE (1-10)</label><input id="chestRPE" type="number" min="1" max="10" placeholder="7"></div>
        </div>
      `;
    }
  }
  
  function updateBackFields() {
    const exercise = document.getElementById('backExercise').value;
    const box = document.getElementById('backBox');
    
    if(!exercise) {
      box.innerHTML = '';
      return;
    }
    
    // Standard strength exercises
    if(['Weighted Pull-Ups', 'Chin-Ups', 'Towel Pull-Ups', 'Gi Pull-Ups', 'Fat Grip Pull-Ups', 'Hang High Pull', 'Barbell Row', 'Pendlay Row', 'Chest-Supported Row', 'Seated Cable Row', 'Lat Pulldown'].includes(exercise)) {
      initStrength('backBox');
      box.insertAdjacentHTML('afterbegin', `<div class="note" style="margin-bottom:8px"><b>${exercise}</b> - Standard sets √ó reps format</div>`);
    }
    // Face Pulls (accessory)
    else if(exercise === 'Face Pulls') {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Rear delt/upper back health</div>
        <div class="grid2">
          <div><label>Weight (lb)</label><input id="backWeight" type="number" placeholder="60"></div>
          <div><label>Sets (3-4)</label><input id="backSets" type="number" placeholder="3"></div>
          <div><label>Reps per Set (12-15)</label><input id="backReps" type="number" placeholder="15"></div>
          <div><label>RPE (1-10)</label><input id="backRPE" type="number" min="1" max="10" placeholder="6"></div>
        </div>
      `;
    }
    // Rope Climb
    else if(exercise === 'Rope Climb') {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Grip & conditioning</div>
        <div class="grid2">
          <div><label>Number of Climbs</label><input id="backClimbs" type="number" placeholder="5"></div>
          <div><label>Height (ft)</label><input id="backHeight" type="number" placeholder="15"></div>
          <div><label>Legs Used?</label><select id="backLegs"><option value="no">No (legless)</option><option value="yes">Yes (with legs)</option></select></div>
          <div><label>RPE (1-10)</label><input id="backRPE" type="number" min="1" max="10" placeholder="8"></div>
        </div>
      `;
    }
  }
  
  function updateLegsFields() {
    const exercise = document.getElementById('legsExercise').value;
    const box = document.getElementById('legsBox');
    
    if(!exercise) {
      box.innerHTML = '';
      return;
    }
    
    // Standard barbell exercises
    if(['Trap Bar Deadlift', 'Back Squat', 'Front Squat', 'Zercher Squat', 'Bulgarian Split Squat', 'Reverse Lunge', 'Romanian Deadlift', 'Sumo Deadlift', 'Box Squat', 'Safety Bar Squat', 'Walking Lunge', 'Step-Up (High Box)', 'Single-Leg RDL', 'Goblet Squat', 'Power Clean', 'Hang Power Clean', 'Clean Pull'].includes(exercise)) {
      initStrength('legsBox');
      box.insertAdjacentHTML('afterbegin', `<div class="note" style="margin-bottom:8px"><b>${exercise}</b> - Standard sets √ó reps format</div>`);
    }
    // Speed work
    else if(['Speed Deadlift', 'Speed Squat'].includes(exercise)) {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Dynamic Effort (6-8 sets)</div>
        <div class="grid2">
          <div><label>Weight (% 1RM)</label><input id="legsWeight" type="number" placeholder="60"></div>
          <div><label>Sets (6-8)</label><input id="legsSets" type="number" placeholder="6"></div>
          <div><label>Reps per Set (2-3)</label><input id="legsReps" type="number" placeholder="2"></div>
          <div><label>Bar Speed</label><select id="legsSpeed"><option>Explosive</option><option>Fast</option><option>Moderate</option></select></div>
        </div>
      `;
    }
    // KB exercises
    else if(['Kettlebell Swing', 'Kettlebell Snatch', 'Double KB Clean'].includes(exercise)) {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Ballistic/power</div>
        <div class="grid2">
          <div><label>KB Weight (lb)</label><input id="legsKBWeight" type="number" placeholder="53"></div>
          <div><label>Sets</label><input id="legsSets" type="number" placeholder="4"></div>
          <div><label>Reps per Set</label><input id="legsReps" type="number" placeholder="15"></div>
          <div><label>RPE (1-10)</label><input id="legsRPE" type="number" min="1" max="10" placeholder="7"></div>
        </div>
      `;
    }
  }
  
  function updateTrackFields() {
    const exercise = document.getElementById('trackExercise').value;
    const box = document.getElementById('trackFieldsCustom');
    
    if(!exercise) {
      box.style.display = 'none';
      return;
    }
    
    box.style.display = 'block';
    
    // Horizontal jumps
    if(['Broad Jump', 'Bounding', 'Lateral Bounds'].includes(exercise)) {
      box.innerHTML = `
        <div class="sec" style="background:#0d1714;border:2px solid #00ffb3">
          <div class="hd" style="background:#00ffb3;color:#0a0f0d">${exercise} - Horizontal Power</div>
          <div class="bd">
            <div class="grid2">
              <div><label>${exercise === 'Bounding' ? 'Sets' : 'Total Jumps'}</label><input id="trackJumps" type="number" placeholder="${exercise === 'Bounding' ? '4' : '15'}"></div>
              <div><label>${exercise === 'Bounding' ? 'Distance per Set (yd)' : 'Best Distance (ft)'}</label><input id="trackDistance" type="number" step="0.1" placeholder="${exercise === 'Bounding' ? '30' : '8.5'}"></div>
              <div><label>Landing Quality</label><select id="trackLanding"><option>Soft & controlled</option><option>Some stumble</option><option>Hard/unstable</option></select></div>
              <div><label>RPE (1-10)</label><input id="trackRPE" type="number" min="1" max="10" placeholder="7"></div>
            </div>
          </div>
        </div>
      `;
    }
    // Vertical jumps
    else if(['Box Jump', 'Hurdle Hops', 'Tuck Jumps', 'Split Jump', 'Box Jump to Sprint'].includes(exercise)) {
      box.innerHTML = `
        <div class="sec" style="background:#0d1714;border:2px solid #00ffb3">
          <div class="hd" style="background:#00ffb3;color:#0a0f0d">${exercise} - Vertical Power</div>
          <div class="bd">
            <div class="grid2">
              <div><label>Total Jumps</label><input id="trackJumps" type="number" placeholder="15"></div>
              <div><label>${exercise === 'Box Jump' || exercise === 'Box Jump to Sprint' ? 'Box Height (in)' : exercise === 'Hurdle Hops' ? 'Hurdle Height (in)' : 'Flight Quality'}</label>${exercise === 'Box Jump' || exercise === 'Box Jump to Sprint' || exercise === 'Hurdle Hops' ? `<input id="trackHeight" type="number" placeholder="30">` : `<select id="trackQuality"><option>Explosive & high</option><option>Moderate</option><option>Low/sluggish</option></select>`}</div>
              <div><label>Landing Quality</label><select id="trackLanding"><option>Soft & controlled</option><option>Some stumble</option><option>Hard/unstable</option></select></div>
              <div><label>RPE (1-10)</label><input id="trackRPE" type="number" min="1" max="10" placeholder="7"></div>
            </div>
          </div>
        </div>
      `;
    }
    // Reactive/Advanced
    else if(['Depth Jump', 'Drop Landing'].includes(exercise)) {
      box.innerHTML = `
        <div class="sec" style="background:#0d1714;border:2px solid #ff6b6b">
          <div class="hd" style="background:#ff6b6b;color:#fff">‚ö†Ô∏è ${exercise} - ADVANCED (High CNS)</div>
          <div class="bd">
            <div class="note" style="color:#ff6b6b;font-weight:700;margin-bottom:12px">‚ö†Ô∏è ${exercise === 'Depth Jump' ? 'LP3 ONLY - Max reactive strength. Use only when peaked.' : 'Eccentric absorption drill - Focus on landing mechanics.'}</div>
            <div class="grid2">
              <div><label>Drop Height (in)</label><input id="trackHeight" type="number" placeholder="${exercise === 'Depth Jump' ? '18' : '12'}"></div>
              <div><label>Total Reps</label><input id="trackReps" type="number" placeholder="${exercise === 'Depth Jump' ? '12' : '10'}"></div>
              <div><label>Contact Time</label><select id="trackContact"><option>Instant (<0.2s)</option><option>Quick (0.2-0.3s)</option><option>Slow (>0.3s)</option></select></div>
              <div><label>RPE (1-10)</label><input id="trackRPE" type="number" min="1" max="10" placeholder="9"></div>
            </div>
          </div>
        </div>
      `;
    }
    // Lateral
    else if(exercise === 'Lateral Skater Hops') {
      box.innerHTML = `
        <div class="sec" style="background:#0d1714;border:2px solid #00ffb3">
          <div class="hd" style="background:#00ffb3;color:#0a0f0d">${exercise} - Lateral Power</div>
          <div class="bd">
            <div class="grid2">
              <div><label>Sets</label><input id="trackSets" type="number" placeholder="4"></div>
              <div><label>Reps per Set</label><input id="trackReps" type="number" placeholder="8"></div>
              <div><label>Quality</label><select id="trackQuality"><option>Explosive & quick</option><option>Moderate</option><option>Slow/sluggish</option></select></div>
              <div><label>RPE (1-10)</label><input id="trackRPE" type="number" min="1" max="10" placeholder="7"></div>
            </div>
          </div>
        </div>
      `;
    }
    // Elastic/Spring
    else if(['Pogo Hops', 'Single-Leg Hop'].includes(exercise)) {
      box.innerHTML = `
        <div class="sec" style="background:#0d1714;border:2px solid #00ffb3">
          <div class="hd" style="background:#00ffb3;color:#0a0f0d">${exercise} - Elastic/Reactive</div>
          <div class="bd">
            <div class="grid2">
              <div><label>Sets</label><input id="trackSets" type="number" placeholder="4"></div>
              <div><label>Reps per Set</label><input id="trackReps" type="number" placeholder="${exercise === 'Pogo Hops' ? '15' : '8'}"></div>
              <div><label>Ground Contact</label><select id="trackContact"><option>Instant/Springy</option><option>Quick</option><option>Slow</option></select></div>
              <div><label>RPE (1-10)</label><input id="trackRPE" type="number" min="1" max="10" placeholder="7"></div>
            </div>
          </div>
        </div>
      `;
    }
    // Rotational Power (Med Ball throws)
    else if(['Med Ball Rotational Throw', 'Med Ball Shotput', 'Med Ball Overhead Slam', 'Med Ball Scoop Toss'].includes(exercise)) {
      const needsSides = exercise === 'Med Ball Rotational Throw' || exercise === 'Med Ball Shotput';
      box.innerHTML = `
        <div class="sec" style="background:#0d1714;border:2px solid #00ffb3">
          <div class="hd" style="background:#00ffb3;color:#0a0f0d">${exercise} - Rotational Power</div>
          <div class="bd">
            <div class="grid2">
              <div><label>Ball Weight (lb)</label><input id="trackBallWeight" type="number" placeholder="10"></div>
              <div><label>${needsSides ? 'Throws per Side' : 'Total Throws'}</label><input id="trackThrows" type="number" placeholder="${needsSides ? '8' : '15'}"></div>
              ${needsSides ? `
                <div><label>Right Side Distance (ft)</label><input id="trackDistanceR" type="number" step="0.1" placeholder="10.5"></div>
                <div><label>Left Side Distance (ft)</label><input id="trackDistanceL" type="number" step="0.1" placeholder="9.8"></div>
                <div><label>RPE (1-10)</label><input id="trackRPE" type="number" min="1" max="10" placeholder="7"></div>
                <div style="color:#9de8c5;font-size:12px;padding-top:10px" id="trackImbalance"></div>
              ` : `
                <div><label>Best Distance (ft)</label><input id="trackDistance" type="number" step="0.1" placeholder="12"></div>
                <div><label>RPE (1-10)</label><input id="trackRPE" type="number" min="1" max="10" placeholder="7"></div>
              `}
            </div>
          </div>
        </div>
      `;
      
      // Add real-time imbalance calculation for bilateral throws
      if(needsSides) {
        setTimeout(() => {
          ['trackDistanceR', 'trackDistanceL'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
              el.addEventListener('input', () => {
                const r = parseFloat(document.getElementById('trackDistanceR').value) || 0;
                const l = parseFloat(document.getElementById('trackDistanceL').value) || 0;
                if(r > 0 && l > 0) {
                  const diff = Math.abs(r - l);
                  const avg = (r + l) / 2;
                  const percent = (diff / avg) * 100;
                  const msg = document.getElementById('trackImbalance');
                  if(percent < 10) {
                    msg.textContent = `Imbalance: ${percent.toFixed(1)}% (Balanced - good)`;
                    msg.style.color = '#00ffb3';
                  } else if(percent < 20) {
                    msg.textContent = `Imbalance: ${percent.toFixed(1)}% (Acceptable)`;
                    msg.style.color = '#9de8c5';
                  } else {
                    msg.textContent = `Imbalance: ${percent.toFixed(1)}% (Injury risk - needs work)`;
                    msg.style.color = '#ff6b6b';
                  }
                }
              });
            }
          });
        }, 100);
      }
    }
    // Rotational Strength (Landmine, Cable, etc.)
    else if(['Landmine Rotational Press', 'Landmine Rainbow', 'Cable Woodchopper High-Low', 'Cable Woodchopper Low-High', 'Pallof Press', 'Turkish Get-Up'].includes(exercise)) {
      box.innerHTML = `
        <div class="sec" style="background:#0d1714;border:2px solid #00ffb3">
          <div class="hd" style="background:#00ffb3;color:#0a0f0d">${exercise} - Rotational Strength</div>
          <div class="bd">
            <div class="note" style="margin-bottom:8px"><b>${exercise}</b> - Use standard strength logging below</div>
            <div style="padding:12px;background:#0a0f0d;border:1px solid #1e6a4f;margin-top:8px">
              <div style="color:#9de8c5;margin-bottom:8px">Log this exercise in the <b>CHEST</b> or <b>BACK</b> section using standard sets √ó reps format.</div>
              <div style="font-size:13px;color:#ccc">Tip: For ${exercise}, log weight, sets, reps, and RPE just like any other strength exercise.</div>
            </div>
          </div>
        </div>
      `;
    }
  }

  function updateStrongmanFields() {
    const exercise = document.getElementById('strongmanExercise').value;
    const box = document.getElementById('strongmanBox');
    
    if(!exercise) {
      box.innerHTML = '';
      return;
    }
    
    // Implement work (reps/sets based)
    if(['Tire Flip', 'Atlas Stone Lift', 'Log Press', 'Sandbag Shouldering'].includes(exercise)) {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Max effort implement work</div>
        <div class="grid2">
          <div><label>${exercise === 'Tire Flip' ? 'Tire Weight (estimate lb)' : exercise === 'Atlas Stone Lift' ? 'Stone Weight (lb)' : exercise === 'Log Press' ? 'Log Weight (lb)' : 'Sandbag Weight (lb)'}</label><input id="strongmanWeight" type="number" placeholder="${exercise === 'Tire Flip' ? '400' : exercise === 'Atlas Stone Lift' ? '200' : '120'}"></div>
          <div><label>Sets</label><input id="strongmanSets" type="number" placeholder="${exercise === 'Tire Flip' ? '6' : '4'}"></div>
          <div><label>Reps per Set</label><input id="strongmanReps" type="number" placeholder="${exercise === 'Tire Flip' ? '6' : exercise === 'Sandbag Shouldering' ? '8' : '3'}"></div>
          <div><label>RPE (1-10)</label><input id="strongmanRPE" type="number" min="1" max="10" placeholder="9"></div>
        </div>
        <div style="margin-top:12px;padding:10px;background:#0d1714;border:1px solid #00ffb3;color:#9de8c5;font-size:13px">
          üí° <b>Tip:</b> ${exercise === 'Tire Flip' ? 'Drive through legs, push overhead at top' : exercise === 'Atlas Stone Lift' ? 'Bear hug low, explosive hip drive to platform' : exercise === 'Log Press' ? 'Clean to shoulders, powerful press overhead' : 'Ground to shoulder, alternate sides each rep'}
        </div>
      `;
    }
    // Sledgehammer work
    else if(exercise === 'Sledgehammer Slam') {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Rotational power endurance</div>
        <div class="grid2">
          <div><label>Hammer Weight (lb)</label><input id="strongmanWeight" type="number" placeholder="16"></div>
          <div><label>Sets</label><input id="strongmanSets" type="number" placeholder="5"></div>
          <div><label>Slams per Set</label><input id="strongmanReps" type="number" placeholder="15"></div>
          <div><label>RPE (1-10)</label><input id="strongmanRPE" type="number" min="1" max="10" placeholder="8"></div>
          <div style="grid-column:span 2"><label>Technique</label><select id="strongmanTechnique"><option>Alternating sides</option><option>Right side only</option><option>Left side only</option></select></div>
        </div>
        <div style="margin-top:12px;padding:10px;background:#0d1714;border:1px solid #00ffb3;color:#9de8c5;font-size:13px">
          üí° <b>Tip:</b> Overhead slam with full hip rotation, let hammer bounce, alternate sides for balance
        </div>
      `;
    }
    // Loaded carries
    else if(['Keg Carry', 'Tire Drag', 'Yoke Walk'].includes(exercise)) {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Heavy loaded carry</div>
        <div class="grid2">
          <div><label>${exercise === 'Yoke Walk' ? 'Total Weight on Yoke (lb)' : exercise === 'Keg Carry' ? 'Keg Weight (lb)' : 'Tire Weight (lb)'}</label><input id="strongmanWeight" type="number" placeholder="${exercise === 'Yoke Walk' ? '400' : exercise === 'Keg Carry' ? '150' : '200'}"></div>
          <div><label>Sets/Runs</label><input id="strongmanSets" type="number" placeholder="4"></div>
          <div><label>Distance per Set (m)</label><input id="strongmanDistance" type="number" placeholder="40"></div>
          <div><label>Time per Set (s)</label><input id="strongmanTime" type="number" placeholder="20"></div>
          <div style="grid-column:span 2"><label>RPE (1-10)</label><input id="strongmanRPE" type="number" min="1" max="10" placeholder="9"></div>
        </div>
        <div style="margin-top:12px;padding:10px;background:#0d1714;border:1px solid #00ffb3;color:#9de8c5;font-size:13px">
          üí° <b>Tip:</b> ${exercise === 'Yoke Walk' ? 'Stay upright, fast controlled walk, core tight' : exercise === 'Keg Carry' ? 'Bear hug carry, steady controlled pace' : 'Low stance, powerful drive, maintain speed'}
        </div>
      `;
    }
    // Heavy bag work
    else if(['Heavy Bag Punches', 'Heavy Bag Kicks'].includes(exercise)) {
      box.innerHTML = `
        <div class="note" style="margin-bottom:12px"><b>${exercise}</b> - Max power striking</div>
        <div class="grid2">
          <div><label>Rounds</label><input id="strongmanSets" type="number" placeholder="6"></div>
          <div><label>Duration per Round</label><input id="strongmanDuration" type="text" placeholder="3min" value="3min"></div>
          <div><label>Rest Between</label><input id="strongmanRest" type="number" placeholder="60"></div>
          <div><label>RPE (1-10)</label><input id="strongmanRPE" type="number" min="1" max="10" placeholder="8"></div>
          <div style="grid-column:span 2"><label>Focus</label><select id="strongmanFocus"><option>Max power combos</option><option>Speed and volume</option><option>Technique drilling</option></select></div>
        </div>
        <div style="margin-top:12px;padding:10px;background:#0d1714;border:1px solid #00ffb3;color:#9de8c5;font-size:13px">
          üí° <b>Tip:</b> ${exercise === 'Heavy Bag Punches' ? 'Focus on power in every combo - 1-2, hooks, uppercuts' : 'Full power kicks both sides - low, mid, high'}
        </div>
      `;
    }
  }


  // ============================================
  // FIGHT CAMP MODE FUNCTIONS
  // ============================================
  
  function closePrescription(){document.getElementById('prescriptionModal').classList.remove('show')}
  
  // BASELINE TESTS: Toggle strength test fields
  function toggleStrengthFields() {
    const type = document.getElementById('pfStrengthType').value;
    document.getElementById('pullupFields').style.display = type === 'pullup' ? 'block' : 'none';
    document.getElementById('deadliftFields').style.display = type === 'deadlift' ? 'block' : 'none';
  }
  
  // BASELINE TESTS: Real-time feedback calculations
  function updateBaselineMetrics() {
    // HRR-60 calculation
    const peakHR = fmt(document.getElementById('pfBikePeakHR')?.value);
    const hr60 = fmt(document.getElementById('pfBikeHR60')?.value);
    const hrrDisplay = document.getElementById('hrrDisplay');
    
    if(peakHR > 0 && hr60 > 0) {
      const hrr = peakHR - hr60;
      let rating = '';
      let color = '#9de8c5';
      
      if(hrr >= 30) {
        rating = `HRR-60: ${hrr} bpm (Elite recovery)`;
        color = '#00ffb3';
      } else if(hrr >= 20) {
        rating = `HRR-60: ${hrr} bpm (Good recovery)`;
        color = '#9de8c5';
      } else if(hrr >= 10) {
        rating = `HRR-60: ${hrr} bpm (Poor recovery)`;
        color = '#ffbb33';
      } else {
        rating = `HRR-60: ${hrr} bpm (CRITICAL - overtraining risk)`;
        color = '#ff6b6b';
      }
      
      hrrDisplay.textContent = rating;
      hrrDisplay.style.color = color;
    } else {
      hrrDisplay.textContent = '';
    }
    
    // Med Ball imbalance
    const right = fmt(document.getElementById('pfMedBallRight')?.value);
    const left = fmt(document.getElementById('pfMedBallLeft')?.value);
    const imbalanceDisplay = document.getElementById('medBallImbalance');
    
    if(right > 0 && left > 0) {
      const diff = Math.abs(right - left);
      const avg = (right + left) / 2;
      const percent = (diff / avg) * 100;
      
      let msg = `Imbalance: ${percent.toFixed(1)}%`;
      let color = '#9de8c5';
      
      if(percent < 10) {
        msg += ' (Balanced - good)';
        color = '#00ffb3';
      } else if(percent < 20) {
        msg += ' (Acceptable)';
        color = '#9de8c5';
      } else {
        msg += ' (Injury risk - needs corrective work)';
        color = '#ff6b6b';
      }
      
      imbalanceDisplay.textContent = msg;
      imbalanceDisplay.style.color = color;
    } else {
      imbalanceDisplay.textContent = '';
    }
    
    // Pull-up rating
    const pullupBW = fmt(document.getElementById('pfPullupBW')?.value);
    const pullupWeight = fmt(document.getElementById('pfPullupWeight')?.value);
    const pullupRating = document.getElementById('pullupRating');
    
    if(pullupBW > 0) {
      const totalWeight = pullupBW + pullupWeight;
      const percent = (pullupWeight / pullupBW) * 100;
      
      let rating = '';
      let color = '#9de8c5';
      
      if(percent >= 50) {
        rating = `Total: ${totalWeight} lb (Elite - ${percent.toFixed(0)}% added)`;
        color = '#00ffb3';
      } else if(percent >= 25) {
        rating = `Total: ${totalWeight} lb (Good - ${percent.toFixed(0)}% added)`;
        color = '#9de8c5';
      } else if(percent >= 10) {
        rating = `Total: ${totalWeight} lb (Average - ${percent.toFixed(0)}% added)`;
        color = '#ffbb33';
      } else {
        rating = `Total: ${totalWeight} lb (Needs strength work)`;
        color = '#ff6b6b';
      }
      
      pullupRating.textContent = rating;
      pullupRating.style.color = color;
    } else {
      pullupRating.textContent = '';
    }
    
    // Deadlift rating
    const deadliftWeight = fmt(document.getElementById('pfDeadliftWeight')?.value);
    const deadliftBW = fmt(document.getElementById('pfDeadliftBW')?.value);
    const deadliftRating = document.getElementById('deadliftRating');
    
    if(deadliftWeight > 0 && deadliftBW > 0) {
      const ratio = deadliftWeight / deadliftBW;
      
      let rating = '';
      let color = '#9de8c5';
      
      // Assume male standards (can be adjusted)
      if(ratio >= 2.5) {
        rating = `${ratio.toFixed(2)}√ó bodyweight (Elite)`;
        color = '#00ffb3';
      } else if(ratio >= 2.0) {
        rating = `${ratio.toFixed(2)}√ó bodyweight (Good)`;
        color = '#9de8c5';
      } else if(ratio >= 1.5) {
        rating = `${ratio.toFixed(2)}√ó bodyweight (Average)`;
        color = '#ffbb33';
      } else {
        rating = `${ratio.toFixed(2)}√ó bodyweight (Needs work)`;
        color = '#ff6b6b';
      }
      
      deadliftRating.textContent = rating;
      deadliftRating.style.color = color;
    } else {
      deadliftRating.textContent = '';
    }
  }
  
  // Add event listeners for real-time updates (will be initialized on profile open)
  function initBaselineListeners() {
    const fields = [
      'pfBikePeakHR', 'pfBikeHR60', 'pfMedBallRight', 'pfMedBallLeft',
      'pfPullupBW', 'pfPullupWeight', 'pfDeadliftWeight', 'pfDeadliftBW'
    ];
    
    fields.forEach(id => {
      const el = document.getElementById(id);
      if(el) {
        el.addEventListener('input', updateBaselineMetrics);
      }
    });
  }
  
  // Render Fight Camp Dashboard (replaces calendar when in fight camp mode)
  function renderFightCampDashboard() {
    const profile = LS.get('elite_profile', {});
    if(!profile.fightCamp) {
      renderCal();
      return;
    }
    
    // Update header indicator
    const indicator = document.getElementById('fcIndicator');
    if(indicator) {
      const today = new Date();
      const startDate = new Date(profile.fightCamp.startDate);
      const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
      const currentDay = daysSinceStart + 1;
      const totalDays = profile.fightCamp.length * 7;
      const daysToFight = totalDays - currentDay;
      indicator.textContent = `ü•ä FIGHT CAMP - ${daysToFight} DAYS TO FIGHT`;
      indicator.style.display = 'inline';
    }
    
    const fc = profile.fightCamp;
    const today = new Date();
    const dayOfWeek = (today.getDay() + 6) % 7; // Convert to Monday=0
    const todaySchedule = fc.schedule[dayOfWeek];
    
    // Calculate camp progress
    const startDate = new Date(fc.startDate);
    const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
    const currentDay = daysSinceStart + 1;
    const totalDays = fc.length * 7;
    const currentWeek = Math.ceil(currentDay / 7);
    const weeksRemaining = fc.length - currentWeek + 1;
    
    // Get today's data if logged
    const todayKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
    const todayData = store[todayKey];
    
    // Get current fatigue metrics
    const recentDays = Object.keys(store).sort().slice(-7);
    let avgCNS = 0;
    let cnsCount = 0;
    recentDays.forEach(key => {
      const day = store[key];
      if(day?.totalCNS) {
        avgCNS += day.totalCNS;
        cnsCount++;
      }
    });
    avgCNS = cnsCount > 0 ? Math.round(avgCNS / cnsCount) : 0;
    
    // Calculate current weight vs target trajectory
    const latestWeight = fc.currentWeight; // TODO: Update from recent logs
    const targetWeight = fc.targetWeight;
    const weightToLose = latestWeight - targetWeight;
    const weeksToFight = weeksRemaining;
    const recommendedWeeklyLoss = weeksToFight > 0 ? weightToLose / weeksToFight : 0;
    
    // Get daily recommendation
    const recommendation = getDailyRecommendation(profile, avgCNS, todayData);
    
    // Hide calendar, show dashboard
    document.getElementById('cal').style.display = 'none';
    const dashboard = document.getElementById('fightCampDashboard');
    dashboard.style.display = 'block';
    
    dashboard.innerHTML = `
      <div class="sec" style="background:linear-gradient(135deg, #0d1714 0%, #0f1b17 100%);border:2px solid #00ffb3">
        <div class="hd" style="background:#00ffb3;color:#0a0f0d;font-size:18px">
          ü•ä FIGHT CAMP - DAY ${currentDay}/${totalDays} (Week ${currentWeek}/${fc.length})
        </div>
        <div class="bd">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">
            <div class="kpi" style="border-left-color:#00ffb3">
              <div class="muted">Days to Fight</div>
              <div class="v" style="color:#00ffb3">${totalDays - currentDay}</div>
            </div>
            <div class="kpi" style="border-left-color:${recommendation.color}">
              <div class="muted">Status</div>
              <div class="v" style="color:${recommendation.color};font-size:14px">${recommendation.status}</div>
            </div>
            <div class="kpi">
              <div class="muted">Current Weight</div>
              <div class="v">${latestWeight} lb</div>
            </div>
            <div class="kpi">
              <div class="muted">Target Weight</div>
              <div class="v">${targetWeight} lb</div>
            </div>
            <div class="kpi" style="border-left-color:${Math.abs(weightToLose) > 15 ? '#ffbb33' : '#9de8c5'}">
              <div class="muted">To Lose</div>
              <div class="v">${weightToLose.toFixed(1)} lb</div>
            </div>
            <div class="kpi">
              <div class="muted">Avg CNS (7d)</div>
              <div class="v">${avgCNS}</div>
            </div>
          </div>
          
          ${recommendation.alert ? `<div class="danger" style="margin-bottom:12px"><b>‚ö†Ô∏è ${recommendation.alert}</b></div>` : ''}
          ${recommendation.message ? `<div class="note" style="margin-bottom:12px">${recommendation.message}</div>` : ''}
          
          <div style="background:#0d1714;padding:12px;border:1px solid #1e6a4f;border-radius:4px;margin-bottom:12px">
            <b>Weekly Target Weight Loss:</b> ${recommendedWeeklyLoss.toFixed(1)} lb/week
            <br><span style="font-size:12px;color:#ccc">Safe range: 1-2 lb/week. Adjust nutrition if off track.</span>
          </div>
        </div>
      </div>
      
      ${renderDailySession('AM', todaySchedule.am, dayOfWeek, profile, recommendation, todayData)}
      ${todaySchedule.pm !== 'Off' ? renderDailySession('PM', todaySchedule.pm, dayOfWeek, profile, recommendation, todayData) : ''}
      
      <div style="margin-top:16px;text-align:center">
        <button class="btn" onclick="showWeekSchedule()">üìÖ View Full Week Schedule</button>
        <button class="btn" onclick="renderCal();document.getElementById('cal').style.display='block';document.getElementById('fightCampDashboard').style.display='none'">üìä View Calendar</button>
      </div>
    `;
  }
  
  // Render individual session card
  function renderDailySession(timeOfDay, sessionType, dayIdx, profile, recommendation, todayData) {
    if(sessionType === 'Off') return '';
    
    const sessionLogged = todayData?.modalities && checkIfSessionLogged(todayData, sessionType);
    const prescription = generatePrescription(sessionType, profile, recommendation);
    
    return `
      <div class="sec" style="margin-top:12px">
        <div class="hd" style="background:${sessionLogged ? '#1e6a4f' : '#0f1b17'}">
          ${timeOfDay === 'AM' ? 'üåÖ' : 'üåÜ'} ${timeOfDay} SESSION: ${sessionType.toUpperCase()}
          ${sessionLogged ? '<span style="color:#00ffb3;margin-left:8px">‚úì LOGGED</span>' : ''}
        </div>
        <div class="bd">
          ${!sessionLogged ? `
            <button class="btn primary" onclick="viewPrescription('${sessionType}','${timeOfDay}')" style="margin-bottom:12px">
              üìã View Full Prescription
            </button>
            <button class="btn" onclick="openDay('${new Date().toISOString().split('T')[0]}')">
              ‚úèÔ∏è Log Session
            </button>
          ` : `
            <button class="btn" onclick="openDay('${new Date().toISOString().split('T')[0]}')">
              üìä View Logged Data
            </button>
          `}
          
          <div style="margin-top:12px;padding:10px;background:#0d1714;border-left:3px solid ${recommendation.color}">
            <div style="font-weight:700;margin-bottom:6px">Quick Summary:</div>
            <div style="font-size:13px">${prescription.summary}</div>
          </div>
        </div>
      </div>
    `;
  }
  
  // Check if session type has been logged today
  function checkIfSessionLogged(dayData, sessionType) {
    if(!dayData.modalities) return false;
    
    const typeMap = {
      'Strength Upper': ['chest', 'back'],
      'Strength Lower': ['legs'],
      'Strength Full Body': ['chest', 'back', 'legs'],
      'Striking': ['chest', 'back'], // Often logs as striking work
      'BJJ/Grappling': ['bjj'],
      'MMA Sparring': ['bjj'],
      'Conditioning (Bike)': ['bike'],
      'Track/Plyometrics': ['track'],
      'Active Recovery': ['walk'],
      'Mobility/Yoga': ['walk']
    };
    
    const checkModalities = typeMap[sessionType] || [];
    return checkModalities.some(mod => dayData.modalities[mod]);
  }
  
  // Get daily recommendation: PUSH / MAINTAIN / REDUCE / RECOVER
  function getDailyRecommendation(profile, avgCNS, todayData) {
    const fc = profile.fightCamp;
    if(!fc) return {status: 'MAINTAIN', color: '#9de8c5', message: ''};
    
    // Get recent metrics
    const recentDays = Object.keys(store).sort().slice(-7);
    const acwrData = calculateEWMA_ACWR();
    const strainData = analyzeFosterStrain();
    const sleepData = analyzeSleepPattern();
    const rsiData = analyzeRSIDecline();
    
    let status = 'PUSH HARD';
    let color = '#00ffb3';
    let alert = '';
    let message = '';
    let score = 0; // Positive = push, negative = reduce
    
    // FACTOR 1: CNS Status
    if(avgCNS > 75) {
      score -= 3;
      alert = 'CNS Fatigue Elevated';
    } else if(avgCNS > 65) {
      score -= 1;
    } else if(avgCNS < 55) {
      score += 2;
    }
    
    // FACTOR 2: ACWR (Acute:Chronic Ratio)
    if(acwrData.ratio > 1.45) {
      score -= 3;
      alert = alert || 'ACWR > 1.45 - High Injury Risk';
    } else if(acwrData.ratio > 1.3) {
      score -= 2;
    } else if(acwrData.ratio < 0.8) {
      score += 1;
    }
    
    // FACTOR 3: Strain (Foster Model)
    if(strainData.highStrain) {
      score -= 2;
      alert = alert || 'High Strain Detected';
    }
    
    // FACTOR 4: Sleep Patterns
    if(sleepData.hasAlert) {
      score -= 3;
      alert = alert || `${sleepData.maxConsecutive} Nights Poor Sleep`;
    } else if(sleepData.avgSleep < 7) {
      score -= 1;
    }
    
    // FACTOR 5: RSI Decline
    if(rsiData.decline) {
      score -= 2;
      message += `RSI declined ${rsiData.declinePercent}%. `;
    }
    
    // FACTOR 6: Fitness Level
    const fitness = parseInt(fc.fitness) || 5;
    if(fitness <= 3) {
      score -= 1; // Conservative if out of shape
    } else if(fitness >= 8) {
      score += 1; // Can handle more if in shape
    }
    
    // FACTOR 7: Weeks Remaining
    const today = new Date();
    const startDate = new Date(fc.startDate);
    const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
    const currentWeek = Math.ceil((daysSinceStart + 1) / 7);
    const weeksRemaining = fc.length - currentWeek + 1;
    
    if(weeksRemaining <= 1) {
      score -= 2; // Taper week
      message += 'Fight week - taper mode. ';
    } else if(weeksRemaining <= 2) {
      score -= 1; // Light taper
    }
    
    // DETERMINE STATUS
    if(score <= -4) {
      status = 'RECOVER';
      color = '#ff6b6b';
      message += 'Take rest day or light active recovery only.';
    } else if(score <= -2) {
      status = 'REDUCE VOLUME';
      color = '#ffbb33';
      message += 'Cut session volume 20-30% or reduce intensity.';
    } else if(score <= 0) {
      status = 'MAINTAIN';
      color = '#9de8c5';
      message += 'Execute planned session as prescribed.';
    } else {
      status = 'PUSH HARD';
      color = '#00ffb3';
      message += 'You\'re recovered and ready to push. Max effort today.';
    }
    
    return {status, color, alert, message, score};
  }
  
  // Generate specific workout prescription
  // Generate specific workout prescription using exercise database
  function generatePrescription(sessionType, profile, recommendation) {
    const fc = profile.fightCamp;
    const fitness = parseInt(fc.fitness) || 5;
    const priority = fc.priority || 'Balanced';
    
    // Determine current block (LP1-LP4)
    const today = new Date();
    const startDate = new Date(fc.startDate);
    const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
    const currentWeek = Math.ceil((daysSinceStart + 1) / 7);
    const weeksRemaining = fc.length - currentWeek + 1;
    
    let block = 'LP1';
    let baseInt = 0.70;
    if(weeksRemaining >= 5) { block = 'LP2'; baseInt = 0.80; }
    if(weeksRemaining <= 4 && weeksRemaining > 2) { block = 'LP3'; baseInt = 0.85; }
    if(weeksRemaining <= 2) { block = 'LP4'; baseInt = 0.75; } // Taper
    
    // Adjust for fitness and recommendation
    if(fitness <= 3) baseInt -= 0.05;
    if(fitness >= 8) baseInt += 0.05;
    if(recommendation.status === 'REDUCE VOLUME') baseInt -= 0.10;
    if(recommendation.status === 'RECOVER') baseInt -= 0.20;
    if(recommendation.status === 'PUSH HARD') baseInt += 0.05;
    
    // Get exercise categories for this session
    const categories = SESSION_MAP[sessionType] || [];
    let exercises = [];
    
    // Select exercises based on priority and categories
    if(sessionType === 'Strength Upper' || sessionType === 'Strength Lower' || sessionType === 'Strength Full Body') {
      categories.forEach(cat => {
        const pool = EXERCISES[cat] || [];
        const numToSelect = cat.includes('strength') ? 2 : 1;
        for(let i = 0; i < Math.min(numToSelect, pool.length); i++) {
          exercises.push(pool[i]);
        }
      });
    } else if(sessionType === 'Track/Plyometrics') {
      const pool = EXERCISES.plyometric || [];
      exercises = pool.slice(0, 3);
    } else if(sessionType === 'Striking') {
      const pool = EXERCISES.rotational || [];
      exercises = pool.slice(0, 2);
    }
    
    // Build detailed prescription
    let summary = `${block} - ${sessionType}\n\n`;
    
    if(exercises.length > 0) {
      exercises.forEach((ex, idx) => {
        const sets = block === 'LP3' ? ex.sets[1] : ex.sets[0];
        const reps = typeof ex.reps[0] === 'number' ? (block === 'LP3' ? ex.reps[0] : ex.reps[1]) : ex.reps[0];
        const adjustedInt = Math.round((ex.int * (baseInt / 0.80)) * 100); // Normalize to base
        const rpe = adjustedInt >= 90 ? 9 : adjustedInt >= 85 ? 8 : 7;
        const rir = 10 - rpe;
        
        summary += `${idx + 1}. ${ex.name}\n`;
        summary += `   ‚Ä¢ ${sets} sets √ó ${reps} reps @ ${adjustedInt}%\n`;
        summary += `   ‚Ä¢ RPE ${rpe}, RIR ${rir}\n`;
        summary += `   ‚Ä¢ Rest: ${ex.rest}s\n`;
        summary += `   ‚Ä¢ ${ex.tempo}\n\n`;
      });
    } else {
      // Fallback for non-strength sessions
      if(sessionType === 'Conditioning (Bike)') {
        const rounds = weeksRemaining <= 2 ? 4 : fitness <= 4 ? 6 : 8;
        summary += `Assault Bike - C2 Protocol\n`;
        summary += `‚Ä¢ Rounds: ${rounds}\n`;
        summary += `‚Ä¢ Time Cap: 25s per round\n`;
        summary += `‚Ä¢ Rest: Until HR < 140 bpm\n`;
        summary += `‚Ä¢ RPM Target: ${fitness <= 4 ? '85-95' : fitness <= 7 ? '95-105' : '105-115'}\n`;
      } else if(sessionType === 'BJJ/Grappling' || sessionType === 'MMA Sparring') {
        const duration = weeksRemaining <= 2 ? 30 : fitness <= 4 ? 45 : fitness <= 7 ? 60 : 75;
        summary += `${sessionType}\n`;
        summary += `‚Ä¢ Duration: ${duration} minutes\n`;
        summary += `‚Ä¢ Intensity: ${weeksRemaining <= 2 ? 'Light-Medium' : 'Medium-High'}\n`;
        summary += `‚Ä¢ Rounds: ${Math.ceil(duration/5)} √ó 5min\n`;
        summary += `‚Ä¢ Rest: 1 min between rounds\n`;
      } else if(sessionType === 'Active Recovery') {
        summary += `Recovery Session\n`;
        summary += `‚Ä¢ Duration: 30-45 minutes\n`;
        summary += `‚Ä¢ Walking, stretching, or yoga\n`;
        summary += `‚Ä¢ HR: Zone 1-2 (<130 bpm)\n`;
      }
    }
    
    return {summary, block, intensity: baseInt, exercises};
  }
  
  // View full prescription in modal
  function viewPrescription(sessionType, timeOfDay) {
    const profile = LS.get('elite_profile', {});
    const recommendation = getDailyRecommendation(profile, 0, null);
    const prescription = generatePrescription(sessionType, profile, recommendation);
    
    const modal = document.getElementById('prescriptionModal');
    const body = document.getElementById('prescriptionBody');
    
    body.innerHTML = `
      <div class="sec">
        <div class="hd" style="background:#00ffb3;color:#0a0f0d">
          ${timeOfDay === 'AM' ? 'üåÖ' : 'üåÜ'} ${timeOfDay} - ${sessionType.toUpperCase()}
        </div>
        <div class="bd">
          <div style="margin-bottom:16px;padding:12px;background:#0d1714;border-left:3px solid ${recommendation.color}">
            <div style="font-weight:700;margin-bottom:6px">üìä Today's Status: <span style="color:${recommendation.color}">${recommendation.status}</span></div>
            <div style="font-size:13px">${recommendation.message}</div>
          </div>
          
          <div style="margin-bottom:16px;padding:12px;background:#0d1f1a;border:1px solid #1e6a4f">
            <div style="font-weight:700;margin-bottom:8px">üéØ Current Block: ${prescription.block}</div>
            <div style="font-size:13px;color:#ccc">Intensity: ${Math.round(prescription.intensity*100)}%</div>
          </div>
          
          <div style="padding:12px;background:#0d1714;border:1px solid #00ffb3;border-radius:4px;white-space:pre-wrap;font-family:monospace;font-size:13px">
${prescription.summary}
          </div>
          
          <div style="margin-top:16px">
            <button class="btn primary" onclick="openDay('${new Date().toISOString().split('T')[0]}');closePrescription()">
              ‚úèÔ∏è Log This Session
            </button>
            <button class="btn" onclick="closePrescription()">Close</button>
          </div>
        </div>
      </div>
    `;
    
    modal.classList.add('show');
  }
  
  // AUTO-PROGRESSION: Calculate next workout based on performance + God-Mode
  function calculateProgression(exerciseName, history, godModeStatus) {
    if(!history || history.length === 0) return null;
    
    const lastWorkout = history[history.length - 1];
    const prescribed = lastWorkout.prescribed;
    const actual = lastWorkout.actual;
    
    if(!prescribed || !actual) return prescribed; // No comparison possible
    
    // Compare performance
    const loadRatio = (actual.load || 0) / (prescribed.load || 1);
    const rpeComparison = (actual.rpe || 8) - (prescribed.rpe || 8);
    const completedRatio = (actual.sets || 0) / (prescribed.sets || 1);
    
    // Decision matrix based on God-Mode status
    let loadMultiplier = 1.0;
    
    if(godModeStatus === 'GREEN') {
      // All systems go - can progress
      if(loadRatio >= 1.02 && rpeComparison <= 0 && completedRatio >= 1.0) {
        loadMultiplier = 1.025; // Crushed it - big jump
      } else if(loadRatio >= 0.98 && rpeComparison <= 1) {
        loadMultiplier = 1.0125; // Completed as planned - small jump
      } else if(loadRatio < 0.95 || rpeComparison > 2) {
        loadMultiplier = 1.0; // Struggled - maintain
      }
    } else if(godModeStatus === 'YELLOW') {
      // Caution - only increase if crushed
      if(loadRatio >= 1.05 && rpeComparison <= -1) {
        loadMultiplier = 1.0125;
      } else {
        loadMultiplier = 1.0; // Maintain
      }
    } else if(godModeStatus === 'RED') {
      // Overtraining - reduce
      loadMultiplier = 0.95;
    }
    
    return {
      sets: prescribed.sets,
      reps: prescribed.reps,
      load: Math.round((prescribed.load || 0) * loadMultiplier),
      rpe: prescribed.rpe,
      rir: prescribed.rir,
      rest: prescribed.rest,
      tempo: prescribed.tempo
    };
  }
  
  // Get God-Mode status (GREEN/YELLOW/RED)
  function getGodModeStatus() {
    const recentDays = Object.keys(store).sort().slice(-7);
    let alerts = 0;
    
    // Calculate metrics
    let avgCNS = 0;
    let cnsCount = 0;
    recentDays.forEach(key => {
      const day = store[key];
      if(day?.totalCNS) {
        avgCNS += day.totalCNS;
        cnsCount++;
      }
    });
    avgCNS = cnsCount > 0 ? avgCNS / cnsCount : 0;
    
    const acwrData = calculateEWMA_ACWR();
    const strainData = analyzeFosterStrain();
    const sleepData = analyzeSleepPattern();
    const rsiData = analyzeRSIDecline();
    
    // Count alerts
    if(avgCNS > 75) alerts++;
    if(acwrData.ratio > 1.45) alerts += 2; // Critical
    if(acwrData.ratio > 1.30) alerts++;
    if(strainData.highStrain) alerts++;
    if(sleepData.hasAlert) alerts += 2; // Critical
    if(rsiData.decline) alerts++;
    
    if(alerts === 0) return 'GREEN';
    if(alerts <= 2) return 'YELLOW';
    return 'RED';
  }
  
  // Show full week schedule
  function showWeekSchedule() {
    const profile = LS.get('elite_profile', {});
    if(!profile.fightCamp) return;
    
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    let html = '<div class="sec"><div class="hd">üìÖ Weekly Training Schedule</div><div class="bd">';
    
    profile.fightCamp.schedule.forEach((day, idx) => {
      html += `
        <div style="padding:10px;margin-bottom:8px;background:#0d1714;border:1px solid #1e6a4f;border-radius:4px">
          <div style="font-weight:700;color:#9de8c5;margin-bottom:6px">${days[idx]}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
            <div>üåÖ AM: ${day.am}</div>
            <div>üåÜ PM: ${day.pm}</div>
          </div>
        </div>
      `;
    });
    
    html += '</div></div>';
    
    document.getElementById('prescriptionBody').innerHTML = html;
    document.getElementById('prescriptionModal').classList.add('show');
  }

  function initStrength(targetId){
    const box=document.getElementById(targetId);
    box.innerHTML=`
      <div class="row" style="margin-bottom:6px">
        <button class="btn primary" onclick="addExercise('${targetId}')">+ Add Exercise</button>
        <div class="muted sm">Then "+ Add Set" under each exercise.</div>
      </div>
      <div class="muted sm">Enter working sets only. Volume = Œ£ weight√óreps.</div>
      <div id="${targetId}-list"></div>`;
  }
  function hydrateStrength(targetId,data){
    initStrength(targetId);
    (data?.exercises||[{name:'',sets:[{w:'',r:'',rpe:''},{w:'',r:'',rpe:''}]}]).forEach(ex=>{
      addExercise(targetId,ex);
    });
  }
  function addExercise(targetId, preset){
    const list=document.getElementById(`${targetId}-list`);
    const idx=list.children.length+1;
    const ex=document.createElement('div');
    ex.className='sec'; ex.innerHTML=`
      <div class="hd">Exercise ${idx}</div>
      <div class="bd">
        <div class="grid2">
          <div><label>Name</label><input class="ex-name" value="${preset?.name||''}" placeholder="Bench Press"></div>
          <div><label>Muscle Group</label>
            <select class="ex-muscle">
              <option></option><option>Chest</option><option>Back</option><option>Shoulders</option><option>Biceps</option><option>Triceps</option><option>Quads</option><option>Hamstrings</option><option>Glutes</option><option>Calves</option><option>Core</option>
            </select>
          </div>
        </div>
        <table class="sm" style="margin-top:8px">
          <thead><tr><th>Weight (lb)</th><th>Reps</th><th>RPE</th><th>Velocity (m/s)</th><th></th></tr></thead>
          <tbody class="setBody"></tbody>
        </table>
        <button class="btn" onclick="addSet(this)">+ Add Set</button>
        <div class="note" style="margin-top:6px;font-size:11px">
          <b>God-Mode Velocity Stops:</b> Optional bar velocity tracking. Alert triggers when velocity drops >20-40% from first rep (indicates fatigue, prevents junk volume).
        </div>
      </div>`;
    list.appendChild(ex);
    const sb=ex.querySelector('.setBody');
    (preset?.sets||Array.from({length:3}).map(_=>({w:'',r:'',rpe:'',velocity:''}))).forEach(s=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><input class="w" type="number" inputmode="decimal" step="0.1" value="${s.w}"></td>
        <td><input class="r" type="number" value="${s.r}"></td>
        <td><input class="p" type="number" step="0.5" value="${s.rpe}"></td>
        <td><input class="v" type="number" step="0.01" value="${s.velocity||''}" placeholder="Optional"></td>
        <td><button class="btn" onclick="this.closest('tr').remove()">üóë</button></td>`;
      sb.appendChild(tr);
    });
  }
  function addSet(btn){
    const sb=btn.closest('.bd').querySelector('.setBody');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input class="w" type="number" inputmode="decimal" step="0.1"></td>
      <td><input class="r" type="number"></td>
      <td><input class="p" type="number" step="0.5"></td>
      <td><input class="v" type="number" step="0.01" placeholder="Optional"></td>
      <td><button class="btn" onclick="this.closest('tr').remove()">üóë</button></td>`;
    sb.appendChild(tr);
  }
  function collectStrength(targetId){
    const list=document.getElementById(`${targetId}-list`);
    const exEls=[...list.querySelectorAll('.sec')];
    const exercises=exEls.map(sec=>{
      const name=sec.querySelector('.ex-name').value.trim();
      const sets=[...sec.querySelectorAll('.setBody tr')].map(tr=>({
        w:fmt(tr.querySelector('.w').value),
        r:fmt(tr.querySelector('.r').value),
        rpe:fmt(tr.querySelector('.p').value),
        velocity:fmt(tr.querySelector('.v')?.value) // GOD-MODE: Bar velocity
      })).filter(s=>s.w>0&&s.r>0);
      return name && sets.length?{name,sets}:null;
    }).filter(Boolean);
    if(!exercises.length) return null;
    
    let vol=0, rpeSum=0, rpeCnt=0;
    let est1RMs = [];
    let hypertrophyStimulus = 0;
    let neuralLoad = 0;
    let totalEffReps = 0; // GOD-MODE: Effective Reps
    let velocityWarnings = []; // GOD-MODE: Velocity stop detection
    
    exercises.forEach(ex => {
      // GOD-MODE: Check for velocity drops in this exercise
      const velocities = ex.sets.filter(s => s.velocity > 0).map(s => s.velocity);
      if(velocities.length >= 2) {
        const firstVelocity = velocities[0];
        const lastVelocity = velocities[velocities.length - 1];
        const velocityDrop = ((firstVelocity - lastVelocity) / firstVelocity) * 100;
        
        if(velocityDrop > 20) {
          velocityWarnings.push({
            exercise: ex.name,
            drop: velocityDrop.toFixed(1),
            threshold: velocityDrop > 40 ? 'CRITICAL' : 'WARNING'
          });
        }
      }
      
      ex.sets.forEach(s => {
        vol += s.w * s.r;
        
        if(s.rpe) {
          rpeSum += s.rpe;
          rpeCnt++;
          
          // Calculate 1RM using Epley formula via RIR
          const RIR = 10 - s.rpe;
          const loadPct = 100 - (RIR * 4);
          const est1RM = s.w / (Math.max(loadPct, 30) / 100);
          est1RMs.push(est1RM);
          
          // Hypertrophy stimulus = volume √ó intensity
          hypertrophyStimulus += (s.w * s.r) * (s.rpe / 10);
          
          // Neural load = load% √ó RPE √ó sets
          neuralLoad += (loadPct / 100) * s.rpe;
          
          // GOD-MODE: Effective Reps = max(0, reps - RIR - 4)
          // Only reps close to failure count for hypertrophy
          const effReps = Math.max(0, s.r - RIR - 4);
          totalEffReps += effReps;
          
          // Store EffReps in set for display
          s.effReps = effReps;
        }
      });
    });
    
    const avgRPE = rpeCnt ? rpeSum / rpeCnt : 0;
    const avg1RM = est1RMs.length ? Math.round(est1RMs.reduce((a,b)=>a+b,0) / est1RMs.length) : 0;
    
    let cns=40 + (avgRPE>=9?15:avgRPE>=8.5?10:avgRPE<=7?-8:0);
    
    // Apply UFC PI modality weighting
    cns = applyModalityWeight(cns, 'strength'); // Max Effort Strength = 1.0
    
    const tss = Math.round(60 * (avgRPE/10) * 100);
    
    return {
      exercises, 
      volume: vol, 
      avgRPE,
      est1RM: avg1RM,
      hypertrophyStimulus: Math.round(hypertrophyStimulus),
      neuralLoad: Math.round(neuralLoad),
      effReps: totalEffReps, // GOD-MODE: Total Effective Reps
      velocityWarnings, // GOD-MODE: Velocity stop alerts
      cnsScore: clamp(cns,0,100), 
      tss
    };
  }

  function resetTrack(){
    trkSleep.value=''; trkAch.value='';
    const surfaceEl = document.getElementById('trkSurface');
    if(surfaceEl) surfaceEl.value = 'track';
    document.getElementById('trkPrev').innerHTML='No image';
    document.getElementById('trackExercises').innerHTML='';
    document.querySelectorAll('.warmupCheck').forEach(cb => cb.checked = false);
    updateWarmupProgress();
    ['trkAvgHR','trkPeakHR','trkZ5','trkZ4','trkDFA'].forEach(id=>document.getElementById(id).value='');
  }
  
  function updateWarmupProgress(){
    const checks = document.querySelectorAll('.warmupCheck');
    const completed = [...checks].filter(cb => cb.checked).length;
    const total = checks.length;
    const progress = document.getElementById('warmupProgress');
    if(progress) {
      progress.textContent = `${completed}/${total} Complete`;
      if(completed === total) {
        progress.style.color = '#38ef7d';
        progress.textContent = '‚úì ' + progress.textContent;
      } else {
        progress.style.color = '#ffbb33';
      }
    }
  }
  
  function hydrateTrack(d){
    resetTrack();
    if(!d) return;
    trkSleep.value=d.sleep||''; trkAch.value=d.ach||'';
    const surfaceEl = document.getElementById('trkSurface');
    if(surfaceEl && d.surface) surfaceEl.value = d.surface;
    
    if(d.warmupChecks) {
      const checks = document.querySelectorAll('.warmupCheck');
      d.warmupChecks.forEach((checked, idx) => {
        if(checks[idx]) checks[idx].checked = checked;
      });
      updateWarmupProgress();
    }
    
    if(d.hr){
      trkAvgHR.value=d.hr.avg||''; trkPeakHR.value=d.hr.peak||''; 
      trkZ5.value=d.hr.z5||''; trkZ4.value=d.hr.z4||'';
    }
    
    (d.exercises||[]).forEach(ex => addTrackExercise(ex));
  }
  
  function addTrackExercise(data={}){
    const container = document.getElementById('trackExercises');
    const exerciseNum = container.children.length + 1;
    
    const exerciseDiv = document.createElement('div');
    exerciseDiv.className = 'sec';
    exerciseDiv.style.cssText = 'margin-top:10px;background:#0d1714;border:1px solid #1e6a4f;position:relative';
    
    exerciseDiv.innerHTML = `
      <button class="btn" onclick="this.closest('.sec').remove()" style="position:absolute;top:8px;right:8px;padding:4px 8px;font-size:11px">üóë Remove</button>
      <div class="hd" style="background:#0f1b17;border-bottom:1px solid #1e6a4f;color:#9de8c5">
        Exercise #${exerciseNum}
      </div>
      <div class="bd">
        <div class="grid2">
          <div style="grid-column:span 2">
            <label>Exercise Name</label>
            <input class="exName" type="text" value="${data.name||''}" placeholder="e.g., Broad Jump, Single Leg Stair Jump">
          </div>
          <div>
            <label>Type</label>
            <select class="exType" onchange="toggleExerciseFields(this)">
              <option value="bilateral" ${(!data.type || data.type==='bilateral')?'selected':''}>Bilateral (both legs)</option>
              <option value="unilateral" ${data.type==='unilateral'?'selected':''}>Unilateral (single leg)</option>
            </select>
          </div>
          <div>
            <label>Sets</label>
            <input class="exSets" type="number" min="1" value="${data.sets||''}" placeholder="e.g., 4">
          </div>
          <div class="bilateralFields" ${data.type==='unilateral'?'style="display:none"':''}>
            <label>Reps per set</label>
            <input class="exReps" type="number" min="1" value="${data.reps||''}" placeholder="e.g., 34">
          </div>
          <div class="unilateralFields" ${data.type==='unilateral'?'':'style="display:none"'}>
            <label>R Leg reps per set</label>
            <input class="exRepsRight" type="number" min="1" value="${data.repsRight||''}" placeholder="e.g., 21">
          </div>
          <div class="unilateralFields" ${data.type==='unilateral'?'':'style="display:none"'}>
            <label>L Leg reps per set</label>
            <input class="exRepsLeft" type="number" min="1" value="${data.repsLeft||''}" placeholder="e.g., 21">
          </div>
          <div>
            <label>RPE (1-10)</label>
            <input class="exRPE" type="number" step="0.5" min="1" max="10" value="${data.rpe||''}" placeholder="8">
          </div>
          <div>
            <label>Time (MM:SS)</label>
            <input class="exTime" type="text" value="${data.time||''}" placeholder="00:30">
          </div>
          <div>
            <label>Flight Time (ms) - RSI</label>
            <input class="exFlightTime" type="number" step="1" value="${data.flightTime||''}" placeholder="Optional">
          </div>
          <div>
            <label>Contact Time (ms) - RSI</label>
            <input class="exContactTime" type="number" step="1" value="${data.contactTime||''}" placeholder="Optional">
          </div>
          <div>
            <label>Rest Between Sets (s)</label>
            <input class="exRest" type="number" step="1" value="${data.restTime||''}" placeholder="e.g., 60">
          </div>
          <div class="rsiDisplay" style="grid-column:span 2;display:none;padding:8px;background:#0d1f1a;border:1px solid #00ffb3;border-radius:4px">
            <b>RSI (Reactive Strength Index):</b> <span class="rsiValue">‚Äî</span>
          </div>
          <div class="densityDisplay" style="grid-column:span 2;display:none;padding:8px;background:#0d1714;border:1px solid #ffbb33;border-radius:4px">
            <b>Density Factor:</b> <span class="densityValue">‚Äî</span> <span class="densityNote" style="font-size:11px"></span>
          </div>
          <div style="grid-column:span 2">
            <label>Notes</label>
            <input class="exNotes" type="text" value="${data.notes||''}" placeholder="Optional notes">
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(exerciseDiv);
    
    // GOD-MODE: Auto-calculate RSI when flight/contact times change
    const flightInput = exerciseDiv.querySelector('.exFlightTime');
    const contactInput = exerciseDiv.querySelector('.exContactTime');
    const restInput = exerciseDiv.querySelector('.exRest');
    const rsiDisplay = exerciseDiv.querySelector('.rsiDisplay');
    const rsiValue = exerciseDiv.querySelector('.rsiValue');
    const densityDisplay = exerciseDiv.querySelector('.densityDisplay');
    const densityValue = exerciseDiv.querySelector('.densityValue');
    const densityNote = exerciseDiv.querySelector('.densityNote');
    
    const updateRSI = () => {
      const flight = parseFloat(flightInput.value);
      const contact = parseFloat(contactInput.value);
      
      if(flight > 0 && contact > 0) {
        const rsi = (flight / contact).toFixed(2);
        rsiValue.textContent = rsi;
        rsiDisplay.style.display = 'block';
        
        // Color code RSI
        if(rsi >= 2.0) {
          rsiDisplay.style.borderColor = '#00ffb3';
          rsiValue.style.color = '#00ffb3';
        } else if(rsi >= 1.5) {
          rsiDisplay.style.borderColor = '#ffbb33';
          rsiValue.style.color = '#ffbb33';
        } else {
          rsiDisplay.style.borderColor = '#ff6b6b';
          rsiValue.style.color = '#ff6b6b';
        }
      } else {
        rsiDisplay.style.display = 'none';
      }
    };
    
    // GOD-MODE: Calculate Density Factor
    const updateDensity = () => {
      const contact = parseFloat(contactInput.value);
      const rest = parseFloat(restInput.value);
      
      if(contact > 0 && rest > 0) {
        // DensityFactor based on contact:rest ratio
        // Higher density = less rest relative to work = more tendon stress
        const contactSec = contact / 1000; // Convert ms to seconds
        const ratio = contactSec / rest;
        
        // DensityFactor ranges from 1.0 (leisurely) to 1.4 (intense)
        // ratio < 0.01 (e.g., 100ms contact, 60s rest) = 1.0
        // ratio > 0.05 (e.g., 300ms contact, 6s rest) = 1.4
        let densityFactor = 1.0 + (Math.min(ratio, 0.05) / 0.05) * 0.4;
        densityFactor = Math.min(1.4, Math.max(1.0, densityFactor));
        
        densityValue.textContent = densityFactor.toFixed(2) + '√ó';
        
        if(densityFactor >= 1.3) {
          densityDisplay.style.borderColor = '#ff6b6b';
          densityValue.style.color = '#ff6b6b';
          densityNote.textContent = '(High density - elevated tendon stress)';
          densityNote.style.color = '#ff6b6b';
        } else if(densityFactor >= 1.15) {
          densityDisplay.style.borderColor = '#ffbb33';
          densityValue.style.color = '#ffbb33';
          densityNote.textContent = '(Moderate density)';
          densityNote.style.color = '#ffbb33';
        } else {
          densityDisplay.style.borderColor = '#00ffb3';
          densityValue.style.color = '#00ffb3';
          densityNote.textContent = '(Low density - adequate rest)';
          densityNote.style.color = '#00ffb3';
        }
        
        densityDisplay.style.display = 'block';
      } else {
        densityDisplay.style.display = 'none';
      }
    };
    
    flightInput.addEventListener('input', updateRSI);
    contactInput.addEventListener('input', () => {
      updateRSI();
      updateDensity();
    });
    restInput.addEventListener('input', updateDensity);
    
    // Trigger on load if data exists
    if(data.flightTime && data.contactTime) updateRSI();
    if(data.contactTime && data.restTime) updateDensity();
  }
  
  function toggleExerciseFields(selectEl){
    const parent = selectEl.closest('.sec');
    const type = selectEl.value;
    
    const bilateralFields = parent.querySelectorAll('.bilateralFields');
    const unilateralFields = parent.querySelectorAll('.unilateralFields');
    
    if(type === 'bilateral') {
      bilateralFields.forEach(f => f.style.display = 'block');
      unilateralFields.forEach(f => f.style.display = 'none');
    } else {
      bilateralFields.forEach(f => f.style.display = 'none');
      unilateralFields.forEach(f => f.style.display = 'block');
    }
  }
  
  function collectTrack(){
    if(!document.getElementById('mTrack').checked) return null;
    
    const warmupChecks = [...document.querySelectorAll('.warmupCheck')].map(cb => cb.checked);
    
    const exercises = [...document.querySelectorAll('#trackExercises .sec')].map(exDiv => {
      const name = exDiv.querySelector('.exName').value;
      const type = exDiv.querySelector('.exType').value;
      const sets = fmt(exDiv.querySelector('.exSets').value);
      const rpe = fmt(exDiv.querySelector('.exRPE').value);
      const time = exDiv.querySelector('.exTime').value;
      const notes = exDiv.querySelector('.exNotes').value;
      
      // GOD-MODE: RSI data collection
      const flightTime = fmt(exDiv.querySelector('.exFlightTime').value);
      const contactTime = fmt(exDiv.querySelector('.exContactTime').value);
      const restTime = fmt(exDiv.querySelector('.exRest').value);
      
      let totalReps = 0;
      const ex = { name, type, sets, rpe, time, notes };
      
      // Add RSI if both values present
      if(flightTime > 0 && contactTime > 0) {
        ex.flightTime = flightTime;
        ex.contactTime = contactTime;
        ex.rsi = (flightTime / contactTime).toFixed(2);
      }
      
      // GOD-MODE: Calculate Density Factor
      if(contactTime > 0 && restTime > 0) {
        ex.restTime = restTime;
        const contactSec = contactTime / 1000;
        const ratio = contactSec / restTime;
        let densityFactor = 1.0 + (Math.min(ratio, 0.05) / 0.05) * 0.4;
        ex.densityFactor = Math.min(1.4, Math.max(1.0, densityFactor));
      } else {
        ex.densityFactor = 1.0; // Default if not specified
      }
      
      if(type === 'bilateral') {
        const reps = fmt(exDiv.querySelector('.exReps').value);
        ex.reps = reps;
        totalReps = sets * reps;
      } else {
        const repsRight = fmt(exDiv.querySelector('.exRepsRight').value);
        const repsLeft = fmt(exDiv.querySelector('.exRepsLeft').value);
        ex.repsRight = repsRight;
        ex.repsLeft = repsLeft;
        totalReps = sets * (repsRight + repsLeft);
      }
      
      ex.totalReps = totalReps;
      return ex;
    }).filter(ex => ex.name && ex.sets > 0);
    
    if(!exercises.length) return null;
    
    // Get surface type
    const surface = document.getElementById('trkSurface')?.value || 'track';
    const surfaceFactor = { turf: 0.9, track: 1.1, concrete: 1.4 }[surface] || 1.1;
    
    // Get Achilles state
    const achState = trkAch.value || 'Fresh';
    const tendonFactor = { Fresh: 1.0, Tight: 1.2, Sore: 1.5 }[achState] || 1.0;
    
    // Calculate tendon load with impact coefficients AND surface/tendon/density factors (UFC PI)
    let tendonLoad = 0;
    let avgDensityFactor = 0;
    let densityCount = 0;
    
    exercises.forEach(ex => {
      const impactCoef = getImpactCoefficient(ex.name);
      const density = ex.densityFactor || 1.0;
      tendonLoad += ex.totalReps * impactCoef * surfaceFactor * tendonFactor * density;
      
      if(ex.densityFactor) {
        avgDensityFactor += ex.densityFactor;
        densityCount++;
      }
    });
    
    avgDensityFactor = densityCount > 0 ? (avgDensityFactor / densityCount).toFixed(2) : 1.0;
    
    const totalContacts = exercises.reduce((sum, ex) => sum + ex.totalReps, 0);
    const avgRPE = exercises.filter(ex=>ex.rpe>0).reduce((s,ex)=>s+ex.rpe,0) / exercises.filter(ex=>ex.rpe>0).length || 0;
    
    let cns=35 + (fmt(trkSleep.value)<7?12:0) + (trkAch.value==='Sore'?25:trkAch.value==='Tight'?12:0);
    if(tendonLoad>350) cns+=15; // Use tendon load instead of raw contacts
    if(avgRPE>=9) cns+=20;
    else if(avgRPE>=8) cns+=12;
    else if(avgRPE>=7) cns+=8;
    
    // Apply UFC PI modality weighting
    cns = applyModalityWeight(cns, 'plyo'); // Plyometrics = 0.75
    
    const tss = Math.round(60 + tendonLoad*0.12 + (avgRPE*5));
    const hr={
      avg:fmt(trkAvgHR.value),
      peak:fmt(trkPeakHR.value),
      z5:fmt(trkZ5.value),
      z4:fmt(trkZ4.value),
      dfa:fmt(document.getElementById('trkDFA')?.value) // GOD-MODE: DFA-Œ±1
    };
    
    // GOD-MODE: Check for DFA-Œ±1 warning (autonomic overtraining)
    let dfaWarning = false;
    if(hr.dfa > 0 && hr.dfa < 0.75 && avgRPE < 7) {
      dfaWarning = true; // Low DFA during easy work = overtraining
    }
    
    // Add HR Zone TSS if available
    const hrTSS = calculateHRZoneTSS(hr);
    const finalTSS = hrTSS > 0 ? Math.round((tss + hrTSS) / 2) : tss;
    
    // GOD-MODE: Calculate average RSI
    const rsiExercises = exercises.filter(ex => ex.rsi);
    const avgRSI = rsiExercises.length > 0 
      ? (rsiExercises.reduce((s, ex) => s + parseFloat(ex.rsi), 0) / rsiExercises.length).toFixed(2)
      : null;
    
    return {
      sleep:fmt(trkSleep.value), 
      ach:trkAch.value,
      surface,
      warmupChecks, 
      exercises,
      contacts:totalContacts,
      tendonLoad: Math.round(tendonLoad),
      avgRPE,
      avgRSI, // GOD-MODE: Average RSI
      avgDensityFactor, // GOD-MODE: Average Density Factor
      dfaWarning, // GOD-MODE: DFA-Œ±1 autonomic warning
      cnsScore:clamp(cns,0,100), 
      tss: finalTSS, 
      hr
    };
  }

  const bikeProto=document.getElementById('bikeProto');
  const bikeTarget=document.getElementById('bikeTarget');
  const bikeRounds=document.getElementById('bikeRounds');
  const bikeWork=document.getElementById('bikeWork');
  const bikeRest=document.getElementById('bikeRest');
  const bikeSleep=document.getElementById('bikeSleep');
  const bikeCap=document.getElementById('bikeCap');
  const roundBlock=document.getElementById('roundBlock');
  const workBlock=document.getElementById('workBlock');
  const restBlock=document.getElementById('restBlock');
  const timeCapBlock=document.getElementById('timeCapBlock');
  const c2Buttons=document.getElementById('c2Buttons');

  function resetBike(){
    bikeProto.value='peak'; bikeRounds.value=6; bikeWork.value=20; bikeRest.value=100; bikeTarget.value=''; bikeSleep.value='';
    document.querySelector('#bikeTable tbody').innerHTML='';
    seedBikeRows();
    document.getElementById('bikePrev').innerHTML='No image';
    if(document.getElementById('bikeTotalTime')) document.getElementById('bikeTotalTime').value = '';
    applyBikeUI();
    updateProtocolInstructions();
  }
  
  function hydrateBike(d){ 
    resetBike(); 
    if(!d) return;
    bikeProto.value=d.proto || 'peak'; 
    applyBikeUI();
    updateProtocolInstructions();
    if(d.proto==='c2'){ bikeCap.value=d.cap||25; }
    else { bikeRounds.value=d.rounds; bikeWork.value=d.work; bikeRest.value=d.rest; }
    bikeTarget.value=d.target; bikeSleep.value=d.sleep||'';
    if(d.totalTime && document.getElementById('bikeTotalTime')) {
      document.getElementById('bikeTotalTime').value = d.totalTime;
    }
    const tb=document.querySelector('#bikeTable tbody'); 
    tb.innerHTML=''; 
    (d.roundData||[]).forEach(r=>addBikeRow(r));
  }
  
  function seedBikeRows(){ 
    const r=fmt(bikeRounds.value)||6; 
    const tb=document.querySelector('#bikeTable tbody'); 
    tb.innerHTML='';
    for(let i=1;i<=r;i++) addBikeRow({}); 
  }
  
  bikeRounds?.addEventListener('change',()=>{ if(bikeProto.value!=='c2') seedBikeRows(); });
  bikeProto?.addEventListener('change',applyBikeUI);
  
  function updateProtocolInstructions(){
    const protocol = bikeProto.value;
    const instructionsEl = document.getElementById('protocolInstructions');
    if(!instructionsEl) return;
    
    const instructions = {
      'c1': `<b>C1 ‚Äî Max RPM per round (Speed Test)</b><br><br>
        <b>Goal:</b> Hit your MAX RPM in the SHORTEST amount of time possible<br>
        <b>Intensity:</b> MAX EFFORT - all-out sprint<br>
        <b>What it tests:</b> Explosive power and acceleration capacity<br>
        <b>How to do it:</b><br>
        1. Sprint as hard as possible to reach max RPM<br>
        2. Once you hit max RPM, stop<br>
        3. Rest 2 minutes (active recovery - easy pedaling)<br>
        4. Repeat<br>
        <b>Track:</b> Max RPM achieved and time to reach it<br>
        <b>Success:</b> Reaching max RPM faster over time, or hitting higher max RPM<br>
        <b>Rest:</b> 2 minutes active recovery between sprints`,
        
      'c2': `<b>C2 ‚Äî Max RPM ‚Üí Zone 5 Hold ‚Üí Stop</b><br><br>
        <b>What it is:</b> Sprint to max, downshift to sustain Zone 5+, then stop and recover<br>
        <b>Intensity:</b> Zone 5+ (90%+ max HR) - sustained after initial sprint<br>
        <b>What it tests:</b> Anaerobic capacity and heart rate recovery<br>
        <b>How to do it:</b><br>
        1. Sprint to absolute max RPM<br>
        2. ONCE max RPM is achieved, downshift to a speed you can SUSTAIN<br>
        3. Hold that sustainable pace to keep HR at Zone 5+ (90%+ max HR)<br>
        4. STOP completely when you can't maintain Zone 5 (90%+ HR)<br>
        5. Rest until HR drops to Zone 2 OR 3 minutes (WHICHEVER COMES FIRST)<br>
        6. Repeat<br>
        <b>Target HR Field:</b> Shows 90 (meaning 90% of max HR = Zone 5)<br>
        <b>Track:</b> Max RPM, Time in Zone 5, Total rep time, Time to Zone 2<br>
        <b>‚ö†Ô∏è This is the ONLY protocol where you STOP during rest - don't pedal!</b><br>
        <b>Key:</b> The downshift lets you sustain Z5 longer than staying at max RPM`,
        
      'c3': `<b>C3 ‚Äî Alternating Max Effort / Submaximal (30s Hold)</b><br><br>
        <b>What it is:</b> Alternate between all-out sprints and 70% sustained efforts<br>
        <b>Intensity:</b> MAX EFFORT on sprint reps, 70% effort on submaximal reps<br>
        <b>What it tests:</b> Power output variance and recovery between different intensities<br>
        <b>How to do it:</b><br>
        <b>Rep 1 (ALL OUT):</b><br>
        ‚Ä¢ Sprint to absolute max RPM (MAX EFFORT)<br>
        ‚Ä¢ Rest 3 minutes (active recovery - easy pedaling)<br>
        <b>Rep 2 (70% for 30 seconds):</b><br>
        ‚Ä¢ 70% of max RPM (or preferred pace) held for 30 seconds<br>
        ‚Ä¢ Rest 3 minutes (active recovery - easy pedaling)<br>
        <b>Rep 3 (ALL OUT):</b><br>
        ‚Ä¢ Sprint to absolute max RPM again<br>
        ‚Ä¢ Rest 3 minutes<br>
        <b>Rep 4 (70% for 30 seconds):</b><br>
        ‚Ä¢ 70% held for 30 seconds<br>
        ‚Ä¢ Rest 3 minutes<br>
        <b>Continue alternating...</b><br>
        <b>Rest:</b> 3 minutes after EACH rep (both max and 70%)<br>
        <b>Track:</b> Max RPM on all-out reps, consistency on 70% reps`,
        
      'steady': `<b>Steady Zone 2 (Aerobic Base)</b><br><br>
        <b>What it is:</b> Sustained 20-40min at 130-150 BPM (Zone 2)<br>
        <b>Intensity:</b> 130-150 BPM (Zone 2) - easy, conversational pace<br>
        <b>Goal:</b> Build aerobic base and fat oxidation capacity<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Mitochondrial density<br>
        ‚Ä¢ Fat metabolism<br>
        ‚Ä¢ Recovery capacity<br>
        ‚Ä¢ Cardiac efficiency<br>
        <b>How to do it:</b> Maintain steady 130-150 BPM for entire duration. Should feel conversational - you can talk in full sentences.<br>
        <b>Target HR:</b> Keep heart rate between 130-150 BPM throughout (NOT a percentage - actual BPM range)<br>
        <b>When to use:</b> Recovery days, aerobic base building phases, active recovery between hard sessions`,
        
      'alt': `<b>Alt 30s Hard / 30s Easy</b><br><br>
        <b>What it is:</b> Alternate hard/easy every 30 seconds for 6-10 rounds<br>
        <b>Intensity:</b> 80-85% max HR during hard intervals<br>
        <b>Goal:</b> Classic HIIT conditioning<br>
        <b>What it develops:</b> Cardiovascular fitness, work capacity, mental toughness<br>
        <b>How to do it:</b><br>
        ‚Ä¢ 30s: Hard effort (80-85% max HR)<br>
        ‚Ä¢ 30s: Easy pedaling (active recovery)<br>
        ‚Ä¢ Repeat for 6-10 rounds<br>
        <b>Target HR Field:</b> Shows 82 (meaning 82% of max HR during hard intervals)<br>
        <b>‚ö†Ô∏è "Easy" means EASY PEDALING, not stopping!</b><br>
        <b>Tip:</b> Keep your hard efforts consistent - don't blow out on round 1`,
        
      'z5': `<b>Zone 5 Intervals</b><br><br>
        <b>What it is:</b> Push into 90%+ max HR, recover fully between intervals<br>
        <b>Intensity:</b> 90%+ max HR (Zone 5) during work intervals<br>
        <b>Goal:</b> Improve VO2 max and anaerobic threshold<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Maximum oxygen uptake<br>
        ‚Ä¢ Anaerobic threshold<br>
        ‚Ä¢ High-end cardiovascular capacity<br>
        <b>How to do it:</b><br>
        1. Push HR to 90%+ of max (Zone 5)<br>
        2. Hold for prescribed work time<br>
        3. Easy pedaling until HR drops to recovery zone<br>
        4. Repeat<br>
        <b>Target HR Field:</b> Shows 92 (meaning 92% of max HR = Zone 5)<br>
        <b>Rest:</b> Active recovery until HR recovers - typically 1.5-2x work time`,
        
      'peak': `<b>Peak RPM Sprints</b><br><br>
        <b>What it is:</b> Short max-effort bursts with full recovery<br>
        <b>Intensity:</b> MAX EFFORT - all-out sprints<br>
        <b>Goal:</b> Develop peak power output and ATP-PC energy system<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Maximum power output<br>
        ‚Ä¢ Fast-twitch muscle fiber recruitment<br>
        ‚Ä¢ Neural drive<br>
        ‚Ä¢ Explosive capacity<br>
        <b>How to do it:</b><br>
        ‚Ä¢ Work: 10-20 seconds ABSOLUTE MAX effort<br>
        ‚Ä¢ Rest: 1.5-2 minutes easy pedaling (full recovery)<br>
        ‚Ä¢ 6-10 rounds<br>
        <b>Key:</b> Each rep should be MAXIMUM quality. If power drops significantly, you need more rest.`,
        
      'ngannou': `<b>ü•ä Ngannou Power (UFC PI Protocol)</b><br><br>
        <b>What it is:</b> 10 rounds of 30s all-out / 30s active recovery<br>
        <b>Intensity:</b> ALL-OUT maximum effort - aim for consistency across all rounds<br>
        <b>Goal:</b> Maintain SAME power output all 10 rounds without decay<br>
        <b>What it tests:</b> Ability to produce high force repeatedly (fight simulation)<br>
        <b>How to do it:</b><br>
        1. 30 seconds: ALL-OUT maximum effort<br>
        2. 30 seconds: EASY PEDALING (active recovery - DON'T STOP!)<br>
        3. Repeat for 10 total rounds<br>
        <b>Success metric:</b> Calories & watts should be consistent across all 10 rounds. If round 10 drops significantly below round 1, you went too hard early.<br>
        <b>‚ö†Ô∏è Keep pedaling lightly during "rest" - stopping causes blood pooling!</b><br>
        <b>Used by:</b> Francis Ngannou at UFC Performance Institute`,
        
      'progressive': `<b>üìà Progressive Calorie (UFC PI Protocol)</b><br><br>
        <b>What it is:</b> Single 5-minute continuous effort<br>
        <b>Intensity:</b> 75-80% max HR - sustained moderate-hard effort<br>
        <b>Goal:</b> Hit target calories, increase 3-4 cals/week<br>
        <b>What it develops:</b> Sustained aerobic power, progressive overload<br>
        <b>How to do it:</b><br>
        Week 1: 65 calories in 5 minutes (75-80% max HR)<br>
        Week 2: 68-69 calories in 5 minutes<br>
        Week 3: 71-73 calories in 5 minutes<br>
        Continue adding 3-4 cals/week<br>
        <b>Target HR Field:</b> Shows 78 (meaning 78% of max HR - sustained effort)<br>
        <b>Key:</b> Pace yourself to hit the target - don't sprint and fade. Smooth, sustained effort for full 5 minutes.<br>
        <b>No stopping</b> - continuous pedaling for entire 5 minutes`,
        
      'extended': `<b>‚è±Ô∏è Extended Capacity (UFC PI Protocol)</b><br><br>
        <b>What it is:</b> 6 rounds of 5min continuous / 2min active recovery<br>
        <b>Intensity:</b> 75-80% max HR - moderate-hard sustained effort<br>
        <b>Goal:</b> Simulate extended fight rounds, build mental toughness<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Sustained work capacity<br>
        ‚Ä¢ Mental toughness under fatigue<br>
        ‚Ä¢ Ability to maintain output in later rounds<br>
        <b>How to do it:</b><br>
        ‚Ä¢ 5 minutes: Moderate-hard continuous effort at 75-80% max HR<br>
        ‚Ä¢ 2 minutes: EASY PEDALING (active recovery - don't stop!)<br>
        ‚Ä¢ Repeat 6 times<br>
        <b>Target HR Field:</b> Shows 78 (meaning 78% of max HR during 5min work periods)<br>
        <b>Strategy:</b> Find a pace you can maintain for all 6 rounds. Round 6 should look like round 1.<br>
        <b>‚ö†Ô∏è Keep moving during 2min recovery periods!</b>`,
        
      'tabata': `<b>‚ö° Tabata (UFC PI Protocol)</b><br><br>
        <b>What it is:</b> 8 rounds of 20s max / 10s active recovery (4min total)<br>
        <b>Intensity:</b> MAX EFFORT - will hit 95%+ max HR<br>
        <b>Goal:</b> Anaerobic conditioning and EPOC (after-burn effect)<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Anaerobic capacity<br>
        ‚Ä¢ VO2 max<br>
        ‚Ä¢ Post-exercise calorie burn (EPOC)<br>
        <b>How to do it:</b><br>
        1. 20 seconds: MAXIMUM effort (will reach 95%+ max HR)<br>
        2. 10 seconds: EASY PEDALING (active recovery - don't stop!)<br>
        3. Repeat 8 times (4 minutes total)<br>
        <b>It should hurt:</b> This is SUPPOSED to be brutal. By round 6-7 you should be struggling.<br>
        <b>‚ö†Ô∏è Keep pedaling lightly during 10s "rest" - don't stop!<br>
        <b>Classic research protocol</b> proven to improve both aerobic and anaerobic systems`,
        
      'sprints': `<b>üí® Power Sprints (UFC PI Protocol)</b><br><br>
        <b>What it is:</b> 10s max effort / 50s active recovery for 6-10 rounds<br>
        <b>Intensity:</b> MAX EFFORT - ATP-PC system (explosive)<br>
        <b>Goal:</b> Develop ATP-PC energy system and peak power<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Explosive power<br>
        ‚Ä¢ Fast-twitch fiber recruitment<br>
        ‚Ä¢ ATP-PC system (phosphagen)<br>
        ‚Ä¢ Neural drive<br>
        <b>How to do it:</b><br>
        1. 10 seconds: ABSOLUTE MAXIMUM sprint<br>
        2. 50 seconds: EASY PEDALING (active recovery)<br>
        3. Repeat 6-10 times<br>
        <b>Power requirements:</b><br>
        ‚Ä¢ Men: 1000+ watts for effectiveness<br>
        ‚Ä¢ Women: 650+ watts for effectiveness<br>
        <b>If below these numbers:</b> Build absolute strength first - this protocol won't be effective<br>
        <b>‚ö†Ô∏è Easy pedaling during rest allows better recovery for next max sprint!</b>`
    };
    
    instructionsEl.innerHTML = instructions[protocol] || 'Select a protocol to see detailed instructions...';
  }
  
  function applyBikeUI(){
    const p=bikeProto.value;
    
    // Update protocol instructions
    updateProtocolInstructions();
    
    // Protocol-specific configurations
    const configs = {
      'c1': { rounds: 6, work: 0, rest: 120, showWork: false, showRest: false, showCap: false, targetHR: '', hrNote: 'Max effort' },
      'c2': { rounds: 0, work: 0, rest: 0, showWork: false, showRest: false, showCap: true, targetHR: '90', hrNote: 'Zone 5+ (90%+ max HR)' },
      'c3': { rounds: 6, work: 0, rest: 180, showWork: false, showRest: false, showCap: false, targetHR: '', hrNote: 'Max effort (all-out reps)' },
      'steady': { rounds: 1, work: 1800, rest: 0, showWork: true, showRest: false, showCap: false, targetHR: '', hrNote: '130-150 BPM (Zone 2)' },
      'alt': { rounds: 10, work: 30, rest: 30, showWork: true, showRest: true, showCap: false, targetHR: '82', hrNote: '80-85% max HR during hard intervals' },
      'z5': { rounds: 6, work: 60, rest: 120, showWork: true, showRest: true, showCap: false, targetHR: '92', hrNote: '90%+ max HR (Zone 5)' },
      'peak': { rounds: 6, work: 20, rest: 100, showWork: true, showRest: true, showCap: false, targetHR: '', hrNote: 'Max effort' },
      'ngannou': { rounds: 10, work: 30, rest: 30, showWork: true, showRest: true, showCap: false, targetHR: '', hrNote: 'All-out max effort (aim for consistency)' },
      'progressive': { rounds: 1, work: 300, rest: 0, showWork: true, showRest: false, showCap: false, targetHR: '78', hrNote: '75-80% max HR (sustained)' },
      'extended': { rounds: 6, work: 300, rest: 120, showWork: true, showRest: true, showCap: false, targetHR: '78', hrNote: '75-80% max HR (moderate-hard)' },
      'tabata': { rounds: 8, work: 20, rest: 10, showWork: true, showRest: true, showCap: false, targetHR: '', hrNote: 'Max effort (will hit 95%+)' },
      'sprints': { rounds: 10, work: 10, rest: 50, showWork: true, showRest: true, showCap: false, targetHR: '', hrNote: 'Max effort (ATP-PC system)' }
    };
    
    const config = configs[p] || configs['peak'];
    const capMode = config.showCap;
    
    // Set values ACCURATELY for each protocol
    if(config.rounds > 0) bikeRounds.value = config.rounds;
    if(config.work > 0) bikeWork.value = config.work;
    else if(!config.showWork) bikeWork.value = '';
    if(config.rest > 0) bikeRest.value = config.rest;
    else if(!config.showRest) bikeRest.value = '';
    
    // Set ACCURATE Target HR for each protocol
    if(bikeTarget) {
      bikeTarget.value = config.targetHR;
      
      // Update Target HR placeholder based on protocol
      if(p === 'steady') {
        bikeTarget.placeholder = '130-150 BPM';
        bikeTarget.type = 'text';
      } else if(config.targetHR === '') {
        bikeTarget.placeholder = 'Max effort';
        bikeTarget.type = 'text';
      } else {
        bikeTarget.placeholder = '% of max HR';
        bikeTarget.type = 'number';
      }
    }
    
    // Show/hide fields based on protocol
    if(document.getElementById('timeCapBlock')) {
      document.getElementById('timeCapBlock').style.display = capMode ? 'block':'none';
    }
    if(document.getElementById('roundBlock')) {
      document.getElementById('roundBlock').style.display = (capMode || !config.rounds) ? 'none':'block';
    }
    if(document.getElementById('workBlock')) {
      document.getElementById('workBlock').style.display = config.showWork ? 'block':'none';
    }
    if(document.getElementById('restBlock')) {
      document.getElementById('restBlock').style.display = config.showRest ? 'block':'none';
    }
    if(document.getElementById('c2Buttons')) {
      document.getElementById('c2Buttons').style.display = capMode ? 'flex':'none';
    }
    
    // Update Target HR field label based on protocol
    const targetLabel = document.getElementById('bikeTargetLabel');
    if(targetLabel && config.hrNote) {
      targetLabel.innerHTML = `Target HR <span class="muted sm" style="font-weight:normal">(${config.hrNote})</span>`;
    } else if(targetLabel) {
      targetLabel.innerHTML = 'Target HR';
    }
    
    // Update hints text
    const hintsText = document.getElementById('hintsText');
    const hints = {
      'c1': `<b>C1:</b> "Rounds" = # of max RPM sprints. Work/Rest times hidden (sprint to max + 2min rest each round). <b>Intensity:</b> Max effort.`,
      'c2': `<b>C2:</b> "Time Cap" = session limit. Track reps with "+ Add Rep". Work/Rest times hidden (varies per rep). <b>Target HR:</b> 90% = Zone 5+ during sustained phase.`,
      'c3': `<b>C3:</b> "Rounds" = total reps (alternates max/70%). Work/Rest hidden (max + 3min, then 70% for 30s + 3min). <b>Intensity:</b> Max effort on sprint reps.`,
      'steady': `<b>Steady Z2:</b> Continuous session. "Work" = total duration (1800s = 30min). Rest hidden (no rest periods). <b>Target HR:</b> 130-150 BPM (NOT a % - actual BPM range).`,
      'alt': `<b>Alt 30s/30s:</b> All fields shown. Work = hard (30s), Rest = easy pedaling (30s). <b>Target HR:</b> 82% = 80-85% during hard intervals.`,
      'z5': `<b>Zone 5:</b> All fields shown. Work = Z5 time (60s), Rest = recovery (120s). <b>Target HR:</b> 92% = 90%+ max HR during work intervals.`,
      'peak': `<b>Peak RPM:</b> All fields shown. Work = sprint duration (20s), Rest = recovery (100s). <b>Intensity:</b> Max effort each rep.`,
      'ngannou': `<b>Ngannou:</b> 10 rounds fixed. Work = all-out (30s), Rest = easy pedaling (30s - NOT stopping!). <b>Intensity:</b> All-out, aim for consistency.`,
      'progressive': `<b>Progressive:</b> Single 5min effort. "Work" = 300s (5min). Rest hidden. <b>Target HR:</b> 78% = 75-80% sustained effort.`,
      'extended': `<b>Extended:</b> 6√ó5min rounds. Work = 300s (5min), Rest = 120s (2min easy pedaling). <b>Target HR:</b> 78% = 75-80% during work periods.`,
      'tabata': `<b>Tabata:</b> 8 rounds. Work = max effort (20s), Rest = easy pedaling (10s - NOT stopping!). <b>Intensity:</b> Max effort, will hit 95%+ HR.`,
      'sprints': `<b>Power Sprints:</b> Work = max sprint (10s), Rest = recovery (50s active pedaling). <b>Intensity:</b> Max effort (1000W+ men, 650W+ women).`
    };
    if(hintsText) hintsText.innerHTML = hints[p] || 'Protocol-specific fields shown above.';
    
    // Calculate and show total time
    calculateRoutineTime();
    
    const tb=document.querySelector('#bikeTable tbody');
    tb.innerHTML='';
    if(!capMode){ seedBikeRows(); }
  }
  
  function calculateRoutineTime(){
    const p = bikeProto.value;
    const totalTimeBlock = document.getElementById('totalTimeBlock');
    const routineTimeEl = document.getElementById('bikeRoutineTime');
    
    if(!totalTimeBlock || !routineTimeEl) return;
    
    let totalSeconds = 0;
    
    if(p === 'c1'){
      // C1: rounds √ó (sprint + 2min rest), minus last rest
      const rounds = fmt(bikeRounds.value) || 6;
      totalSeconds = rounds * (10 + 120) - 120; // assume 10s sprint + 2min rest
    } else if(p === 'c2'){
      // C2: time cap
      const cap = fmt(document.getElementById('bikeCap')?.value) || 25;
      totalSeconds = cap * 60;
    } else if(p === 'c3'){
      // C3: alternating rounds, each with 3min rest
      const rounds = fmt(bikeRounds.value) || 6;
      totalSeconds = rounds * (10 + 180) - 180; // assume 10s per rep + 3min rest
    } else if(p === 'steady' || p === 'progressive'){
      // Continuous work, no rest
      totalSeconds = fmt(bikeWork.value) || 0;
    } else {
      // Standard intervals: rounds √ó (work + rest), minus last rest
      const rounds = fmt(bikeRounds.value) || 6;
      const work = fmt(bikeWork.value) || 20;
      const rest = fmt(bikeRest.value) || 100;
      totalSeconds = (rounds * (work + rest)) - rest;
    }
    
    // Format time
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    routineTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Show the time block
    totalTimeBlock.style.display = 'block';
  }
  
  // Add listeners to recalculate time when values change
  if(bikeRounds) bikeRounds.addEventListener('input', calculateRoutineTime);
  if(bikeWork) bikeWork.addEventListener('input', calculateRoutineTime);
  if(bikeRest) bikeRest.addEventListener('input', calculateRoutineTime);
  if(document.getElementById('bikeCap')) document.getElementById('bikeCap').addEventListener('input', calculateRoutineTime);
  
  function addBikeRow(p){
    const tb=document.querySelector('#bikeTable tbody');
    const i=tb.children.length+1;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i}</td>
      <td><input type="number" class="rpmMax" value="${p.rpmMax||''}" style="width:70px"></td>
      <td><input type="number" class="rpmAvg" value="${p.rpmAvg||''}" style="width:70px"></td>
      <td><input type="number" class="cals" value="${p.cals||''}" style="width:60px"></td>
      <td><input type="number" class="watts" value="${p.watts||''}" style="width:70px"></td>
      <td><input type="number" class="tZ5" value="${p.tZ5||''}" style="width:80px"></td>
      <td><input type="number" class="tRep" value="${p.tRep||''}" style="width:90px"></td>
      <td><input type="number" class="tZ2" value="${p.tZ2||''}" style="width:80px"></td>
      <td><input type="number" step="0.01" class="hhr60" value="${p.hhr60||''}" style="width:70px" placeholder="0.45" title="Heart Rate Recovery 60s"></td>
      <td><input class="noteTxt" value="${p.note||''}" style="width:100px"></td>`;
    tb.appendChild(tr);
  }
  
  function collectBike(){
    if(!document.getElementById('mBike').checked) return null;
    const proto=bikeProto.value;
    const rows=[...document.querySelectorAll('#bikeTable tbody tr')];
    const rd=rows.map(tr=>({
      rpmMax:fmt(tr.querySelector('.rpmMax').value), 
      rpmAvg:fmt(tr.querySelector('.rpmAvg').value),
      cals:fmt(tr.querySelector('.cals')?.value),
      watts:fmt(tr.querySelector('.watts')?.value),
      tZ5:fmt(tr.querySelector('.tZ5').value), 
      tRep:fmt(tr.querySelector('.tRep').value), 
      tZ2:fmt(tr.querySelector('.tZ2').value),
      hhr60:fmt(tr.querySelector('.hhr60')?.value), // GOD-MODE: HHR60
      note:tr.querySelector('.noteTxt').value 
    }));

    let cns = 45 + (fmt(bikeSleep.value)<7?10:0);
    let tss = 0;
    
    // GOD-MODE: Track HHR60 for recovery quality
    const avgHHR60 = rd.filter(r=>r.hhr60>0).length > 0 
      ? rd.filter(r=>r.hhr60>0).reduce((s,r)=>s+r.hhr60,0) / rd.filter(r=>r.hhr60>0).length 
      : 0;
    
    // GOD-MODE: Calculate Banister TRIMP if HR data available
    const profile = LS.get('elite_profile', {});
    const bikeAvgHR = fmt(document.getElementById('bikeAvgHR')?.value);
    const totalTime = fmt(document.getElementById('bikeTotalTime')?.value);
    let banisterTRIMP = 0;
    if(bikeAvgHR && totalTime && profile.mhr && profile.rhr) {
      banisterTRIMP = calculateBanisterTRIMP(totalTime / 60, bikeAvgHR, profile);
    }

    if(proto==='c2'){
      const cap = fmt(bikeCap.value)||25;
      const totalWorkSec = rd.reduce((s,r)=>s+(r.tRep||0),0);
      const avgMax= rd.length? Math.round(rd.reduce((a,b)=>a+b.rpmMax,0)/rd.length) : 0;
      const z5Sec = rd.reduce((s,r)=>s + (r.tZ5>0 ? Math.max(0, Math.min(r.tRep, r.tRep - r.tZ5)) : 0), 0);
      tss = Math.round( (totalWorkSec/60)*90 + (z5Sec/60)*4 );
      if(z5Sec/60>15) cns+=15;
      
      // Apply UFC PI modality weighting - C2 is Zone 5 work
      cns = applyModalityWeight(cns, 'bike_z5'); // Zone-5 Chaser = 0.95
      
      const totalCals = rd.reduce((s,r)=>s+(r.cals||0),0);
      const avgWatts = rd.filter(r=>r.watts).length > 0 ? Math.round(rd.reduce((s,r)=>s+(r.watts||0),0)/rd.filter(r=>r.watts).length) : 0;
      const totalTimeVal = fmt(document.getElementById('bikeTotalTime')?.value);
      
      // GOD-MODE: RPM¬≥ power estimation if watts not directly measured
      const profile = LS.get('elite_profile', {});
      let estimatedPower = avgWatts;
      if(avgWatts === 0 && avgMax > 0) {
        estimatedPower = Math.round(rpmToPower(avgMax, profile.rpmK));
      }
      
      return {proto, cap, target:fmt(bikeTarget.value), sleep:fmt(bikeSleep.value), totalTime: totalTimeVal, roundData:rd, avgMax, totalCals, avgWatts, estimatedPower, avgHHR60: avgHHR60.toFixed(2), banisterTRIMP, cnsScore:clamp(cns,0,100), tss};
    }else{
      const rounds=fmt(bikeRounds.value)||rd.length||6;
      const avgMax = rd.length? Math.round(rd.reduce((a,b)=>a+b.rpmMax,0)/rd.length) : 0;
      tss = Math.round(rounds*(fmt(bikeWork.value)/60)*90);
      if(rounds>=10) cns+=15;
      
      // Determine if protocol is Zone 5 work or Zone 2
      const targetHR = fmt(bikeTarget.value);
      const isZone5 = targetHR >= 85 || proto.includes('z5') || proto.includes('tabata') || proto.includes('peak') || proto.includes('ngannou');
      const isZone2 = proto === 'steady' || targetHR < 75;
      
      if(isZone5) {
        cns = applyModalityWeight(cns, 'bike_z5'); // Zone 5 = 0.95
      } else if(isZone2) {
        cns = applyModalityWeight(cns, 'zone2'); // Zone 2 = 0.35
      } else {
        cns = applyModalityWeight(cns, 'bike_z5'); // Default to higher
      }
      
      const totalCals = rd.reduce((s,r)=>s+(r.cals||0),0);
      const avgWatts = rd.filter(r=>r.watts).length > 0 ? Math.round(rd.reduce((s,r)=>s+(r.watts||0),0)/rd.filter(r=>r.watts).length) : 0;
      const totalTimeVal = fmt(document.getElementById('bikeTotalTime')?.value);
      
      // GOD-MODE: RPM¬≥ power estimation if watts not directly measured
      const profile = LS.get('elite_profile', {});
      let estimatedPower = avgWatts;
      if(avgWatts === 0 && avgMax > 0) {
        estimatedPower = Math.round(rpmToPower(avgMax, profile.rpmK));
      }
      
      return {proto, rounds, work:fmt(bikeWork.value), rest:fmt(bikeRest.value), target:fmt(bikeTarget.value),
        sleep:fmt(bikeSleep.value), totalTime: totalTimeVal, roundData:rd, avgMax, totalCals, avgWatts, estimatedPower, avgHHR60: avgHHR60.toFixed(2), banisterTRIMP, cnsScore:clamp(cns,0,100), tss};
    }
  }

  function resetBJJ(){['bjjTime','bjjInt','bjjW1','bjjW2','bjjFeel','bjjSleep','bjjZ4','bjjZ5','bjjBursts'].forEach(id=>{const el=document.getElementById(id); if(el.tagName==='SELECT')el.value=''; else el.value='';});}
  function hydrateBJJ(d){
    resetBJJ(); 
    if(!d) return; 
    bjjTime.value=d.time||''; 
    bjjInt.value=d.intensity||''; 
    bjjW1.value=d.w1||''; 
    bjjW2.value=d.w2||''; 
    bjjFeel.value=d.feel||''; 
    bjjSleep.value=d.sleep||'';
    if(d.z4) document.getElementById('bjjZ4').value = d.z4;
    if(d.z5) document.getElementById('bjjZ5').value = d.z5;
    if(d.bursts) document.getElementById('bjjBursts').value = d.bursts;
  }
  function collectBJJ(){
    if(!document.getElementById('mBJJ').checked) return null;
    const time=fmt(bjjTime.value); if(!time) return null;
    const sweat=fmt(bjjW1.value)-fmt(bjjW2.value);
    
    // GOD-MODE: GlycoIndex calculation
    const z4Time = fmt(document.getElementById('bjjZ4')?.value) || 0;
    const z5Time = fmt(document.getElementById('bjjZ5')?.value) || 0;
    const bursts = fmt(document.getElementById('bjjBursts')?.value) || 0;
    const glycoIndex = z4Time + (2 * z5Time) + (0.5 * bursts);
    
    let cns=40+(sweat>=4?20:sweat>=3?10:0)+(bjjInt.value==='High'?15:0)+(bjjFeel.value==='Beat'?20:bjjFeel.value==='Tired'?12:0)+(fmt(bjjSleep.value)<7?10:0);
    
    // Add CNS from high glycolytic stress
    if(glycoIndex > 30) cns += 15;
    else if(glycoIndex > 20) cns += 10;
    
    // Apply UFC PI modality weighting
    cns = applyModalityWeight(cns, 'bjj'); // BJJ Live Rolling = 0.85
    
    const tss=Math.round(time*1.5+(bjjInt.value==='High'?30:0)+(glycoIndex*0.8));
    
    // GOD-MODE: Calculate rehydration needs
    const rehydration = sweat > 0 ? (sweat * 1.5 * 0.453592).toFixed(2) : 0; // Convert lb to L and apply 1.5x
    const sodiumNeeds = sweat > 0 ? Math.round((sweat * 0.453592) * 600) : 0; // 600mg per L
    
    return {
      time,
      intensity:bjjInt.value,
      w1:fmt(bjjW1.value),
      w2:fmt(bjjW2.value),
      feel:bjjFeel.value,
      sleep:fmt(bjjSleep.value),
      z4: z4Time,
      z5: z5Time,
      bursts,
      glycoIndex: Math.round(glycoIndex),
      rehydration,
      sodiumNeeds,
      cnsScore:clamp(cns,0,100),
      tss
    };
  }
  function resetWalk(){['wDur','wDist','wPace'].forEach(id=>document.getElementById(id).value=''); wTer.value='Flat'; wPur.value='Recovery';}
  function hydrateWalk(d){resetWalk(); if(!d) return; wDur.value=d.dur||''; wDist.value=d.dist||''; wPace.value=d.pace||''; wTer.value=d.ter||'Flat'; wPur.value=d.pur||'Recovery';}
  function collectWalk(){
    if(!document.getElementById('mWalk').checked) return null;
    const dur=fmt(wDur.value); 
    const tss=Math.round(dur*0.5); 
    let cns=10+(wTer.value==='Steep'?15:wTer.value==='Hills'?8:0);
    
    // Apply UFC PI modality weighting - Walking is recovery/Zone 2
    cns = applyModalityWeight(cns, 'zone2'); // Zone 2 = 0.35
    
    return {dur,dist:fmt(wDist.value),pace:fmt(wPace.value),ter:wTer.value,pur:wPur.value,cnsScore:clamp(cns,0,100),tss};
  }

  function previewImg(input, targetId){
    const box=document.getElementById(targetId);
    const f=input.files?.[0]; if(!f){box.textContent='No image';return}
    const reader=new FileReader(); reader.onload=()=>{box.innerHTML=`<img src="${reader.result}" alt="preview">`}; reader.readAsDataURL(f);
  }
  
  // UFC PI MODALITY WEIGHTING SYSTEM
  function applyModalityWeight(rawCNS, modality) {
    const weights = {
      strength: 1.0,    // Max Effort Strength = 1.0
      bike_z5: 0.95,    // Assault Bike Zone-5 Chaser = 0.95
      bjj: 0.85,        // BJJ Live Rolling = 0.85
      plyo: 0.75,       // Plyometrics (High Contacts) = 0.75
      zone2: 0.35       // Long Zone 2 = 0.35
    };
    return Math.round(rawCNS * (weights[modality] || 1.0));
  }
  
  // GOD-MODE: CP & W‚Ä≤ CALCULATION (SKIBA MODEL)
  function calculateCPandWPrime(test3, test5, test12) {
    const tests = [];
    if(test3) tests.push({ duration: 180, power: test3 });
    if(test5) tests.push({ duration: 300, power: test5 });
    if(test12) tests.push({ duration: 720, power: test12 });
    
    if(tests.length < 2) return null;
    
    // Linear regression: Work = CP √ó t + W‚Ä≤
    // Work = Power √ó time
    const n = tests.length;
    let sumT = 0, sumW = 0, sumTW = 0, sumT2 = 0;
    
    tests.forEach(t => {
      const time = t.duration;
      const work = t.power * time;
      sumT += time;
      sumW += work;
      sumTW += time * work;
      sumT2 += time * time;
    });
    
    const CP = (n * sumTW - sumT * sumW) / (n * sumT2 - sumT * sumT);
    const WPrime = (sumW - CP * sumT) / n;
    
    return {
      CP: Math.round(CP * 10) / 10,
      WPrime: Math.round(WPrime),
      tau: 316 // reconstitution time constant (default ~316s)
    };
  }
  
  // GOD-MODE: W‚Ä≤ DEPLETION/RECONSTITUTION TRACKING
  function trackWPrimeUsage(currentPower, CP, WPrime, currentWPrimeBalance, deltaTime) {
    // deltaTime in seconds
    if(currentPower > CP) {
      // Depletion: dW‚Ä≤/dt = -(P - CP)
      const depletion = (currentPower - CP) * deltaTime;
      return Math.max(0, currentWPrimeBalance - depletion);
    } else {
      // Reconstitution: dW‚Ä≤/dt = (W‚Ä≤_max - W‚Ä≤) / œÑ
      const tau = 316; // reconstitution time constant
      const reconstitution = ((WPrime - currentWPrimeBalance) / tau) * deltaTime;
      return Math.min(WPrime, currentWPrimeBalance + reconstitution);
    }
  }
  
  // GOD-MODE: RPM ‚Üí POWER CONVERSION
  function rpmToPower(rpm, k) {
    // P ‚âà k √ó RPM¬≥
    // Default k ‚âà 0.00025 (calibrate with one known reading)
    const kValue = k || 0.00025;
    return kValue * Math.pow(rpm, 3);
  }
  
  // UFC PI HR ZONE WEIGHTING FOR TSS
  function calculateHRZoneTSS(hrData) {
    if(!hrData || (!hrData.z5 && !hrData.z4)) return 0;
    
    const zoneWeights = {
      z1: 1.0,
      z2: 1.5,
      z3: 2.0,
      z4: 3.0,
      z5: 4.5
    };
    
    let tss = 0;
    // Minutes in Zone 5
    if(hrData.z5) tss += hrData.z5 * zoneWeights.z5;
    // Minutes in Zone 4
    if(hrData.z4) tss += hrData.z4 * zoneWeights.z4;
    
    return Math.round(tss);
  }
  
  // IMPACT COEFFICIENT FOR PLYOMETRICS
  function getImpactCoefficient(exerciseName) {
    const name = exerciseName.toLowerCase();
    
    // Depth Jumps / Stadium Stairs Explosive = 1.5+
    if(name.includes('depth') || name.includes('stair')) return 1.5;
    
    // Box Jumps / Drop Landing = 1.2
    if(name.includes('box') || name.includes('drop')) return 1.2;
    
    // Jump Rope / Fast Contacts = 0.8
    if(name.includes('rope') || name.includes('skip')) return 0.8;
    
    // Low Impact Bounding = 0.6
    if(name.includes('bound')) return 0.6;
    
    // Default = 1.0
    return 1.0;
  }

  function saveDay(){
    const day={modalities:{}};
    const chest=collectStrength('chestBox'); if(chest) day.modalities.chest=chest;
    const back=collectStrength('backBox'); if(back) day.modalities.back=back;
    const legs=collectStrength('legsBox'); if(legs) day.modalities.legs=legs;
    const track=collectTrack(); if(track) day.modalities.track=track;
    const bike=collectBike(); if(bike) day.modalities.bike=bike;
    const bjj=collectBJJ(); if(bjj) day.modalities.bjj=bjj;
    const walk=collectWalk(); if(walk) day.modalities.walking=walk;
    if(Object.keys(day.modalities).length===0){document.getElementById('saveNote').textContent='Select at least one modality.'; return}
    let CNS=0,VOL=0,TSS=0;
    Object.values(day.modalities).forEach(m=>{CNS+=fmt(m.cnsScore); VOL+=fmt(m.volume); TSS+=fmt(m.tss)});
    
    // Adjust TSS/CNS based on sport focus
    const profile = LS.get('elite_profile', {});
    const sportFocus = profile.sport || '';
    const adjustments = getAdjustmentFactors(sportFocus, day.modalities);
    
    CNS = Math.round(CNS * adjustments.cnsMultiplier);
    TSS = Math.round(TSS * adjustments.tssMultiplier);
    
    // GOD-MODE: Calculate CNS z-score normalization
    const cnsNormalized = normalizeCNSWithBaseline(CNS);
    
    day.totalCNS=CNS; 
    day.normalizedCNS=cnsNormalized.normalized;
    day.cnsZScore=cnsNormalized.zScore;
    day.cnsBaseline=cnsNormalized.baseline;
    day.totalVolume=VOL; 
    day.tss=TSS;
    store[curKey]=day; LS.set('elite_days',store);
    hist.push({d:curKey,tss:TSS}); if(hist.length>28) hist.shift(); LS.set('elite_tss',hist);
    setKPIs(day);
    document.getElementById('saveNote').textContent='Saved ‚úì';
    renderCal();
  }

  const weekModal=document.getElementById('weekModal');
  // GOD-MODE: Z5 SPIKE DETECTION (Week-over-week intensity monitoring)
  function analyzeZ5Spike() {
    // Compare this week's Z5 minutes vs last week
    const allDays = Object.keys(store).sort();
    const last14 = allDays.slice(-14);
    
    if(last14.length < 14) {
      return {
        hasData: false,
        spike: false,
        thisWeekZ5: 0,
        lastWeekZ5: 0,
        increasePercent: 0
      };
    }
    
    const lastWeek = last14.slice(0, 7);
    const thisWeek = last14.slice(7, 14);
    
    let lastWeekZ5 = 0;
    let thisWeekZ5 = 0;
    
    lastWeek.forEach(key => {
      const day = store[key];
      if(day?.modalities) {
        if(day.modalities.track?.hr?.z5) lastWeekZ5 += day.modalities.track.hr.z5;
        if(day.modalities.bike?.proto === 'c2') {
          const rd = day.modalities.bike.roundData || [];
          lastWeekZ5 += rd.reduce((s,r)=>s+(r.tZ5>0 ? Math.max(0, Math.min(r.tRep, r.tRep - r.tZ5)) / 60 : 0), 0);
        }
        if(day.modalities.bjj?.z5) lastWeekZ5 += day.modalities.bjj.z5;
      }
    });
    
    thisWeek.forEach(key => {
      const day = store[key];
      if(day?.modalities) {
        if(day.modalities.track?.hr?.z5) thisWeekZ5 += day.modalities.track.hr.z5;
        if(day.modalities.bike?.proto === 'c2') {
          const rd = day.modalities.bike.roundData || [];
          thisWeekZ5 += rd.reduce((s,r)=>s+(r.tZ5>0 ? Math.max(0, Math.min(r.tRep, r.tRep - r.tZ5)) / 60 : 0), 0);
        }
        if(day.modalities.bjj?.z5) thisWeekZ5 += day.modalities.bjj.z5;
      }
    });
    
    const increasePercent = lastWeekZ5 > 0 ? ((thisWeekZ5 - lastWeekZ5) / lastWeekZ5) * 100 : 0;
    const hasSpike = increasePercent > 50;
    
    return {
      hasData: true,
      spike: hasSpike,
      thisWeekZ5: Math.round(thisWeekZ5),
      lastWeekZ5: Math.round(lastWeekZ5),
      increasePercent: increasePercent.toFixed(1)
    };
  }
  
  // GOD-MODE: RSI DECLINE DETECTION (Reactive Strength Index monitoring)
  function analyzeRSIDecline() {
    // Check last 21 days for RSI trend and decline
    const recentDays = Object.keys(store).sort().slice(-21);
    const rsiData = [];
    
    recentDays.forEach(key => {
      const day = store[key];
      if(day?.modalities?.track?.avgRSI) {
        rsiData.push({
          date: key,
          rsi: parseFloat(day.modalities.track.avgRSI)
        });
      }
    });
    
    if(rsiData.length < 3) {
      return {
        hasData: false,
        decline: false,
        currentRSI: 0,
        avgRSI: 0,
        declinePercent: 0
      };
    }
    
    const avgRSI = rsiData.reduce((s,d)=>s+d.rsi,0) / rsiData.length;
    const currentRSI = rsiData[rsiData.length - 1].rsi;
    const declinePercent = ((avgRSI - currentRSI) / avgRSI) * 100;
    
    // Alert if RSI drops > 10% vs 21-day mean
    const hasDecline = declinePercent > 10;
    
    return {
      hasData: true,
      decline: hasDecline,
      currentRSI: currentRSI.toFixed(2),
      avgRSI: avgRSI.toFixed(2),
      declinePercent: declinePercent.toFixed(1),
      rsiData
    };
  }
  
  // GOD-MODE: SLEEP PATTERN TRACKING (Multi-day monitoring)
  function analyzeSleepPattern() {
    // Check last 7 days for consecutive poor sleep (<6h)
    const recentDays = Object.keys(store).sort().slice(-7);
    const sleepData = [];
    let consecutivePoorSleep = 0;
    let maxConsecutivePoorSleep = 0;
    let totalPoorSleepNights = 0;
    
    recentDays.forEach(key => {
      const day = store[key];
      let daySleep = 0;
      
      // Check all modalities for sleep data
      if(day?.modalities) {
        Object.values(day.modalities).forEach(mod => {
          if(mod.sleep && mod.sleep > 0) {
            daySleep = Math.max(daySleep, mod.sleep);
          }
        });
      }
      
      sleepData.push({ date: key, hours: daySleep });
      
      if(daySleep > 0 && daySleep < 6) {
        consecutivePoorSleep++;
        totalPoorSleepNights++;
        maxConsecutivePoorSleep = Math.max(maxConsecutivePoorSleep, consecutivePoorSleep);
      } else if(daySleep >= 6) {
        consecutivePoorSleep = 0;
      }
    });
    
    const avgSleep = sleepData.filter(s=>s.hours>0).length > 0
      ? sleepData.filter(s=>s.hours>0).reduce((a,b)=>a+b.hours,0) / sleepData.filter(s=>s.hours>0).length
      : 0;
    
    return {
      maxConsecutive: maxConsecutivePoorSleep,
      totalPoorNights: totalPoorSleepNights,
      avgSleep: avgSleep.toFixed(1),
      hasAlert: maxConsecutivePoorSleep >= 2,
      sleepData
    };
  }
  
  // GOD-MODE: Z-SCORE NORMALIZATION FOR CNS
  function calculateZScore(value, historicalValues) {
    // Normalize value to z-score based on historical data
    // z = (x - Œº) / œÉ
    
    if(!historicalValues || historicalValues.length < 7) {
      // Not enough data for normalization
      return value / 100; // Return as percentage
    }
    
    const mean = historicalValues.reduce((a,b)=>a+b,0) / historicalValues.length;
    const variance = historicalValues.reduce((a,b)=>a+Math.pow(b-mean,2),0) / historicalValues.length;
    const std = Math.sqrt(variance);
    
    if(std === 0) return 0; // No variance
    
    const zScore = (value - mean) / std;
    
    // Clamp z-score between -3 and 3 (99.7% of normal distribution)
    return Math.max(-3, Math.min(3, zScore));
  }
  
  function normalizeCNSWithBaseline(rawCNS) {
    // Get historical CNS scores from past 28 days
    const recentDays = Object.keys(store).sort().slice(-28);
    const historicalCNS = [];
    
    recentDays.forEach(key => {
      const day = store[key];
      if(day && day.totalCNS) {
        historicalCNS.push(fmt(day.totalCNS));
      }
    });
    
    if(historicalCNS.length < 7) {
      // Not enough baseline data, return raw CNS
      return {
        normalized: rawCNS,
        zScore: 0,
        baseline: rawCNS,
        hasBaseline: false
      };
    }
    
    const zScore = calculateZScore(rawCNS, historicalCNS);
    const baseline = historicalCNS.reduce((a,b)=>a+b,0) / historicalCNS.length;
    
    // Convert z-score back to 0-100 scale for display
    // z-score of 0 = baseline (50)
    // z-score of +2 = high stress (80)
    // z-score of -2 = low stress (20)
    const normalized = clamp(50 + (zScore * 15), 0, 100);
    
    return {
      normalized: Math.round(normalized),
      zScore: zScore.toFixed(2),
      baseline: Math.round(baseline),
      hasBaseline: true
    };
  }
  
  // GOD-MODE: BANISTER TRIMP (Exponential HR-based Internal Load)
  function calculateBanisterTRIMP(duration, hrAvg, profile) {
    // Banister TRIMP uses exponential weighting based on HR reserve
    // More accurate than simple zone weighting
    
    if(!hrAvg || !profile.mhr || !profile.rhr) return 0;
    
    const hrRest = profile.rhr || 60;
    const hrMax = profile.mhr || 190;
    
    // HR Reserve ratio
    const HRr = (hrAvg - hrRest) / (hrMax - hrRest);
    
    // Clamp HRr between 0 and 1
    const HRr_clamped = Math.max(0, Math.min(1, HRr));
    
    // Banister exponential coefficient
    // Male: e^(1.92 √ó HRr)
    // Female: e^(1.67 √ó HRr)
    const gender = profile.sex || 'Male';
    const coefficient = gender === 'Female' ? 1.67 : 1.92;
    
    // TRIMP = duration √ó HRr √ó e^(coefficient √ó HRr)
    const trimp = duration * HRr_clamped * Math.exp(coefficient * HRr_clamped);
    
    return Math.round(trimp);
  }
  
  // GOD-MODE: EWMA (Exponentially Weighted Moving Average) ACWR
  function calculateEWMA(data, lambda) {
    // lambda: smoothing factor (higher = more weight on recent data)
    // For 7-day acute: lambda ‚âà 0.2857 (2/(7+1))
    // For 28-day chronic: lambda ‚âà 0.0690 (2/(28+1))
    if(!data || data.length === 0) return 0;
    
    let ewma = data[0];
    for(let i = 1; i < data.length; i++) {
      ewma = lambda * data[i] + (1 - lambda) * ewma;
    }
    return ewma;
  }
  
  function calculateEWMAACWR(hist) {
    if(hist.length < 14) return { ac: '‚Äî', warn: false, acute: 0, chronic: 0 };
    
    // Get TSS values from history
    const tssData = hist.map(h => fmt(h.tss));
    
    // Calculate EWMA for last 7 days (Acute)
    const last7 = tssData.slice(-7);
    const acute = calculateEWMA(last7, 2 / (7 + 1));
    
    // Calculate EWMA for last 28 days (Chronic)
    const last28 = tssData.slice(-28);
    const chronic = calculateEWMA(last28, 2 / (28 + 1));
    
    // Calculate ACWR with epsilon to prevent division by zero
    const epsilon = 0.1;
    const ac = chronic > epsilon ? (acute / (chronic + epsilon)).toFixed(2) : '‚Äî';
    const warn = parseFloat(ac) > 1.30;
    
    return { ac, warn, acute: Math.round(acute), chronic: Math.round(chronic) };
  }
  
  // UFC PI PRESCRIPTION ENGINE
  function generateTrainingPrescription(acwr, avgCNS, tendonLoad, z5Minutes) {
    let prescription = '';
    let color = '';
    let action = '';
    
    // Convert ACWR string to number
    const acwrNum = parseFloat(acwr);
    
    // UFC PI Decision Logic
    if(acwrNum > 1.7) {
      // HIGH BREAKDOWN RISK
      action = 'DELOAD';
      color = '#ff6b6b';
      prescription = `<div style="background:#2b1515;border-left:4px solid ${color};padding:12px;margin-top:12px">
        <div style="color:${color};font-weight:700;font-size:16px;margin-bottom:8px">üî¥ ${action} - Immediate Deload Required</div>
        <div style="color:#ccc">ACWR > 1.7 = High injury/breakdown risk</div>
        <div style="margin-top:8px"><b>Next Week:</b></div>
        <div>‚Ä¢ Reduce volume by 30-40%</div>
        <div>‚Ä¢ Reduce intensity (no max effort work)</div>
        <div>‚Ä¢ Add extra sleep + recovery days</div>
        <div>‚Ä¢ Focus on Zone 2 aerobic work only</div>
      </div>`;
    }
    else if(acwrNum >= 1.31 && acwrNum <= 1.7) {
      // ELEVATED INJURY RISK
      action = 'REDUCE VOLUME';
      color = '#ffbb33';
      prescription = `<div style="background:#2b2415;border-left:4px solid ${color};padding:12px;margin-top:12px">
        <div style="color:${color};font-weight:700;font-size:16px;margin-bottom:8px">‚ö†Ô∏è ${action} - Do Not Increase Load</div>
        <div style="color:#ccc">ACWR 1.31-1.7 = Elevated injury risk</div>
        <div style="margin-top:8px"><b>Next Week:</b></div>
        <div>‚Ä¢ Reduce volume by 15-20%</div>
        <div>‚Ä¢ Maintain intensity (quality over quantity)</div>
        <div>‚Ä¢ Add 1 extra recovery day</div>
        <div>‚Ä¢ Monitor CNS and tendon load closely</div>
      </div>`;
    }
    else if(acwrNum >= 1.0 && acwrNum <= 1.3 && avgCNS >= 75) {
      // MAINTAIN BUT CNS HIGH
      action = 'MAINTAIN (CNS Watch)';
      color = '#ffbb33';
      prescription = `<div style="background:#2b2415;border-left:4px solid ${color};padding:12px;margin-top:12px">
        <div style="color:${color};font-weight:700;font-size:16px;margin-bottom:8px">‚ö†Ô∏è ${action}</div>
        <div style="color:#ccc">ACWR safe but CNS fatigue elevated (${avgCNS})</div>
        <div style="margin-top:8px"><b>Next Week:</b></div>
        <div>‚Ä¢ Maintain current volume</div>
        <div>‚Ä¢ Reduce high-CNS work (max effort, Zone 5)</div>
        <div>‚Ä¢ Add Zone 2 aerobic base work</div>
        <div>‚Ä¢ Prioritize sleep and recovery</div>
      </div>`;
    }
    else if(acwrNum >= 1.0 && acwrNum <= 1.3) {
      // OPTIMAL TRAINING ZONE
      action = 'MAINTAIN';
      color = '#00ffb3';
      prescription = `<div style="background:#0d1f1a;border-left:4px solid ${color};padding:12px;margin-top:12px">
        <div style="color:${color};font-weight:700;font-size:16px;margin-bottom:8px">‚úì ${action} - Optimal Adaptation Zone</div>
        <div style="color:#ccc">ACWR 0.8-1.3 = Safe training zone</div>
        <div style="margin-top:8px"><b>Next Week:</b></div>
        <div>‚Ä¢ Continue current training dose</div>
        <div>‚Ä¢ Optimal adaptation occurring</div>
        <div>‚Ä¢ Monitor for any CNS or tendon warning signs</div>
        <div>‚Ä¢ Ready for intensity or volume increase if desired</div>
      </div>`;
    }
    else if(acwrNum < 1.0 && avgCNS < 60) {
      // READY TO PUSH
      action = 'PUSH';
      color = '#00ffb3';
      prescription = `<div style="background:#0d1f1a;border-left:4px solid ${color};padding:12px;margin-top:12px">
        <div style="color:${color};font-weight:700;font-size:16px;margin-bottom:8px">üöÄ ${action} - Ready for Load Increase</div>
        <div style="color:#ccc">ACWR < 1.0 AND Low CNS = Adaptation capacity available</div>
        <div style="margin-top:8px"><b>Next Week:</b></div>
        <div>‚Ä¢ Add intensity (Max Effort / Zone 5 work)</div>
        <div>‚Ä¢ OR add volume (10-15% increase)</div>
        <div>‚Ä¢ Consider adding explosive/power work</div>
        <div>‚Ä¢ System ready for progressive overload</div>
      </div>`;
    }
    else {
      // DEFAULT MAINTAIN
      action = 'MAINTAIN';
      color = '#00ffb3';
      prescription = `<div style="background:#0d1f1a;border-left:4px solid ${color};padding:12px;margin-top:12px">
        <div style="color:${color};font-weight:700;font-size:16px;margin-bottom:8px">‚úì ${action}</div>
        <div style="color:#ccc">Continue current training approach</div>
      </div>`;
    }
    
    // Add tendon load warning if needed
    if(tendonLoad > 350) {
      prescription += `<div style="background:#2b1515;border:1px solid #ff6b6b;padding:10px;margin-top:8px">
        <div style="color:#ff6b6b;font-weight:600">‚ö†Ô∏è Tendon Load Warning</div>
        <div style="color:#ccc;margin-top:4px">Weekly tendon load: ${tendonLoad} contacts (>350 = elevated risk)</div>
        <div style="margin-top:4px">‚Ä¢ Reduce plyometric volume next week</div>
        <div>‚Ä¢ Add tendon recovery work (isometrics, light eccentric)</div>
      </div>`;
    }
    
    return prescription;
  }
  
  function closeWeek(){weekModal.classList.remove('show')}
  
  const periodModal=document.getElementById('periodModal');
  function closePeriod(){periodModal.classList.remove('show')}
  
  // LP1-LP4 PERIODIZATION BLOCKS
  function calculatePeriodization(est1RM) {
    const blocks = {
      LP1: { pct: 0.78, reps: 5, sets: 5, name: 'Volume Strength', desc: 'Build work capacity and muscle mass' },
      LP2: { pct: 0.85, reps: 3, sets: 5, name: 'Neural Strength', desc: 'Increase force production' },
      LP3: { pct: 0.92, reps: 2, sets: 4, name: 'Max Effort Peaking', desc: 'Peak strength expression' },
      LP4: { pct: 0.70, reps: 3, sets: 3, name: 'Deload Recovery', desc: 'Active recovery and restoration' }
    };
    
    let html = '<div class="note" style="margin-bottom:12px"><b>Westside-style periodization based on your estimated 1RM.</b><br>Progress through LP1‚ÜíLP2‚ÜíLP3, then deload with LP4 before starting next cycle.</div>';
    
    Object.keys(blocks).forEach(key => {
      const block = blocks[key];
      const targetWeight = Math.round(est1RM * block.pct);
      
      html += `
        <div class="sec" style="margin-top:10px;background:#0d1714;border:1px solid #1e6a4f">
          <div class="hd" style="background:#0f1b17;border-bottom:1px solid #1e6a4f;color:#9de8c5">${key}: ${block.name}</div>
          <div class="bd">
            <div style="color:#ccc;margin-bottom:10px;font-style:italic">${block.desc}</div>
            <div class="grid2">
              <div class="kpi" style="border-left-color:#00ffb3"><div class="muted">Target Weight</div><div class="v">${targetWeight} lb</div></div>
              <div class="kpi"><div class="muted">% of 1RM</div><div class="v">${Math.round(block.pct*100)}%</div></div>
              <div class="kpi"><div class="muted">Reps per Set</div><div class="v">${block.reps}</div></div>
              <div class="kpi"><div class="muted">Total Sets</div><div class="v">${block.sets}</div></div>
            </div>
            <div style="margin-top:8px;color:#9de8c5;font-size:13px">
              <b>Total Volume:</b> ${targetWeight * block.reps * block.sets} lb
            </div>
          </div>
        </div>
      `;
    });
    
    return html;
  }
  
  document.getElementById('periodBtn').onclick=()=>{
    let maxEst1RM = 0;
    let foundData = false;
    
    Object.keys(store).sort().reverse().slice(0, 14).forEach(key => {
      const day = store[key];
      if(day?.modalities) {
        ['chest', 'back', 'legs'].forEach(mod => {
          if(day.modalities[mod]?.est1RM && day.modalities[mod].est1RM > maxEst1RM) {
            maxEst1RM = day.modalities[mod].est1RM;
            foundData = true;
          }
        });
      }
    });
    
    if(!foundData || maxEst1RM === 0) {
      document.getElementById('periodBody').innerHTML = `
        <div class="note">No strength data found with RPE values. Complete at least one strength session with RPE tracking to see periodization recommendations.</div>
      `;
    } else {
      document.getElementById('periodBody').innerHTML = `
        <div style="background:#0d1f1a;padding:12px;border:2px solid #00ffb3;border-radius:4px;margin-bottom:12px">
          <div style="color:#00ffb3;font-weight:700;font-size:16px">Estimated 1RM: ${maxEst1RM} lb</div>
          <div style="color:#ccc;margin-top:4px">Calculated from recent training with RPE data</div>
        </div>
        ${calculatePeriodization(maxEst1RM)}
      `;
    }
    
    periodModal.classList.add('show');
  };
  
  function getAdjustmentFactors(sportFocus, modalities) {
    // Default: no adjustment
    let cnsMultiplier = 1.0;
    let tssMultiplier = 1.0;
    
    if(!sportFocus) return {cnsMultiplier, tssMultiplier};
    
    const hasStrength = modalities.chest || modalities.back || modalities.legs;
    const hasPower = modalities.track;
    const hasEndurance = modalities.bike;
    const hasSkill = modalities.bjj;
    
    // Adjust based on sport focus preferences
    switch(sportFocus) {
      case 'Hybrid':
        // Balanced - no adjustment needed
        cnsMultiplier = 1.0;
        tssMultiplier = 1.0;
        break;
        
      case 'Strength':
        // Higher tolerance for strength work, lower for cardio
        if(hasStrength && !hasEndurance) {
          cnsMultiplier = 0.90; // Less CNS stress from strength when it's your focus
          tssMultiplier = 0.95;
        }
        if(hasEndurance && !hasStrength) {
          cnsMultiplier = 1.10; // More taxing when not your focus
          tssMultiplier = 1.10;
        }
        break;
        
      case 'Endurance':
        // Higher tolerance for cardio, lower for heavy strength
        if(hasEndurance && !hasStrength) {
          cnsMultiplier = 0.90;
          tssMultiplier = 0.95;
        }
        if(hasStrength && !hasEndurance) {
          cnsMultiplier = 1.10;
          tssMultiplier = 1.05;
        }
        break;
        
      case 'MMA':
        // Balanced but skill-focused
        if(hasSkill) {
          cnsMultiplier = 0.95; // Skill work is core to focus
        }
        if(hasPower) {
          cnsMultiplier = 0.95; // Power work is important
        }
        break;
        
      case 'BJJ':
        // Skill and endurance focused
        if(hasSkill) {
          cnsMultiplier = 0.90;
          tssMultiplier = 0.95;
        }
        if(hasEndurance) {
          cnsMultiplier = 0.95;
        }
        break;
        
      case 'Hypertrophy':
        // Volume tolerance, recovery important
        if(hasStrength) {
          cnsMultiplier = 0.95;
          tssMultiplier = 1.0;
        }
        break;
        
      case 'General':
        // Moderate adjustments for variety
        cnsMultiplier = 0.98;
        tssMultiplier = 0.98;
        break;
    }
    
    return {cnsMultiplier, tssMultiplier};
  }
  document.getElementById('weeklyBtn').onclick=()=>{
    const end=new Date(); const start=new Date(); start.setDate(start.getDate()-6);
    let totalCNS=0,totalVOL=0,totalTSS=0,days=0; const dailyCNS=[];
    let weeklyTendonLoad = 0; // Track tendon load
    let weeklyZ5Minutes = 0; // Track Zone 5 time
    
    // Track which modalities were done this week
    const modalitiesDone = {
      chest: false,
      back: false,
      legs: false,
      track: false,
      bike: false,
      bjj: false,
      walk: false
    };
    
    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const k=toKey(d); const day=store[k];
      if(day){
        days++; 
        totalCNS+=fmt(day.totalCNS); 
        totalVOL+=fmt(day.totalVolume); 
        totalTSS+=fmt(day.tss); 
        dailyCNS.push(fmt(day.totalCNS));
        
        // Track modalities
        if(day.modalities) {
          if(day.modalities.chest) modalitiesDone.chest = true;
          if(day.modalities.back) modalitiesDone.back = true;
          if(day.modalities.legs) modalitiesDone.legs = true;
          if(day.modalities.track) {
            modalitiesDone.track = true;
            // Track tendon load
            if(day.modalities.track.tendonLoad) {
              weeklyTendonLoad += day.modalities.track.tendonLoad;
            }
          }
          if(day.modalities.bike) {
            modalitiesDone.bike = true;
            // Track Zone 5 time if C2 protocol
            if(day.modalities.bike.proto === 'c2' && day.modalities.bike.roundData) {
              day.modalities.bike.roundData.forEach(r => {
                if(r.tZ5) weeklyZ5Minutes += (r.tRep - r.tZ5) / 60;
              });
            }
          }
          if(day.modalities.bjj) modalitiesDone.bjj = true;
          if(day.modalities.walking) modalitiesDone.walk = true;
        }
      }
    }
    
    const avgCNS=days?Math.round(totalCNS/days):0; const avgTSS=days?Math.round(totalTSS/days):0;
    const mean=avgCNS; const varc=dailyCNS.length? dailyCNS.reduce((s,v)=>s+Math.pow(v-mean,2),0)/dailyCNS.length : 0;
    const std=Math.sqrt(varc); const mono=std>0?(mean/std).toFixed(2):'0.00';
    
    // GOD-MODE: Foster Strain = Weekly Load √ó Monotony
    const strain = Math.round(totalTSS * parseFloat(mono));
    
    // GOD-MODE: Use EWMA ACWR instead of simple average
    const acwrData = calculateEWMAACWR(hist);
    const ac = acwrData.ac;
    const warn = acwrData.warn;
    const acuteLoad = acwrData.acute;
    const chronicLoad = acwrData.chronic;
    
    // Get user's sport focus
    const profile = LS.get('elite_profile', {});
    const sportFocus = profile.sport || '';
    
    // GOD-MODE: Check for high strain injury risk
    // Calculate strain quartile (top 25% is high risk)
    const recentStrains = hist.slice(-12).map(h => {
      const dayTSS = fmt(h.tss);
      // Need to recalculate monotony for historical data (simplified)
      return dayTSS * 1.5; // Approximate strain
    });
    const strainThreshold = recentStrains.length > 0 
      ? recentStrains.sort((a,b)=>b-a)[Math.floor(recentStrains.length * 0.25)] 
      : 1000;
    const highStrain = strain > strainThreshold && parseFloat(mono) > 2.0;
    
    // GOD-MODE: Analyze sleep patterns
    const sleepAnalysis = analyzeSleepPattern();
    
    // GOD-MODE: Analyze RSI decline
    const rsiAnalysis = analyzeRSIDecline();
    
    // GOD-MODE: Analyze Z5 spike
    const z5Analysis = analyzeZ5Spike();
    
    // Generate recommendations based on sport focus and modalities done
    let recommendations = generateRecommendations(sportFocus, modalitiesDone);
    
    // Generate UFC PI prescription
    let prescription = generateTrainingPrescription(ac, avgCNS, weeklyTendonLoad, weeklyZ5Minutes);
    
    document.getElementById('weekBody').innerHTML=`
      <div class="grid2">
        <div class="kpi"><div class="muted">Total Volume (lb)</div><div class="v">${totalVOL.toLocaleString()}</div></div>
        <div class="kpi"><div class="muted">Avg daily CNS</div><div class="v">${avgCNS}</div></div>
        <div class="kpi"><div class="muted">Weekly TSS</div><div class="v">${totalTSS}</div></div>
        <div class="kpi" style="border-left-color:${warn?'#ff6b6b':'#00ffb3'}"><div class="muted">Acute:Chronic (EWMA)</div><div class="v" style="color:${warn?'#ff6b6b':'#00ffb3'}">${ac}</div></div>
        <div class="kpi"><div class="muted">Monotony</div><div class="v">${mono}</div></div>
        <div class="kpi" style="border-left-color:${highStrain?'#ff6b6b':'#9de8c5'}"><div class="muted">Strain (Load√óMono)</div><div class="v" style="color:${highStrain?'#ff6b6b':'#9de8c5'}">${strain}</div></div>
        <div class="kpi"><div class="muted">Acute Load (7d)</div><div class="v">${acuteLoad}</div></div>
        <div class="kpi"><div class="muted">Chronic Load (28d)</div><div class="v">${chronicLoad}</div></div>
      </div>
      ${highStrain ? `<div class="sec" style="margin-top:12px"><div class="bd"><div class="danger"><b>‚ö†Ô∏è High Strain Warning:</b> Monotony > 2.0 AND Strain in top quartile. Risk of overtraining injury. Add training variety or reduce volume 15-20%.</div></div></div>` : ''}
      ${sleepAnalysis.hasAlert ? `<div class="sec" style="margin-top:12px"><div class="bd"><div class="danger"><b>‚ö†Ô∏è Sleep Pattern Alert:</b> ${sleepAnalysis.maxConsecutive} consecutive nights with <6h sleep detected. Elevated injury and overtraining risk. Prioritize 7-9h sleep for next 3 nights.</div></div></div>` : ''}
      ${rsiAnalysis.decline ? `<div class="sec" style="margin-top:12px"><div class="bd"><div class="danger"><b>‚ö†Ô∏è RSI Decline Alert:</b> Reactive Strength Index dropped ${rsiAnalysis.declinePercent}% vs 21-day average (${rsiAnalysis.avgRSI}). Current: ${rsiAnalysis.currentRSI}. Indicates neuromuscular fatigue or poor recovery. Consider deload or reduce plyometric volume.</div></div></div>` : ''}
      ${z5Analysis.spike ? `<div class="sec" style="margin-top:12px"><div class="bd"><div class="danger"><b>‚ö†Ô∏è Z5 Intensity Spike:</b> Zone 5 minutes increased ${z5Analysis.increasePercent}% week-over-week (${z5Analysis.lastWeekZ5}min ‚Üí ${z5Analysis.thisWeekZ5}min). Sudden spikes >50% elevate injury risk. Scale back high-intensity work or add recovery days.</div></div></div>` : ''}
      ${rsiAnalysis.hasData && !rsiAnalysis.decline ? `<div style="margin-top:8px;padding:8px;background:#0d1714;border:1px solid #00ffb3;border-radius:4px">
        <b>RSI (Reactive Strength):</b> Current ${rsiAnalysis.currentRSI} | 21-day avg ${rsiAnalysis.avgRSI} <span style="color:#00ffb3">(Stable)</span>
      </div>` : ''}
      ${z5Analysis.hasData && !z5Analysis.spike ? `<div style="margin-top:8px;padding:8px;background:#0d1714;border:1px solid #1e6a4f;border-radius:4px">
        <b>Z5 Intensity Trend:</b> This week ${z5Analysis.thisWeekZ5}min | Last week ${z5Analysis.lastWeekZ5}min ${z5Analysis.increasePercent > 0 ? `(+${z5Analysis.increasePercent}%)` : `(${z5Analysis.increasePercent}%)`}
      </div>` : ''}
      ${sleepAnalysis.avgSleep > 0 ? `<div style="margin-top:8px;padding:8px;background:#0d1714;border:1px solid #1e6a4f;border-radius:4px">
        <b>7-Day Sleep Average:</b> ${sleepAnalysis.avgSleep}h/night ${sleepAnalysis.avgSleep < 7 ? '<span style="color:#ffbb33">(Below optimal)</span>' : '<span style="color:#00ffb3">(Good)</span>'}
      </div>` : ''}
      ${weeklyTendonLoad > 0 ? `<div style="margin-top:12px;padding:8px;background:#0d1714;border:1px solid #1e6a4f;border-radius:4px">
        <b>Weekly Tendon Load:</b> ${weeklyTendonLoad} contacts ${weeklyTendonLoad > 350 ? '<span style="color:#ffbb33">(Elevated)</span>' : '<span style="color:#00ffb3">(Safe)</span>'}
      </div>` : ''}
      ${prescription}
      ${warn?`<div class="sec" style="margin-top:12px"><div class="bd"><div class="danger"><b>Injury-risk warning:</b> reduce next-week volume 15‚Äì20%, add 1‚Äì2 rest days, emphasize sleep & nutrition.</div></div></div>`:''}
      ${recommendations ? `<div class="sec" style="margin-top:12px"><div class="hd">üìã Training Balance ${sportFocus ? `(${sportFocus})` : ''}</div><div class="bd">${recommendations}</div></div>` : ''}
    `;
    weekModal.classList.add('show');
  };
  
  function generateRecommendations(sportFocus, modalitiesDone) {
    if(!sportFocus) return '';
    
    let html = '';
    const missing = [];
    const complete = [];
    
    // Domain definitions
    const domains = {
      strength: {
        name: 'Strength',
        modalities: ['chest', 'back', 'legs'],
        labels: {chest: 'Chest Day', back: 'Back Day', legs: 'Legs Day'}
      },
      power: {
        name: 'Power',
        modalities: ['track'],
        labels: {track: 'Track/Plyo'}
      },
      endurance: {
        name: 'Endurance',
        modalities: ['bike'],
        labels: {bike: 'Assault Bike'}
      },
      skill: {
        name: 'Skill',
        modalities: ['bjj'],
        labels: {bjj: 'BJJ'}
      },
      recovery: {
        name: 'Recovery',
        modalities: ['walk'],
        labels: {walk: 'Walk'}
      }
    };
    
    // Requirements by sport focus
    const requirements = {
      'Hybrid': ['strength', 'power', 'endurance', 'skill', 'recovery'],
      'MMA': ['strength', 'power', 'endurance', 'skill'],
      'Strength': ['strength', 'power'],
      'Endurance': ['endurance', 'recovery'],
      'Hypertrophy': ['strength', 'recovery'],
      'BJJ': ['strength', 'skill', 'endurance'],
      'General': ['strength', 'endurance', 'recovery']
    };
    
    const required = requirements[sportFocus] || [];
    
    // Check each required domain
    required.forEach(domainKey => {
      const domain = domains[domainKey];
      const missingInDomain = [];
      let anyDone = false;
      
      domain.modalities.forEach(mod => {
        if(modalitiesDone[mod]) {
          anyDone = true;
        } else {
          missingInDomain.push(domain.labels[mod]);
        }
      });
      
      if(domainKey === 'strength') {
        // Special case: strength needs all 3
        if(modalitiesDone.chest && modalitiesDone.back && modalitiesDone.legs) {
          complete.push(`<span style="color:#00ffb3">‚úì ${domain.name} (complete)</span>`);
        } else {
          missing.push(`<span style="color:#ffbb33">‚ö† ${domain.name}: Missing ${missingInDomain.join(', ')}</span>`);
        }
      } else {
        if(anyDone) {
          complete.push(`<span style="color:#00ffb3">‚úì ${domain.name}</span>`);
        } else {
          missing.push(`<span style="color:#ff6b6b">‚úó ${domain.name}: Add ${missingInDomain.join(', ')}</span>`);
        }
      }
    });
    
    if(complete.length > 0) {
      html += '<div style="margin-bottom:8px">' + complete.join(' ‚Ä¢ ') + '</div>';
    }
    
    if(missing.length === 0) {
      html += '<div style="color:#00ffb3;font-weight:600">üéØ Perfect balance - all domains covered!</div>';
    } else {
      html += '<div style="margin-top:8px"><b>Recommended for next week:</b></div>';
      html += '<div style="margin-top:4px">' + missing.join('<br>') + '</div>';
    }
    
    return html;
  }

  renderZoneChips();
  
  // Check if Fight Camp mode is active
  const profile = LS.get('elite_profile', {});
  if(profile.sport === 'FIGHT CAMP' && profile.fightCamp) {
    renderFightCampDashboard();
  } else {
    renderCal();
  }
  
  // Initialize bike UI with default protocol on page load
  setTimeout(function() {
    if(bikeProto) {
      applyBikeUI();
      updateProtocolInstructions();
    }
  }, 100);
</script>
</body>
</html>
