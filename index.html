<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Elite Athlete Training System ‚Äî v12</title>
<style>
  :root{
    --bg:#0b0d0f;--panel:#15181b;--panel2:#0f1215;--ink:#e7eef6;
    --muted:#9fb2c7;--accent:#00ffb3;--accent2:#00ccff;--warn:#ff6b6b;
    --ok:#38ef7d;--border:#26323f;--card:#101418;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;
    background:linear-gradient(180deg,#0b0d0f,#0b0d0f 60%,#0a0f13);
    color:var(--ink);line-height:1.45;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  h1{
    margin:6px 0 2px;text-align:center;font-size:34px;letter-spacing:.4px;
    background:linear-gradient(90deg,#ff7a45, var(--accent), var(--accent2));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  }
  .sub{color:#8aa3ba;text-align:center;margin:0 0 18px;font-size:14px}
  .toolbar{display:flex;gap:10px;justify-content:space-between;align-items:center;
    background:var(--panel);padding:14px;border:1px solid var(--border);border-radius:12px;flex-wrap:wrap}
  .btn{background:#1e2530;border:1px solid #2a3746;color:var(--ink);padding:10px 14px;
    border-radius:8px;cursor:pointer;font-weight:600}
  .btn:hover{border-color:#3c536b}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#001b1b;border:none}
  .month{font-size:20px;color:var(--accent)}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:12px}
  .dow{padding:8px;text-align:center;color:#8aa3ba;font-weight:700}
  .cell{min-height:105px;background:var(--panel);border:1px solid var(--border);border-radius:10px;
    padding:8px;position:relative;cursor:pointer}
  .cell.other{opacity:.35}
  .cell.today{outline:2px solid var(--accent);box-shadow:0 0 16px rgba(0,255,179,.15)}
  .num{font-weight:800;color:#fff;margin-bottom:6px}
  .badge{display:inline-block;font-size:10px;padding:2px 6px;border-radius:4px;margin:1px;background:#10383a;color:#8afddf;border:1px solid #17544d}
  .cns{position:absolute;right:8px;top:8px;width:10px;height:10px;border-radius:50%}
  .cns.low{background:#3ef7a4}.cns.mod{background:#ffbb33}.cns.high{background:#ff5a5a}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
  .modal.show{display:flex}
  .panel{width:min(1100px,96vw);max-height:92vh;overflow:auto;background:var(--panel2);
    border:1px solid var(--border);border-radius:14px;padding:16px 16px 22px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{background:#0f161c;border:1px solid #223140;padding:8px 12px;border-radius:999px;font-weight:700;color:#b9cee2}
  .kpi{flex:1;min-width:240px;background:var(--card);border:1px solid var(--border);border-left:4px solid var(--accent2);
    padding:14px;border-radius:12px}
  .kpi .v{font-size:28px;font-weight:900;color:var(--accent)}
  .sec{margin-top:14px;border:1px solid var(--border);border-radius:12px;background:var(--panel)}
  .sec .hd{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--border);font-weight:800;color:#a7c6e4}
  .sec .bd{padding:12px}
  .grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  label{display:block;font-size:12px;color:#8aa3ba;margin-bottom:6px;font-weight:700}
  input,select,textarea{width:100%;background:#0e1419;border:1px solid #2a3746;color:#e7eef6;border-radius:8px;padding:10px}
  input:focus,select:focus,textarea:focus{outline:none;border-color:#3c8bd9}
  .muted{color:#8aa3ba;font-size:12px}
  .danger{color:var(--warn)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f2a35;padding:8px;text-align:left}
  .right{text-align:right}
  .green{color:var(--ok)}
  .note{background:#0d1714;border:1px dashed #1e6a4f;border-radius:8px;padding:10px;color:#9de8c5}
  .hr-box{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .hr-prev{max-width:100%;border:1px dashed #2a3746;border-radius:10px;padding:8px;text-align:center}
  .hr-prev img{max-width:100%;border-radius:8px}
  .sticky{position:sticky;bottom:0;background:linear-gradient(180deg,transparent,rgba(0,0,0,.8));padding-top:8px}
  .footer{display:flex;gap:10px;justify-content:space-between;align-items:center;padding-top:10px}
  .sm{font-size:12px}
  @media (max-width:820px){.hr-box{grid-template-columns:1fr}}
  .chip{display:inline-block;padding:4px 8px;border:1px solid #274b5b;border-radius:999px;color:#9ad7ef;background:#0c151c;margin-right:6px;margin-top:6px;font-size:12px}
  .tExercise{min-width:135px;max-width:135px;font-size:12px;font-weight:600;padding:6px 4px}
  .tUnit{min-width:68px;max-width:68px;font-size:12px;padding:6px 4px}
  #trkRows td{padding:4px 2px;vertical-align:middle}
  #trkRows select{padding:6px 4px;font-size:12px}
  #trkRows input{padding:6px 4px;font-size:12px;max-width:100%}
  #trkRows .tDist,#trkRows .tReps,#trkRows .tJumps,#trkRows .tSteps,#trkRows .tCols,#trkRows .tTime{width:55px;max-width:55px}
  #trkRows .tRPE{width:45px;max-width:45px}
  #trkRows .tNote{width:75px;max-width:75px}
  .altLegCell{text-align:center;min-width:70px;max-width:70px;padding:2px !important}
  .altLegCell input{font-size:11px;padding:3px;width:32px;max-width:32px;min-width:32px}
  .altLegCell div{display:flex;gap:2px;justify-content:center}
  #trkRows .btn{padding:4px 6px;font-size:11px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>üèÜ ELITE ATHLETE TRAINING SYSTEM</h1>
    <p class="sub">Load Management ‚Ä¢ sRPE/TRIMP ‚Ä¢ Contacts-Accurate Plyometrics ‚Ä¢ Assault Bike Lab ‚Ä¢ HR Zones</p>

    <div class="toolbar">
      <div class="row">
        <button class="btn" id="prevBtn">‚Äπ Prev</button>
        <button class="btn" id="todayBtn">Today</button>
        <button class="btn" id="nextBtn">Next ‚Ä∫</button>
      </div>
      <div class="month" id="monthTitle">‚Äî</div>
      <div class="row">
        <button class="btn" id="profileBtn">üë§ Profile</button>
        <button class="btn primary" id="weeklyBtn">üìä Weekly Analysis</button>
      </div>
    </div>

    <div id="zoneChips" style="margin-top:8px"></div>

    <div class="grid" id="calHead"></div>
    <div class="grid" id="calBody"></div>
  </div>

  <div class="modal" id="profileModal">
    <div class="panel">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="pill">üë§ Athlete Profile</div>
        <button class="btn" onclick="closeProfile()">‚úï Close</button>
      </div>
      <div class="grid2">
        <div><label>Age (y)</label><input id="pfAge" type="number" min="5" max="100"></div>
        <div><label>Sex</label><select id="pfSex"><option></option><option>Male</option><option>Female</option></select></div>
        <div><label>Height (in)</label><input id="pfHt" type="number" step="0.1"></div>
        <div><label>Weight (lb)</label><input id="pfWt" type="number" step="0.1"></div>
        <div><label>Training Age (years)</label><input id="pfTA" type="number" step="0.1"></div>
        <div><label>Resting HR (bpm)</label><input id="pfRHR" type="number"></div>
        <div><label>Max HR (bpm) <span class="muted sm">auto-calculates</span></label><input id="pfMHR" type="number" placeholder="auto from age"></div>
        <div><label>Sport / Focus</label>
          <select id="pfSport">
            <option value="">Choose...</option>
            <option value="Hybrid">Hybrid (Strength + Power + Endurance + Hypertrophy)</option>
            <option value="MMA">MMA / Fighting</option>
            <option value="Strength">Strength & Powerlifting</option>
            <option value="Endurance">Endurance / Cardio</option>
            <option value="Hypertrophy">Hypertrophy / Bodybuilding</option>
            <option value="BJJ">BJJ / Grappling</option>
            <option value="General">General Fitness</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div><label>Primary Goal</label><input id="pfGoal" placeholder="e.g., fight camp, strength, VO2"></div>
        <div><label>Weekly Availability (days)</label><input id="pfAvail" type="number" min="1" max="14"></div>
      </div>
      <div class="note" style="margin-top:10px">
        <b>Max HR Auto-Calculation:</b> Uses Tanaka formula (2001): <b>208 - (0.7 √ó age)</b> - the most accurate research-validated formula for adults. Leave Max HR blank for auto-calculation, or enter a value to override (e.g., from a VO2 max test).<br><br>
        <b>Sport Focus Impact:</b> Your sport focus adjusts TSS/CNS calculations and provides weekly training recommendations. For example, "Hybrid" requires balanced work across Strength, Power, Endurance, Skill, and Recovery domains. Weekly Analysis will show which domains you've covered and what's missing.<br><br>
        Saves HR zones (5-zone model, %Max + Karvonen if RHR provided). Zones appear as chips under toolbar.
      </div>
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button class="btn primary" onclick="saveProfile()">‚úì Save Profile</button>
      </div>
    </div>
  </div>

  <div class="modal" id="dayModal">
    <div class="panel">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="pill" id="dayTitle">‚Äî</div>
        <button class="btn" onclick="closeDay()">‚úï Close</button>
      </div>

      <div class="row">
        <div class="kpi"><div class="muted">Estimated CNS Load</div><div class="v" id="kpiCNS">0</div></div>
        <div class="kpi"><div class="muted">Total TSS (TRIMP/sRPE)</div><div class="v" id="kpiTSS">0</div></div>
        <div class="kpi"><div class="muted">Strength Volume (lb)</div><div class="v" id="kpiVOL">0</div></div>
      </div>

      <div class="sec">
        <div class="hd">Modalities (toggle)</div>
        <div class="bd">
          <div class="row">
            <label class="pill"><input type="checkbox" id="mChest" onchange="toggleSection('secChest')"> Chest</label>
            <label class="pill"><input type="checkbox" id="mBack" onchange="toggleSection('secBack')"> Back</label>
            <label class="pill"><input type="checkbox" id="mLegs" onchange="toggleSection('secLegs')"> Legs</label>
            <label class="pill"><input type="checkbox" id="mTrack" onchange="toggleSection('secTrack')"> Track/Plyo</label>
            <label class="pill"><input type="checkbox" id="mBike" onchange="toggleSection('secBike')"> Assault Bike</label>
            <label class="pill"><input type="checkbox" id="mBJJ" onchange="toggleSection('secBJJ')"> BJJ</label>
            <label class="pill"><input type="checkbox" id="mWalk" onchange="toggleSection('secWalk')"> Walking/Recovery</label>
          </div>
        </div>
      </div>

      <div class="sec" id="secChest" style="display:none">
        <div class="hd">üí™ CHEST ‚Äî Strength Session</div>
        <div class="bd" id="chestBox"></div>
      </div>
      <div class="sec" id="secBack" style="display:none">
        <div class="hd">üí™ BACK ‚Äî Strength Session</div>
        <div class="bd" id="backBox"></div>
      </div>
      <div class="sec" id="secLegs" style="display:none">
        <div class="hd">üí™ LEGS ‚Äî Strength Session</div>
        <div class="bd" id="legsBox"></div>
      </div>

      <div class="sec" id="secTrack" style="display:none">
        <div class="hd">üèÉ Track / Plyometrics ‚Äî Per-Rep Logging</div>
        <div class="bd">
          
          <div class="sec" style="margin-top:0;background:#0d1714;border:1px solid #1e6a4f">
            <div class="hd" style="background:#0f1b17;border-bottom:1px solid #1e6a4f;color:#9de8c5;display:flex;justify-content:space-between;align-items:center">
              <span>‚úì Warmup Routine Checklist</span>
              <span id="warmupProgress" style="font-size:14px;color:#38ef7d">0/9 Complete</span>
            </div>
            <div class="bd" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:8px">
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Walk on toes 20yd fwd ‚Üí 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Walk on heels 20yd fwd ‚Üí 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Lunge 10yd fwd / 10yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Single yard hops 20yd fwd ‚Üí 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Single yard hops LEFT 20yd fwd ‚Üí RIGHT 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Double yard hops 20yd fwd ‚Üí 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Single leg double yard hops LEFT 20yd fwd ‚Üí RIGHT 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> Skipping 20yd fwd ‚Üí 20yd back
              </label>
              <label style="display:flex;align-items:center;gap:8px;padding:6px;cursor:pointer;color:#9de8c5">
                <input type="checkbox" class="warmupCheck" onchange="updateWarmupProgress()" style="width:auto"> High knees 15yd total
              </label>
            </div>
          </div>

          <div class="note" style="margin-top:10px">
            <b>How it works:</b><br>
            ‚Ä¢ Click <b>"+ Add Exercise"</b> to add each exercise<br>
            ‚Ä¢ Enter exercise name (e.g., "Broad Jump", "Single Leg Stair Jump")<br>
            ‚Ä¢ Choose <b>Bilateral</b> (both legs) or <b>Unilateral</b> (single leg)<br>
            ‚Ä¢ Enter number of sets and reps per set<br>
            ‚Ä¢ For unilateral: enter R Leg and L Leg reps separately<br>
            <br>
            <b>Examples:</b><br>
            ‚Ä¢ Broad Jump: Bilateral, 4 sets, 34 reps per set<br>
            ‚Ä¢ Single Leg Stair Jump: Unilateral, 4 sets, R Leg: 21, L Leg: 21<br>
            <br>
            <b>RPE (Rate of Perceived Exertion):</b><br>
            ‚Ä¢ 1-3: Easy/Warmup | 4-6: Moderate | 7-8: Hard | 9-10: Max Effort<br>
            ‚Ä¢ Higher RPE = Higher CNS load & TSS (affects recovery needs)
          </div>
          <div class="grid2">
            <div>
              <label>Sleep (h)</label>
              <input id="trkSleep" type="number" step="0.5" placeholder="7.5" />
            </div>
            <div>
              <label>Achilles/Calf</label>
              <select id="trkAch">
                <option value="">Choose...</option>
                <option>Fresh</option><option>Tight</option><option>Sore</option>
              </select>
            </div>
          </div>

          <div class="sec" style="margin-top:10px">
            <div class="hd">Exercises</div>
            <div class="bd">
              <div class="row">
                <button class="btn" onclick="addTrackExercise()">+ Add Exercise</button>
                <div class="muted sm">Add each exercise with sets and reps.</div>
              </div>
              <div id="trackExercises" style="margin-top:10px">
                <!-- Exercises will be added here -->
              </div>
            </div>
          </div>

          <div class="hr-box" style="margin-top:10px">
            <div>
              <label>HR Screenshot (optional)</label>
              <div class="hr-prev" id="trkPrev">No image</div>
              <input id="trkImg" type="file" accept="image/*" onchange="previewImg(this,'trkPrev')" />
            </div>
            <div>
              <label>Manual HR summary</label>
              <div class="grid2">
                <div><label>Avg HR</label><input id="trkAvgHR" type="number"></div>
                <div><label>Peak HR</label><input id="trkPeakHR" type="number"></div>
                <div><label>Min in Zone 5</label><input id="trkZ5" type="number"></div>
                <div><label>Min in Zone 4</label><input id="trkZ4" type="number"></div>
              </div>
              <p class="muted sm">From Polar app summary for best accuracy.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="sec" id="secBike" style="display:none">
        <div class="hd">üö¥ Assault Bike Lab</div>
        <div class="bd">
          <div class="grid2">
            <div>
              <label>Protocol</label>
              <select id="bikeProto" onchange="applyBikeUI()">
                <optgroup label="Custom Protocols">
                  <option value="c1">C1 ‚Äî Max RPM per round</option>
                  <option value="c2">C2 ‚Äî Max RPM ‚Üí Z5 ‚Üí stop (time-cap)</option>
                  <option value="c3">C3 ‚Äî Max RPM then 70% hold (30s)</option>
                </optgroup>
                <optgroup label="Standard Intervals">
                  <option value="steady">Steady Z2 (aerobic base)</option>
                  <option value="alt">Alt 30s hard / 30s easy</option>
                  <option value="z5">Zone 5 Intervals</option>
                  <option value="peak" selected>Peak RPM Sprints</option>
                </optgroup>
                <optgroup label="UFC PI Protocols (Optional)">
                  <option value="ngannou">Ngannou Power (10√ó30s/30s)</option>
                  <option value="progressive">Progressive Cal (5min continuous)</option>
                  <option value="extended">Extended Capacity (6√ó5min/2min)</option>
                  <option value="tabata">Tabata (8√ó20s/10s)</option>
                  <option value="sprints">Power Sprints (10s max/50s rest)</option>
                </optgroup>
              </select>
            </div>
            <div id="roundBlock"><label>Rounds</label><input id="bikeRounds" type="number" min="1" value="6"></div>
            <div id="workBlock"><label>Work (s)</label><input id="bikeWork" type="number" value="20"></div>
            <div id="restBlock"><label>Rest (s)</label><input id="bikeRest" type="number" value="100"></div>
            <div id="timeCapBlock" style="display:none"><label>Time Cap (min)</label><input id="bikeCap" type="number" value="25"></div>
            <div><label style="color:#38ef7d">Total Routine Time (min)</label><input id="bikeTotalTime" type="number" step="0.5" placeholder="e.g., 25.5" style="border-color:#38ef7d"></div>
            <div><label id="bikeTargetLabel">Target HR</label><input id="bikeTarget" type="number" value="90"></div>
            <div><label>Sleep (h)</label><input id="bikeSleep" type="number" step="0.5" placeholder="7.5"></div>
          </div>

          <div id="protocolHints" class="muted sm" style="margin-top:8px;padding:8px;background:#0a0f0d;border-left:3px solid #1e6a4f">
            <span id="hintsText">Select protocol to see relevant fields...</span>
          </div>

          <div id="bikeProtocolDetails" class="note" style="margin-top:10px;font-size:12px;background:#0d1714;border:1px solid #1e6a4f;padding:12px">
            <b>üìã Protocol Instructions:</b><br>
            <span id="protocolInstructions">Select a protocol above to see detailed instructions...</span>
          </div>

          <div class="sec" style="margin-top:10px">
            <div class="hd">Rounds / Reps</div>
            <div class="bd">
              <div class="row" id="c2Buttons" style="display:none">
                <button class="btn" onclick="addBikeRow({})">+ Add Rep</button>
                <div class="muted sm">Stop when time-cap elapses. Track Max RPM, Time‚ÜíZ5, Total Rep Time, Time‚ÜíZ2</div>
              </div>
              <table id="bikeTable" style="font-size:12px">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Max RPM</th>
                    <th>Avg RPM</th>
                    <th>Cals</th>
                    <th>Watts</th>
                    <th>Time ‚Üí Z5 (s)</th>
                    <th>Total Rep Time (s)</th>
                    <th>Time ‚Üí Z2 (s)</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="hr-box" style="margin-top:10px">
            <div>
              <label>HR Screenshot</label>
              <div class="hr-prev" id="bikePrev">No image</div>
              <input id="bikeImg" type="file" accept="image/*" onchange="previewImg(this,'bikePrev')" />
            </div>
            <div>
              <label>Manual HR summary</label>
              <div class="grid2">
                <div><label>Avg HR</label><input id="bikeAvgHR" type="number"></div>
                <div><label>Peak HR</label><input id="bikePeakHR" type="number"></div>
                <div><label>Min in Z5</label><input id="bikeZ5" type="number"></div>
                <div><label>Min in Z4</label><input id="bikeZ4" type="number"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="sec" id="secBJJ" style="display:none">
        <div class="hd">ü•ã BJJ</div>
        <div class="bd grid2">
          <div><label>Spar time (min)</label><input id="bjjTime" type="number" placeholder="45"></div>
          <div><label>Intensity</label>
            <select id="bjjInt">
              <option value="">Choose‚Ä¶</option><option>High</option><option>Medium</option><option>Light</option>
            </select>
          </div>
          <div><label>Weight before (lb)</label><input id="bjjW1" type="number" step="0.1"></div>
          <div><label>Weight after (lb)</label><input id="bjjW2" type="number" step="0.1"></div>
          <div><label>Feel</label>
            <select id="bjjFeel">
              <option value="">Choose‚Ä¶</option><option>Great</option><option>Good</option><option>Tired</option><option>Beat</option>
            </select>
          </div>
          <div><label>Sleep (h)</label><input id="bjjSleep" type="number" step="0.5"></div>
        </div>
      </div>

      <div class="sec" id="secWalk" style="display:none">
        <div class="hd">üö∂ Walking / Recovery</div>
        <div class="bd grid2">
          <div><label>Duration (min)</label><input id="wDur" type="number"></div>
          <div><label>Distance (mi)</label><input id="wDist" type="number" step="0.01"></div>
          <div><label>Pace (min/mi)</label><input id="wPace" type="number" step="0.1"></div>
          <div><label>Terrain</label>
            <select id="wTer"><option>Flat</option><option>Hills</option><option>Steep</option></select>
          </div>
          <div><label>Purpose</label>
            <select id="wPur"><option>Recovery</option><option>Zone 2</option><option>General</option></select>
          </div>
        </div>
      </div>

      <div class="sticky">
        <div class="footer">
          <button class="btn primary" onclick="saveDay()">‚úì Save Day & Recompute</button>
          <div class="muted sm" id="saveNote">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="weekModal">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="pill">üìä Weekly Analysis</div>
        <button class="btn" onclick="closeWeek()">‚úï Close</button>
      </div>
      <div id="weekBody" style="margin-top:10px"></div>
    </div>
  </div>

<script>
  const fmt=(n)=>Number(n||0);
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const parseSets=(s)=>{ if(!s) return 0; if(String(s).includes('x')){ const [a,b]=String(s).toLowerCase().split('x').map(v=>parseInt(v||0)); return (isNaN(a)||isNaN(b))?0:a*b; } const n=parseInt(s); return isNaN(n)?0:n; };
  const LS={get(k,def){try{return JSON.parse(localStorage.getItem(k))??def}catch(_){return def}},set(k,v){localStorage.setItem(k,JSON.stringify(v))}};

  function calcZones(profile){
    const age=fmt(profile.age), rhr=fmt(profile.rhr)||null;
    const mhr = fmt(profile.mhr)|| (220 - age);
    const useKarv = !!rhr && mhr>rhr;
    function zone(pLo,pHi){
      if(useKarv){ const lo = Math.round(((mhr-rhr)*pLo + rhr)); const hi = Math.round(((mhr-rhr)*pHi + rhr)); return [lo,hi]; }
      else{ return [Math.round(mhr*pLo), Math.round(mhr*pHi)]; }
    }
    return { mhr, z1:zone(0.50,0.60), z2:zone(0.60,0.70), z3:zone(0.70,0.80), z4:zone(0.80,0.90), z5:zone(0.90,1.00), type: useKarv?'Karvonen (%HRR + RHR)':'%Max only' };
  }
  function renderZoneChips(){
    const p=LS.get('elite_profile',null);
    const wrap=document.getElementById('zoneChips');
    if(!p){ wrap.innerHTML=''; return; }
    const z=calcZones(p);
    wrap.innerHTML = `
      <span class="chip">MaxHR: ${z.mhr} (${z.type})</span>
      <span class="chip">Z1 ${z.z1[0]}‚Äì${z.z1[1]}</span>
      <span class="chip">Z2 ${z.z2[0]}‚Äì${z.z2[1]}</span>
      <span class="chip">Z3 ${z.z3[0]}‚Äì${z.z3[1]}</span>
      <span class="chip">Z4 ${z.z4[0]}‚Äì${z.z4[1]}</span>
      <span class="chip">Z5 ${z.z5[0]}‚Äì${z.z5[1]}</span>
    `;
  }

  const head=document.getElementById('calHead'); const body=document.getElementById('calBody');
  const monthTitle=document.getElementById('monthTitle');
  const DOW=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  let cur=new Date();
  let store=LS.get('elite_days',{});
  let hist=LS.get('elite_tss',[]);

  function renderCal(){
    head.innerHTML=''; body.innerHTML='';
    DOW.forEach(d=>{const el=document.createElement('div'); el.className='dow'; el.textContent=d; head.appendChild(el)});
    const y=cur.getFullYear(), m=cur.getMonth();
    monthTitle.textContent=cur.toLocaleDateString(undefined,{month:'long',year:'numeric'});
    const first=new Date(y,m,1).getDay();
    const days=new Date(y,m+1,0).getDate();
    const prevDays=new Date(y,m,0).getDate();
    const todayStr = toKey(new Date());
    for(let i=first-1;i>=0;i--){const d=prevDays-i; body.appendChild(dayCell(new Date(y,m-1,d),true,todayStr))}
    for(let d=1;d<=days;d++){body.appendChild(dayCell(new Date(y,m,d),false,todayStr))}
    const total=first+days; const rem=(total<=35?35-total:42-total);
    for(let d=1;d<=rem;d++){body.appendChild(dayCell(new Date(y,m+1,d),true,todayStr))}
  }
  function dayCell(date,other,todayStr){
    const el=document.createElement('div'); el.className='cell'+(other?' other':'');
    const key=toKey(date);
    if(key===todayStr) el.classList.add('today');
    const num=document.createElement('div'); num.className='num'; num.textContent=date.getDate(); el.appendChild(num);
    const day=store[key];
    if(day?.modalities){
      Object.keys(day.modalities).forEach(k=>{
        const b=document.createElement('span'); b.className='badge'; b.textContent=k.toUpperCase(); el.appendChild(b);
      });
      const c=document.createElement('div'); c.className='cns '+(day.totalCNS<60?'low':day.totalCNS<75?'mod':'high'); el.appendChild(c);
    }
    el.onclick=()=>openDay(date);
    return el;
  }
  function toKey(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`}
  document.getElementById('prevBtn').onclick=()=>{cur.setMonth(cur.getMonth()-1);renderCal()}
  document.getElementById('nextBtn').onclick=()=>{cur.setMonth(cur.getMonth()+1);renderCal()}
  document.getElementById('todayBtn').onclick=()=>{cur=new Date();renderCal()}

  const profileModal=document.getElementById('profileModal');
  const pfAge=document.getElementById('pfAge');
  const pfSex=document.getElementById('pfSex');
  const pfHt=document.getElementById('pfHt');
  const pfWt=document.getElementById('pfWt');
  const pfTA=document.getElementById('pfTA');
  const pfRHR=document.getElementById('pfRHR');
  const pfMHR=document.getElementById('pfMHR');
  const pfSport=document.getElementById('pfSport');
  const pfGoal=document.getElementById('pfGoal');
  const pfAvail=document.getElementById('pfAvail');
  
  // Auto-calculate Max HR when age changes (using Tanaka formula - most accurate)
  pfAge.addEventListener('input', function() {
    const age = parseFloat(pfAge.value);
    if(age && age >= 5 && age <= 100) {
      // Tanaka formula (2001): 208 - (0.7 √ó age) - most accurate for adults
      const maxHR = Math.round(208 - (0.7 * age));
      pfMHR.placeholder = `auto: ${maxHR} bpm (Tanaka formula)`;
      // Always update if empty (auto-calculation mode)
      if(!pfMHR.value) {
        pfMHR.value = maxHR;
      }
    } else {
      pfMHR.placeholder = 'auto from age';
      // Clear max HR if age is cleared and it was auto-calculated
      if(!pfAge.value && pfMHR.value) {
        const savedProfile = LS.get('elite_profile', {});
        // Only clear if it's not a saved manual override
        if(!savedProfile.mhr) {
          pfMHR.value = '';
        }
      }
    }
  });
  
  // Allow user to clear Max HR to return to auto-calculation
  pfMHR.addEventListener('input', function() {
    if(!pfMHR.value && pfAge.value) {
      // Re-trigger age calculation when Max HR is cleared
      pfAge.dispatchEvent(new Event('input'));
    }
  });
  
  document.getElementById('profileBtn').onclick=()=>{
    const p=LS.get('elite_profile',{});
    pfAge.value=p.age||''; pfSex.value=p.sex||''; pfHt.value=p.ht||''; pfWt.value=p.wt||'';
    pfTA.value=p.ta||''; pfRHR.value=p.rhr||''; pfMHR.value=p.mhr||''; pfSport.value=p.sport||''; pfGoal.value=p.goal||''; pfAvail.value=p.avail||'';
    
    // Trigger max HR calculation if age exists but max HR doesn't
    if(pfAge.value && !pfMHR.value) {
      pfAge.dispatchEvent(new Event('input'));
    }
    
    profileModal.classList.add('show');
  };
  function closeProfile(){profileModal.classList.remove('show')}
  function saveProfile(){
    const p={age:fmt(pfAge.value),sex:pfSex.value,ht:fmt(pfHt.value),wt:fmt(pfWt.value),ta:fmt(pfTA.value),
      rhr:fmt(pfRHR.value),mhr:fmt(pfMHR.value),sport:pfSport.value,goal:pfGoal.value,avail:fmt(pfAvail.value)};
    LS.set('elite_profile',p); renderZoneChips(); profileModal.classList.remove('show');
  }

  let curKey=null;
  const dayModal=document.getElementById('dayModal');
  function openDay(date){
    curKey=toKey(date);
    document.getElementById('dayTitle').textContent=date.toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    ['mChest','mBack','mLegs','mTrack','mBike','mBJJ','mWalk'].forEach(id=>document.getElementById(id).checked=false);
    ['secChest','secBack','secLegs','secTrack','secBike','secBJJ','secWalk'].forEach(id=>document.getElementById(id).style.display='none');
    const saved=store[curKey];
    if(saved){
      Object.keys(saved.modalities||{}).forEach(k=>{
        const map={chest:'mChest',back:'mBack',legs:'mLegs',track:'mTrack',bike:'mBike',bjj:'mBJJ',walking:'mWalk'};
        const id=map[k]; if(id){document.getElementById(id).checked=true; toggleSection('sec'+k.charAt(0).toUpperCase()+k.slice(1))}
      });
      hydrateStrength('chestBox',saved.modalities?.chest);
      hydrateStrength('backBox',saved.modalities?.back);
      hydrateStrength('legsBox',saved.modalities?.legs);
      hydrateTrack(saved.modalities?.track);
      hydrateBike(saved.modalities?.bike);
      hydrateBJJ(saved.modalities?.bjj);
      hydrateWalk(saved.modalities?.walking);
      setKPIs(saved);
    }else{
      initStrength('chestBox'); initStrength('backBox'); initStrength('legsBox');
      resetTrack(); resetBike(); resetBJJ(); resetWalk();
      setKPIs({totalCNS:0,tss:0,totalVolume:0});
    }
    dayModal.classList.add('show');
  }
  function setKPIs(d){document.getElementById('kpiCNS').textContent=Math.round(d.totalCNS||0);
    document.getElementById('kpiTSS').textContent=Math.round(d.tss||0);
    document.getElementById('kpiVOL').textContent=Math.round(d.totalVolume||0);}
  function closeDay(){dayModal.classList.remove('show')}
  function toggleSection(id){const el=document.getElementById(id); el.style.display=(el.style.display==='none'?'block':'none')}

  function initStrength(targetId){
    const box=document.getElementById(targetId);
    box.innerHTML=`
      <div class="row" style="margin-bottom:6px">
        <button class="btn primary" onclick="addExercise('${targetId}')">+ Add Exercise</button>
        <div class="muted sm">Then "+ Add Set" under each exercise.</div>
      </div>
      <div class="muted sm">Enter working sets only. Volume = Œ£ weight√óreps.</div>
      <div id="${targetId}-list"></div>`;
  }
  function hydrateStrength(targetId,data){
    initStrength(targetId);
    (data?.exercises||[{name:'',sets:[{w:'',r:'',rpe:''},{w:'',r:'',rpe:''}]}]).forEach(ex=>{
      addExercise(targetId,ex);
    });
  }
  function addExercise(targetId, preset){
    const list=document.getElementById(`${targetId}-list`);
    const idx=list.children.length+1;
    const ex=document.createElement('div');
    ex.className='sec'; ex.innerHTML=`
      <div class="hd">Exercise ${idx}</div>
      <div class="bd">
        <div class="grid2">
          <div><label>Name</label><input class="ex-name" value="${preset?.name||''}" placeholder="Bench Press"></div>
          <div><label>Muscle Group</label>
            <select class="ex-muscle">
              <option></option><option>Chest</option><option>Back</option><option>Shoulders</option><option>Biceps</option><option>Triceps</option><option>Quads</option><option>Hamstrings</option><option>Glutes</option><option>Calves</option><option>Core</option>
            </select>
          </div>
        </div>
        <table class="sm" style="margin-top:8px">
          <thead><tr><th>Weight (lb)</th><th>Reps</th><th>RPE</th><th></th></tr></thead>
          <tbody class="setBody"></tbody>
        </table>
        <button class="btn" onclick="addSet(this)">+ Add Set</button>
      </div>`;
    list.appendChild(ex);
    const sb=ex.querySelector('.setBody');
    (preset?.sets||Array.from({length:3}).map(_=>({w:'',r:'',rpe:''}))).forEach(s=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><input class="w" type="number" inputmode="decimal" step="0.1" value="${s.w}"></td>
        <td><input class="r" type="number" value="${s.r}"></td>
        <td><input class="p" type="number" step="0.5" value="${s.rpe}"></td>
        <td><button class="btn" onclick="this.closest('tr').remove()">üóë</button></td>`;
      sb.appendChild(tr);
    });
  }
  function addSet(btn){
    const sb=btn.closest('.bd').querySelector('.setBody');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input class="w" type="number" inputmode="decimal" step="0.1"></td>
      <td><input class="r" type="number"></td>
      <td><input class="p" type="number" step="0.5"></td>
      <td><button class="btn" onclick="this.closest('tr').remove()">üóë</button></td>`;
    sb.appendChild(tr);
  }
  function collectStrength(targetId){
    const list=document.getElementById(`${targetId}-list`);
    const exEls=[...list.querySelectorAll('.sec')];
    const exercises=exEls.map(sec=>{
      const name=sec.querySelector('.ex-name').value.trim();
      const sets=[...sec.querySelectorAll('.setBody tr')].map(tr=>({w:fmt(tr.querySelector('.w').value),r:fmt(tr.querySelector('.r').value),rpe:fmt(tr.querySelector('.p').value)})).filter(s=>s.w>0&&s.r>0);
      return name && sets.length?{name,sets}:null;
    }).filter(Boolean);
    if(!exercises.length) return null;
    let vol=0, rpeSum=0, rpeCnt=0;
    exercises.forEach(ex=>ex.sets.forEach(s=>{vol+=s.w*s.r; if(s.rpe){rpeSum+=s.rpe; rpeCnt++}}));
    const avgRPE=rpeCnt? rpeSum/rpeCnt : 0;
    let cns=40 + (avgRPE>=9?15:avgRPE>=8.5?10:avgRPE<=7?-8:0);
    const tss = Math.round(60 * (avgRPE/10) * 100);
    return {exercises, volume:vol, cnsScore:clamp(cns,0,100), tss};
  }

  function resetTrack(){
    trkSleep.value=''; trkAch.value='';
    document.getElementById('trkPrev').innerHTML='No image';
    document.getElementById('trackExercises').innerHTML='';
    document.querySelectorAll('.warmupCheck').forEach(cb => cb.checked = false);
    updateWarmupProgress();
    ['trkAvgHR','trkPeakHR','trkZ5','trkZ4'].forEach(id=>document.getElementById(id).value='');
  }
  
  function updateWarmupProgress(){
    const checks = document.querySelectorAll('.warmupCheck');
    const completed = [...checks].filter(cb => cb.checked).length;
    const total = checks.length;
    const progress = document.getElementById('warmupProgress');
    if(progress) {
      progress.textContent = `${completed}/${total} Complete`;
      if(completed === total) {
        progress.style.color = '#38ef7d';
        progress.textContent = '‚úì ' + progress.textContent;
      } else {
        progress.style.color = '#ffbb33';
      }
    }
  }
  
  function hydrateTrack(d){
    resetTrack();
    if(!d) return;
    trkSleep.value=d.sleep||''; trkAch.value=d.ach||'';
    
    if(d.warmupChecks) {
      const checks = document.querySelectorAll('.warmupCheck');
      d.warmupChecks.forEach((checked, idx) => {
        if(checks[idx]) checks[idx].checked = checked;
      });
      updateWarmupProgress();
    }
    
    if(d.hr){
      trkAvgHR.value=d.hr.avg||''; trkPeakHR.value=d.hr.peak||''; 
      trkZ5.value=d.hr.z5||''; trkZ4.value=d.hr.z4||'';
    }
    
    (d.exercises||[]).forEach(ex => addTrackExercise(ex));
  }
  
  function addTrackExercise(data={}){
    const container = document.getElementById('trackExercises');
    const exerciseNum = container.children.length + 1;
    
    const exerciseDiv = document.createElement('div');
    exerciseDiv.className = 'sec';
    exerciseDiv.style.cssText = 'margin-top:10px;background:#0d1714;border:1px solid #1e6a4f;position:relative';
    
    exerciseDiv.innerHTML = `
      <button class="btn" onclick="this.closest('.sec').remove()" style="position:absolute;top:8px;right:8px;padding:4px 8px;font-size:11px">üóë Remove</button>
      <div class="hd" style="background:#0f1b17;border-bottom:1px solid #1e6a4f;color:#9de8c5">
        Exercise #${exerciseNum}
      </div>
      <div class="bd">
        <div class="grid2">
          <div style="grid-column:span 2">
            <label>Exercise Name</label>
            <input class="exName" type="text" value="${data.name||''}" placeholder="e.g., Broad Jump, Single Leg Stair Jump">
          </div>
          <div>
            <label>Type</label>
            <select class="exType" onchange="toggleExerciseFields(this)">
              <option value="bilateral" ${(!data.type || data.type==='bilateral')?'selected':''}>Bilateral (both legs)</option>
              <option value="unilateral" ${data.type==='unilateral'?'selected':''}>Unilateral (single leg)</option>
            </select>
          </div>
          <div>
            <label>Sets</label>
            <input class="exSets" type="number" min="1" value="${data.sets||''}" placeholder="e.g., 4">
          </div>
          <div class="bilateralFields" ${data.type==='unilateral'?'style="display:none"':''}>
            <label>Reps per set</label>
            <input class="exReps" type="number" min="1" value="${data.reps||''}" placeholder="e.g., 34">
          </div>
          <div class="unilateralFields" ${data.type==='unilateral'?'':'style="display:none"'}>
            <label>R Leg reps per set</label>
            <input class="exRepsRight" type="number" min="1" value="${data.repsRight||''}" placeholder="e.g., 21">
          </div>
          <div class="unilateralFields" ${data.type==='unilateral'?'':'style="display:none"'}>
            <label>L Leg reps per set</label>
            <input class="exRepsLeft" type="number" min="1" value="${data.repsLeft||''}" placeholder="e.g., 21">
          </div>
          <div>
            <label>RPE (1-10)</label>
            <input class="exRPE" type="number" step="0.5" min="1" max="10" value="${data.rpe||''}" placeholder="8">
          </div>
          <div>
            <label>Time (MM:SS)</label>
            <input class="exTime" type="text" value="${data.time||''}" placeholder="00:30">
          </div>
          <div style="grid-column:span 2">
            <label>Notes</label>
            <input class="exNotes" type="text" value="${data.notes||''}" placeholder="Optional notes">
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(exerciseDiv);
  }
  
  function toggleExerciseFields(selectEl){
    const parent = selectEl.closest('.sec');
    const type = selectEl.value;
    
    const bilateralFields = parent.querySelectorAll('.bilateralFields');
    const unilateralFields = parent.querySelectorAll('.unilateralFields');
    
    if(type === 'bilateral') {
      bilateralFields.forEach(f => f.style.display = 'block');
      unilateralFields.forEach(f => f.style.display = 'none');
    } else {
      bilateralFields.forEach(f => f.style.display = 'none');
      unilateralFields.forEach(f => f.style.display = 'block');
    }
  }
  
  function collectTrack(){
    if(!document.getElementById('mTrack').checked) return null;
    
    const warmupChecks = [...document.querySelectorAll('.warmupCheck')].map(cb => cb.checked);
    
    const exercises = [...document.querySelectorAll('#trackExercises .sec')].map(exDiv => {
      const name = exDiv.querySelector('.exName').value;
      const type = exDiv.querySelector('.exType').value;
      const sets = fmt(exDiv.querySelector('.exSets').value);
      const rpe = fmt(exDiv.querySelector('.exRPE').value);
      const time = exDiv.querySelector('.exTime').value;
      const notes = exDiv.querySelector('.exNotes').value;
      
      let totalReps = 0;
      const ex = { name, type, sets, rpe, time, notes };
      
      if(type === 'bilateral') {
        const reps = fmt(exDiv.querySelector('.exReps').value);
        ex.reps = reps;
        totalReps = sets * reps;
      } else {
        const repsRight = fmt(exDiv.querySelector('.exRepsRight').value);
        const repsLeft = fmt(exDiv.querySelector('.exRepsLeft').value);
        ex.repsRight = repsRight;
        ex.repsLeft = repsLeft;
        totalReps = sets * (repsRight + repsLeft);
      }
      
      ex.totalReps = totalReps;
      return ex;
    }).filter(ex => ex.name && ex.sets > 0);
    
    if(!exercises.length) return null;
    
    const totalContacts = exercises.reduce((sum, ex) => sum + ex.totalReps, 0);
    const avgRPE = exercises.filter(ex=>ex.rpe>0).reduce((s,ex)=>s+ex.rpe,0) / exercises.filter(ex=>ex.rpe>0).length || 0;
    
    let cns=35 + (fmt(trkSleep.value)<7?12:0) + (trkAch.value==='Sore'?25:trkAch.value==='Tight'?12:0);
    if(totalContacts>350) cns+=15;
    if(avgRPE>=9) cns+=20;
    else if(avgRPE>=8) cns+=12;
    else if(avgRPE>=7) cns+=8;
    
    const tss = Math.round(60 + totalContacts*0.12 + (avgRPE*5));
    const hr={avg:fmt(trkAvgHR.value),peak:fmt(trkPeakHR.value),z5:fmt(trkZ5.value),z4:fmt(trkZ4.value)};
    
    return {
      sleep:fmt(trkSleep.value), 
      ach:trkAch.value, 
      warmupChecks, 
      exercises,
      contacts:totalContacts, 
      avgRPE, 
      cnsScore:clamp(cns,0,100), 
      tss, 
      hr
    };
  }

  const bikeProto=document.getElementById('bikeProto');
  const bikeTarget=document.getElementById('bikeTarget');
  const bikeRounds=document.getElementById('bikeRounds');
  const bikeWork=document.getElementById('bikeWork');
  const bikeRest=document.getElementById('bikeRest');
  const bikeSleep=document.getElementById('bikeSleep');
  const bikeCap=document.getElementById('bikeCap');
  const roundBlock=document.getElementById('roundBlock');
  const workBlock=document.getElementById('workBlock');
  const restBlock=document.getElementById('restBlock');
  const timeCapBlock=document.getElementById('timeCapBlock');
  const c2Buttons=document.getElementById('c2Buttons');

  function resetBike(){
    bikeProto.value='peak'; bikeRounds.value=6; bikeWork.value=20; bikeRest.value=100; bikeTarget.value=''; bikeSleep.value='';
    document.querySelector('#bikeTable tbody').innerHTML='';
    seedBikeRows();
    document.getElementById('bikePrev').innerHTML='No image';
    if(document.getElementById('bikeTotalTime')) document.getElementById('bikeTotalTime').value = '';
    applyBikeUI();
    updateProtocolInstructions();
  }
  
  function hydrateBike(d){ 
    resetBike(); 
    if(!d) return;
    bikeProto.value=d.proto || 'peak'; 
    applyBikeUI();
    updateProtocolInstructions();
    if(d.proto==='c2'){ bikeCap.value=d.cap||25; }
    else { bikeRounds.value=d.rounds; bikeWork.value=d.work; bikeRest.value=d.rest; }
    bikeTarget.value=d.target; bikeSleep.value=d.sleep||'';
    if(d.totalTime && document.getElementById('bikeTotalTime')) {
      document.getElementById('bikeTotalTime').value = d.totalTime;
    }
    const tb=document.querySelector('#bikeTable tbody'); 
    tb.innerHTML=''; 
    (d.roundData||[]).forEach(r=>addBikeRow(r));
  }
  
  function seedBikeRows(){ 
    const r=fmt(bikeRounds.value)||6; 
    const tb=document.querySelector('#bikeTable tbody'); 
    tb.innerHTML='';
    for(let i=1;i<=r;i++) addBikeRow({}); 
  }
  
  bikeRounds?.addEventListener('change',()=>{ if(bikeProto.value!=='c2') seedBikeRows(); });
  bikeProto?.addEventListener('change',applyBikeUI);
  
  function updateProtocolInstructions(){
    const protocol = bikeProto.value;
    const instructionsEl = document.getElementById('protocolInstructions');
    if(!instructionsEl) return;
    
    const instructions = {
      'c1': `<b>C1 ‚Äî Max RPM per round (Speed Test)</b><br><br>
        <b>Goal:</b> Hit your MAX RPM in the SHORTEST amount of time possible<br>
        <b>Intensity:</b> MAX EFFORT - all-out sprint<br>
        <b>What it tests:</b> Explosive power and acceleration capacity<br>
        <b>How to do it:</b><br>
        1. Sprint as hard as possible to reach max RPM<br>
        2. Once you hit max RPM, stop<br>
        3. Rest 2 minutes (active recovery - easy pedaling)<br>
        4. Repeat<br>
        <b>Track:</b> Max RPM achieved and time to reach it<br>
        <b>Success:</b> Reaching max RPM faster over time, or hitting higher max RPM<br>
        <b>Rest:</b> 2 minutes active recovery between sprints`,
        
      'c2': `<b>C2 ‚Äî Max RPM ‚Üí Zone 5 Hold ‚Üí Stop</b><br><br>
        <b>What it is:</b> Sprint to max, downshift to sustain Zone 5+, then stop and recover<br>
        <b>Intensity:</b> Zone 5+ (90%+ max HR) - sustained after initial sprint<br>
        <b>What it tests:</b> Anaerobic capacity and heart rate recovery<br>
        <b>How to do it:</b><br>
        1. Sprint to absolute max RPM<br>
        2. ONCE max RPM is achieved, downshift to a speed you can SUSTAIN<br>
        3. Hold that sustainable pace to keep HR at Zone 5+ (90%+ max HR)<br>
        4. STOP completely when you can't maintain Zone 5 (90%+ HR)<br>
        5. Rest until HR drops to Zone 2 OR 3 minutes (WHICHEVER COMES FIRST)<br>
        6. Repeat<br>
        <b>Target HR Field:</b> Shows 90 (meaning 90% of max HR = Zone 5)<br>
        <b>Track:</b> Max RPM, Time in Zone 5, Total rep time, Time to Zone 2<br>
        <b>‚ö†Ô∏è This is the ONLY protocol where you STOP during rest - don't pedal!</b><br>
        <b>Key:</b> The downshift lets you sustain Z5 longer than staying at max RPM`,
        
      'c3': `<b>C3 ‚Äî Alternating Max Effort / Submaximal (30s Hold)</b><br><br>
        <b>What it is:</b> Alternate between all-out sprints and 70% sustained efforts<br>
        <b>Intensity:</b> MAX EFFORT on sprint reps, 70% effort on submaximal reps<br>
        <b>What it tests:</b> Power output variance and recovery between different intensities<br>
        <b>How to do it:</b><br>
        <b>Rep 1 (ALL OUT):</b><br>
        ‚Ä¢ Sprint to absolute max RPM (MAX EFFORT)<br>
        ‚Ä¢ Rest 3 minutes (active recovery - easy pedaling)<br>
        <b>Rep 2 (70% for 30 seconds):</b><br>
        ‚Ä¢ 70% of max RPM (or preferred pace) held for 30 seconds<br>
        ‚Ä¢ Rest 3 minutes (active recovery - easy pedaling)<br>
        <b>Rep 3 (ALL OUT):</b><br>
        ‚Ä¢ Sprint to absolute max RPM again<br>
        ‚Ä¢ Rest 3 minutes<br>
        <b>Rep 4 (70% for 30 seconds):</b><br>
        ‚Ä¢ 70% held for 30 seconds<br>
        ‚Ä¢ Rest 3 minutes<br>
        <b>Continue alternating...</b><br>
        <b>Rest:</b> 3 minutes after EACH rep (both max and 70%)<br>
        <b>Track:</b> Max RPM on all-out reps, consistency on 70% reps`,
        
      'steady': `<b>Steady Zone 2 (Aerobic Base)</b><br><br>
        <b>What it is:</b> Sustained 20-40min at 130-150 BPM (Zone 2)<br>
        <b>Intensity:</b> 130-150 BPM (Zone 2) - easy, conversational pace<br>
        <b>Goal:</b> Build aerobic base and fat oxidation capacity<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Mitochondrial density<br>
        ‚Ä¢ Fat metabolism<br>
        ‚Ä¢ Recovery capacity<br>
        ‚Ä¢ Cardiac efficiency<br>
        <b>How to do it:</b> Maintain steady 130-150 BPM for entire duration. Should feel conversational - you can talk in full sentences.<br>
        <b>Target HR:</b> Keep heart rate between 130-150 BPM throughout (NOT a percentage - actual BPM range)<br>
        <b>When to use:</b> Recovery days, aerobic base building phases, active recovery between hard sessions`,
        
      'alt': `<b>Alt 30s Hard / 30s Easy</b><br><br>
        <b>What it is:</b> Alternate hard/easy every 30 seconds for 6-10 rounds<br>
        <b>Intensity:</b> 80-85% max HR during hard intervals<br>
        <b>Goal:</b> Classic HIIT conditioning<br>
        <b>What it develops:</b> Cardiovascular fitness, work capacity, mental toughness<br>
        <b>How to do it:</b><br>
        ‚Ä¢ 30s: Hard effort (80-85% max HR)<br>
        ‚Ä¢ 30s: Easy pedaling (active recovery)<br>
        ‚Ä¢ Repeat for 6-10 rounds<br>
        <b>Target HR Field:</b> Shows 82 (meaning 82% of max HR during hard intervals)<br>
        <b>‚ö†Ô∏è "Easy" means EASY PEDALING, not stopping!</b><br>
        <b>Tip:</b> Keep your hard efforts consistent - don't blow out on round 1`,
        
      'z5': `<b>Zone 5 Intervals</b><br><br>
        <b>What it is:</b> Push into 90%+ max HR, recover fully between intervals<br>
        <b>Intensity:</b> 90%+ max HR (Zone 5) during work intervals<br>
        <b>Goal:</b> Improve VO2 max and anaerobic threshold<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Maximum oxygen uptake<br>
        ‚Ä¢ Anaerobic threshold<br>
        ‚Ä¢ High-end cardiovascular capacity<br>
        <b>How to do it:</b><br>
        1. Push HR to 90%+ of max (Zone 5)<br>
        2. Hold for prescribed work time<br>
        3. Easy pedaling until HR drops to recovery zone<br>
        4. Repeat<br>
        <b>Target HR Field:</b> Shows 92 (meaning 92% of max HR = Zone 5)<br>
        <b>Rest:</b> Active recovery until HR recovers - typically 1.5-2x work time`,
        
      'peak': `<b>Peak RPM Sprints</b><br><br>
        <b>What it is:</b> Short max-effort bursts with full recovery<br>
        <b>Intensity:</b> MAX EFFORT - all-out sprints<br>
        <b>Goal:</b> Develop peak power output and ATP-PC energy system<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Maximum power output<br>
        ‚Ä¢ Fast-twitch muscle fiber recruitment<br>
        ‚Ä¢ Neural drive<br>
        ‚Ä¢ Explosive capacity<br>
        <b>How to do it:</b><br>
        ‚Ä¢ Work: 10-20 seconds ABSOLUTE MAX effort<br>
        ‚Ä¢ Rest: 1.5-2 minutes easy pedaling (full recovery)<br>
        ‚Ä¢ 6-10 rounds<br>
        <b>Key:</b> Each rep should be MAXIMUM quality. If power drops significantly, you need more rest.`,
        
      'ngannou': `<b>ü•ä Ngannou Power (UFC PI Protocol)</b><br><br>
        <b>What it is:</b> 10 rounds of 30s all-out / 30s active recovery<br>
        <b>Intensity:</b> ALL-OUT maximum effort - aim for consistency across all rounds<br>
        <b>Goal:</b> Maintain SAME power output all 10 rounds without decay<br>
        <b>What it tests:</b> Ability to produce high force repeatedly (fight simulation)<br>
        <b>How to do it:</b><br>
        1. 30 seconds: ALL-OUT maximum effort<br>
        2. 30 seconds: EASY PEDALING (active recovery - DON'T STOP!)<br>
        3. Repeat for 10 total rounds<br>
        <b>Success metric:</b> Calories & watts should be consistent across all 10 rounds. If round 10 drops significantly below round 1, you went too hard early.<br>
        <b>‚ö†Ô∏è Keep pedaling lightly during "rest" - stopping causes blood pooling!</b><br>
        <b>Used by:</b> Francis Ngannou at UFC Performance Institute`,
        
      'progressive': `<b>üìà Progressive Calorie (UFC PI Protocol)</b><br><br>
        <b>What it is:</b> Single 5-minute continuous effort<br>
        <b>Intensity:</b> 75-80% max HR - sustained moderate-hard effort<br>
        <b>Goal:</b> Hit target calories, increase 3-4 cals/week<br>
        <b>What it develops:</b> Sustained aerobic power, progressive overload<br>
        <b>How to do it:</b><br>
        Week 1: 65 calories in 5 minutes (75-80% max HR)<br>
        Week 2: 68-69 calories in 5 minutes<br>
        Week 3: 71-73 calories in 5 minutes<br>
        Continue adding 3-4 cals/week<br>
        <b>Target HR Field:</b> Shows 78 (meaning 78% of max HR - sustained effort)<br>
        <b>Key:</b> Pace yourself to hit the target - don't sprint and fade. Smooth, sustained effort for full 5 minutes.<br>
        <b>No stopping</b> - continuous pedaling for entire 5 minutes`,
        
      'extended': `<b>‚è±Ô∏è Extended Capacity (UFC PI Protocol)</b><br><br>
        <b>What it is:</b> 6 rounds of 5min continuous / 2min active recovery<br>
        <b>Intensity:</b> 75-80% max HR - moderate-hard sustained effort<br>
        <b>Goal:</b> Simulate extended fight rounds, build mental toughness<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Sustained work capacity<br>
        ‚Ä¢ Mental toughness under fatigue<br>
        ‚Ä¢ Ability to maintain output in later rounds<br>
        <b>How to do it:</b><br>
        ‚Ä¢ 5 minutes: Moderate-hard continuous effort at 75-80% max HR<br>
        ‚Ä¢ 2 minutes: EASY PEDALING (active recovery - don't stop!)<br>
        ‚Ä¢ Repeat 6 times<br>
        <b>Target HR Field:</b> Shows 78 (meaning 78% of max HR during 5min work periods)<br>
        <b>Strategy:</b> Find a pace you can maintain for all 6 rounds. Round 6 should look like round 1.<br>
        <b>‚ö†Ô∏è Keep moving during 2min recovery periods!</b>`,
        
      'tabata': `<b>‚ö° Tabata (UFC PI Protocol)</b><br><br>
        <b>What it is:</b> 8 rounds of 20s max / 10s active recovery (4min total)<br>
        <b>Intensity:</b> MAX EFFORT - will hit 95%+ max HR<br>
        <b>Goal:</b> Anaerobic conditioning and EPOC (after-burn effect)<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Anaerobic capacity<br>
        ‚Ä¢ VO2 max<br>
        ‚Ä¢ Post-exercise calorie burn (EPOC)<br>
        <b>How to do it:</b><br>
        1. 20 seconds: MAXIMUM effort (will reach 95%+ max HR)<br>
        2. 10 seconds: EASY PEDALING (active recovery - don't stop!)<br>
        3. Repeat 8 times (4 minutes total)<br>
        <b>It should hurt:</b> This is SUPPOSED to be brutal. By round 6-7 you should be struggling.<br>
        <b>‚ö†Ô∏è Keep pedaling lightly during 10s "rest" - don't stop!<br>
        <b>Classic research protocol</b> proven to improve both aerobic and anaerobic systems`,
        
      'sprints': `<b>üí® Power Sprints (UFC PI Protocol)</b><br><br>
        <b>What it is:</b> 10s max effort / 50s active recovery for 6-10 rounds<br>
        <b>Intensity:</b> MAX EFFORT - ATP-PC system (explosive)<br>
        <b>Goal:</b> Develop ATP-PC energy system and peak power<br>
        <b>What it develops:</b><br>
        ‚Ä¢ Explosive power<br>
        ‚Ä¢ Fast-twitch fiber recruitment<br>
        ‚Ä¢ ATP-PC system (phosphagen)<br>
        ‚Ä¢ Neural drive<br>
        <b>How to do it:</b><br>
        1. 10 seconds: ABSOLUTE MAXIMUM sprint<br>
        2. 50 seconds: EASY PEDALING (active recovery)<br>
        3. Repeat 6-10 times<br>
        <b>Power requirements:</b><br>
        ‚Ä¢ Men: 1000+ watts for effectiveness<br>
        ‚Ä¢ Women: 650+ watts for effectiveness<br>
        <b>If below these numbers:</b> Build absolute strength first - this protocol won't be effective<br>
        <b>‚ö†Ô∏è Easy pedaling during rest allows better recovery for next max sprint!</b>`
    };
    
    instructionsEl.innerHTML = instructions[protocol] || 'Select a protocol to see detailed instructions...';
  }
  
  function applyBikeUI(){
    const p=bikeProto.value;
    
    // Update protocol instructions
    updateProtocolInstructions();
    
    // Protocol-specific configurations
    const configs = {
      'c1': { rounds: 6, work: 0, rest: 120, showWork: false, showRest: false, showCap: false, targetHR: '', hrNote: 'Max effort' },
      'c2': { rounds: 0, work: 0, rest: 0, showWork: false, showRest: false, showCap: true, targetHR: '90', hrNote: 'Zone 5+ (90%+ max HR)' },
      'c3': { rounds: 6, work: 0, rest: 180, showWork: false, showRest: false, showCap: false, targetHR: '', hrNote: 'Max effort (all-out reps)' },
      'steady': { rounds: 1, work: 1800, rest: 0, showWork: true, showRest: false, showCap: false, targetHR: '', hrNote: '130-150 BPM (Zone 2)' },
      'alt': { rounds: 10, work: 30, rest: 30, showWork: true, showRest: true, showCap: false, targetHR: '82', hrNote: '80-85% max HR during hard intervals' },
      'z5': { rounds: 6, work: 60, rest: 120, showWork: true, showRest: true, showCap: false, targetHR: '92', hrNote: '90%+ max HR (Zone 5)' },
      'peak': { rounds: 6, work: 20, rest: 100, showWork: true, showRest: true, showCap: false, targetHR: '', hrNote: 'Max effort' },
      'ngannou': { rounds: 10, work: 30, rest: 30, showWork: true, showRest: true, showCap: false, targetHR: '', hrNote: 'All-out max effort (aim for consistency)' },
      'progressive': { rounds: 1, work: 300, rest: 0, showWork: true, showRest: false, showCap: false, targetHR: '78', hrNote: '75-80% max HR (sustained)' },
      'extended': { rounds: 6, work: 300, rest: 120, showWork: true, showRest: true, showCap: false, targetHR: '78', hrNote: '75-80% max HR (moderate-hard)' },
      'tabata': { rounds: 8, work: 20, rest: 10, showWork: true, showRest: true, showCap: false, targetHR: '', hrNote: 'Max effort (will hit 95%+)' },
      'sprints': { rounds: 10, work: 10, rest: 50, showWork: true, showRest: true, showCap: false, targetHR: '', hrNote: 'Max effort (ATP-PC system)' }
    };
    
    const config = configs[p] || configs['peak'];
    const capMode = config.showCap;
    
    // Set values ACCURATELY for each protocol
    if(config.rounds > 0) bikeRounds.value = config.rounds;
    if(config.work > 0) bikeWork.value = config.work;
    else if(!config.showWork) bikeWork.value = '';
    if(config.rest > 0) bikeRest.value = config.rest;
    else if(!config.showRest) bikeRest.value = '';
    
    // Set ACCURATE Target HR for each protocol
    if(bikeTarget) {
      bikeTarget.value = config.targetHR;
      
      // Update Target HR placeholder based on protocol
      if(p === 'steady') {
        bikeTarget.placeholder = '130-150 BPM';
        bikeTarget.type = 'text';
      } else if(config.targetHR === '') {
        bikeTarget.placeholder = 'Max effort';
        bikeTarget.type = 'text';
      } else {
        bikeTarget.placeholder = '% of max HR';
        bikeTarget.type = 'number';
      }
    }
    
    // Show/hide fields based on protocol
    if(document.getElementById('timeCapBlock')) {
      document.getElementById('timeCapBlock').style.display = capMode ? 'block':'none';
    }
    if(document.getElementById('roundBlock')) {
      document.getElementById('roundBlock').style.display = (capMode || !config.rounds) ? 'none':'block';
    }
    if(document.getElementById('workBlock')) {
      document.getElementById('workBlock').style.display = config.showWork ? 'block':'none';
    }
    if(document.getElementById('restBlock')) {
      document.getElementById('restBlock').style.display = config.showRest ? 'block':'none';
    }
    if(document.getElementById('c2Buttons')) {
      document.getElementById('c2Buttons').style.display = capMode ? 'flex':'none';
    }
    
    // Update Target HR field label based on protocol
    const targetLabel = document.getElementById('bikeTargetLabel');
    if(targetLabel && config.hrNote) {
      targetLabel.innerHTML = `Target HR <span class="muted sm" style="font-weight:normal">(${config.hrNote})</span>`;
    } else if(targetLabel) {
      targetLabel.innerHTML = 'Target HR';
    }
    
    // Update hints text
    const hintsText = document.getElementById('hintsText');
    const hints = {
      'c1': `<b>C1:</b> "Rounds" = # of max RPM sprints. Work/Rest times hidden (sprint to max + 2min rest each round). <b>Intensity:</b> Max effort.`,
      'c2': `<b>C2:</b> "Time Cap" = session limit. Track reps with "+ Add Rep". Work/Rest times hidden (varies per rep). <b>Target HR:</b> 90% = Zone 5+ during sustained phase.`,
      'c3': `<b>C3:</b> "Rounds" = total reps (alternates max/70%). Work/Rest hidden (max + 3min, then 70% for 30s + 3min). <b>Intensity:</b> Max effort on sprint reps.`,
      'steady': `<b>Steady Z2:</b> Continuous session. "Work" = total duration (1800s = 30min). Rest hidden (no rest periods). <b>Target HR:</b> 130-150 BPM (NOT a % - actual BPM range).`,
      'alt': `<b>Alt 30s/30s:</b> All fields shown. Work = hard (30s), Rest = easy pedaling (30s). <b>Target HR:</b> 82% = 80-85% during hard intervals.`,
      'z5': `<b>Zone 5:</b> All fields shown. Work = Z5 time (60s), Rest = recovery (120s). <b>Target HR:</b> 92% = 90%+ max HR during work intervals.`,
      'peak': `<b>Peak RPM:</b> All fields shown. Work = sprint duration (20s), Rest = recovery (100s). <b>Intensity:</b> Max effort each rep.`,
      'ngannou': `<b>Ngannou:</b> 10 rounds fixed. Work = all-out (30s), Rest = easy pedaling (30s - NOT stopping!). <b>Intensity:</b> All-out, aim for consistency.`,
      'progressive': `<b>Progressive:</b> Single 5min effort. "Work" = 300s (5min). Rest hidden. <b>Target HR:</b> 78% = 75-80% sustained effort.`,
      'extended': `<b>Extended:</b> 6√ó5min rounds. Work = 300s (5min), Rest = 120s (2min easy pedaling). <b>Target HR:</b> 78% = 75-80% during work periods.`,
      'tabata': `<b>Tabata:</b> 8 rounds. Work = max effort (20s), Rest = easy pedaling (10s - NOT stopping!). <b>Intensity:</b> Max effort, will hit 95%+ HR.`,
      'sprints': `<b>Power Sprints:</b> Work = max sprint (10s), Rest = recovery (50s active pedaling). <b>Intensity:</b> Max effort (1000W+ men, 650W+ women).`
    };
    if(hintsText) hintsText.innerHTML = hints[p] || 'Protocol-specific fields shown above.';
    
    // Calculate and show total time
    calculateRoutineTime();
    
    const tb=document.querySelector('#bikeTable tbody');
    tb.innerHTML='';
    if(!capMode){ seedBikeRows(); }
  }
  
  function calculateRoutineTime(){
    const p = bikeProto.value;
    const totalTimeBlock = document.getElementById('totalTimeBlock');
    const routineTimeEl = document.getElementById('bikeRoutineTime');
    
    if(!totalTimeBlock || !routineTimeEl) return;
    
    let totalSeconds = 0;
    
    if(p === 'c1'){
      // C1: rounds √ó (sprint + 2min rest), minus last rest
      const rounds = fmt(bikeRounds.value) || 6;
      totalSeconds = rounds * (10 + 120) - 120; // assume 10s sprint + 2min rest
    } else if(p === 'c2'){
      // C2: time cap
      const cap = fmt(document.getElementById('bikeCap')?.value) || 25;
      totalSeconds = cap * 60;
    } else if(p === 'c3'){
      // C3: alternating rounds, each with 3min rest
      const rounds = fmt(bikeRounds.value) || 6;
      totalSeconds = rounds * (10 + 180) - 180; // assume 10s per rep + 3min rest
    } else if(p === 'steady' || p === 'progressive'){
      // Continuous work, no rest
      totalSeconds = fmt(bikeWork.value) || 0;
    } else {
      // Standard intervals: rounds √ó (work + rest), minus last rest
      const rounds = fmt(bikeRounds.value) || 6;
      const work = fmt(bikeWork.value) || 20;
      const rest = fmt(bikeRest.value) || 100;
      totalSeconds = (rounds * (work + rest)) - rest;
    }
    
    // Format time
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    routineTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Show the time block
    totalTimeBlock.style.display = 'block';
  }
  
  // Add listeners to recalculate time when values change
  if(bikeRounds) bikeRounds.addEventListener('input', calculateRoutineTime);
  if(bikeWork) bikeWork.addEventListener('input', calculateRoutineTime);
  if(bikeRest) bikeRest.addEventListener('input', calculateRoutineTime);
  if(document.getElementById('bikeCap')) document.getElementById('bikeCap').addEventListener('input', calculateRoutineTime);
  
  function addBikeRow(p){
    const tb=document.querySelector('#bikeTable tbody');
    const i=tb.children.length+1;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i}</td>
      <td><input type="number" class="rpmMax" value="${p.rpmMax||''}" style="width:70px"></td>
      <td><input type="number" class="rpmAvg" value="${p.rpmAvg||''}" style="width:70px"></td>
      <td><input type="number" class="cals" value="${p.cals||''}" style="width:60px"></td>
      <td><input type="number" class="watts" value="${p.watts||''}" style="width:70px"></td>
      <td><input type="number" class="tZ5" value="${p.tZ5||''}" style="width:80px"></td>
      <td><input type="number" class="tRep" value="${p.tRep||''}" style="width:90px"></td>
      <td><input type="number" class="tZ2" value="${p.tZ2||''}" style="width:80px"></td>
      <td><input class="noteTxt" value="${p.note||''}" style="width:100px"></td>`;
    tb.appendChild(tr);
  }
  
  function collectBike(){
    if(!document.getElementById('mBike').checked) return null;
    const proto=bikeProto.value;
    const rows=[...document.querySelectorAll('#bikeTable tbody tr')];
    const rd=rows.map(tr=>({
      rpmMax:fmt(tr.querySelector('.rpmMax').value), 
      rpmAvg:fmt(tr.querySelector('.rpmAvg').value),
      cals:fmt(tr.querySelector('.cals')?.value),
      watts:fmt(tr.querySelector('.watts')?.value),
      tZ5:fmt(tr.querySelector('.tZ5').value), 
      tRep:fmt(tr.querySelector('.tRep').value), 
      tZ2:fmt(tr.querySelector('.tZ2').value),
      note:tr.querySelector('.noteTxt').value 
    }));

    let cns = 45 + (fmt(bikeSleep.value)<7?10:0);
    let tss = 0;

    if(proto==='c2'){
      const cap = fmt(bikeCap.value)||25;
      const totalWorkSec = rd.reduce((s,r)=>s+(r.tRep||0),0);
      const avgMax= rd.length? Math.round(rd.reduce((a,b)=>a+b.rpmMax,0)/rd.length) : 0;
      const z5Sec = rd.reduce((s,r)=>s + (r.tZ5>0 ? Math.max(0, Math.min(r.tRep, r.tRep - r.tZ5)) : 0), 0);
      tss = Math.round( (totalWorkSec/60)*90 + (z5Sec/60)*4 );
      if(z5Sec/60>15) cns+=15;
      
      const totalCals = rd.reduce((s,r)=>s+(r.cals||0),0);
      const avgWatts = rd.filter(r=>r.watts).length > 0 ? Math.round(rd.reduce((s,r)=>s+(r.watts||0),0)/rd.filter(r=>r.watts).length) : 0;
      const totalTime = fmt(document.getElementById('bikeTotalTime')?.value);
      
      return {proto, cap, target:fmt(bikeTarget.value), sleep:fmt(bikeSleep.value), totalTime, roundData:rd, avgMax, totalCals, avgWatts, cnsScore:clamp(cns,0,100), tss};
    }else{
      const rounds=fmt(bikeRounds.value)||rd.length||6;
      const avgMax = rd.length? Math.round(rd.reduce((a,b)=>a+b.rpmMax,0)/rd.length) : 0;
      tss = Math.round(rounds*(fmt(bikeWork.value)/60)*90);
      if(rounds>=10) cns+=15;
      
      const totalCals = rd.reduce((s,r)=>s+(r.cals||0),0);
      const avgWatts = rd.filter(r=>r.watts).length > 0 ? Math.round(rd.reduce((s,r)=>s+(r.watts||0),0)/rd.filter(r=>r.watts).length) : 0;
      const totalTime = fmt(document.getElementById('bikeTotalTime')?.value);
      
      return {proto, rounds, work:fmt(bikeWork.value), rest:fmt(bikeRest.value), target:fmt(bikeTarget.value),
        sleep:fmt(bikeSleep.value), totalTime, roundData:rd, avgMax, totalCals, avgWatts, cnsScore:clamp(cns,0,100), tss};
    }
  }

  function resetBJJ(){['bjjTime','bjjInt','bjjW1','bjjW2','bjjFeel','bjjSleep'].forEach(id=>{const el=document.getElementById(id); if(el.tagName==='SELECT')el.value=''; else el.value='';});}
  function hydrateBJJ(d){resetBJJ(); if(!d) return; bjjTime.value=d.time||''; bjjInt.value=d.intensity||''; bjjW1.value=d.w1||''; bjjW2.value=d.w2||''; bjjFeel.value=d.feel||''; bjjSleep.value=d.sleep||'';}
  function collectBJJ(){
    if(!document.getElementById('mBJJ').checked) return null;
    const time=fmt(bjjTime.value); if(!time) return null;
    const sweat=fmt(bjjW1.value)-fmt(bjjW2.value);
    let cns=40+(sweat>=4?20:sweat>=3?10:0)+(bjjInt.value==='High'?15:0)+(bjjFeel.value==='Beat'?20:bjjFeel.value==='Tired'?12:0)+(fmt(bjjSleep.value)<7?10:0);
    const tss=Math.round(time*1.5+(bjjInt.value==='High'?30:0));
    return {time,intensity:bjjInt.value,w1:fmt(bjjW1.value),w2:fmt(bjjW2.value),feel:bjjFeel.value,sleep:fmt(bjjSleep.value),cnsScore:clamp(cns,0,100),tss};
  }
  function resetWalk(){['wDur','wDist','wPace'].forEach(id=>document.getElementById(id).value=''); wTer.value='Flat'; wPur.value='Recovery';}
  function hydrateWalk(d){resetWalk(); if(!d) return; wDur.value=d.dur||''; wDist.value=d.dist||''; wPace.value=d.pace||''; wTer.value=d.ter||'Flat'; wPur.value=d.pur||'Recovery';}
  function collectWalk(){
    if(!document.getElementById('mWalk').checked) return null;
    const dur=fmt(wDur.value); const tss=Math.round(dur*0.5); let cns=10+(wTer.value==='Steep'?15:wTer.value==='Hills'?8:0);
    return {dur,dist:fmt(wDist.value),pace:fmt(wPace.value),ter:wTer.value,pur:wPur.value,cnsScore:clamp(cns,0,100),tss};
  }

  function previewImg(input, targetId){
    const box=document.getElementById(targetId);
    const f=input.files?.[0]; if(!f){box.textContent='No image';return}
    const reader=new FileReader(); reader.onload=()=>{box.innerHTML=`<img src="${reader.result}" alt="preview">`}; reader.readAsDataURL(f);
  }

  function saveDay(){
    const day={modalities:{}};
    const chest=collectStrength('chestBox'); if(chest) day.modalities.chest=chest;
    const back=collectStrength('backBox'); if(back) day.modalities.back=back;
    const legs=collectStrength('legsBox'); if(legs) day.modalities.legs=legs;
    const track=collectTrack(); if(track) day.modalities.track=track;
    const bike=collectBike(); if(bike) day.modalities.bike=bike;
    const bjj=collectBJJ(); if(bjj) day.modalities.bjj=bjj;
    const walk=collectWalk(); if(walk) day.modalities.walking=walk;
    if(Object.keys(day.modalities).length===0){document.getElementById('saveNote').textContent='Select at least one modality.'; return}
    let CNS=0,VOL=0,TSS=0;
    Object.values(day.modalities).forEach(m=>{CNS+=fmt(m.cnsScore); VOL+=fmt(m.volume); TSS+=fmt(m.tss)});
    
    // Adjust TSS/CNS based on sport focus
    const profile = LS.get('elite_profile', {});
    const sportFocus = profile.sport || '';
    const adjustments = getAdjustmentFactors(sportFocus, day.modalities);
    
    CNS = Math.round(CNS * adjustments.cnsMultiplier);
    TSS = Math.round(TSS * adjustments.tssMultiplier);
    
    day.totalCNS=CNS; day.totalVolume=VOL; day.tss=TSS;
    store[curKey]=day; LS.set('elite_days',store);
    hist.push({d:curKey,tss:TSS}); if(hist.length>28) hist.shift(); LS.set('elite_tss',hist);
    setKPIs(day);
    document.getElementById('saveNote').textContent='Saved ‚úì';
    renderCal();
  }

  const weekModal=document.getElementById('weekModal');
  function closeWeek(){weekModal.classList.remove('show')}
  
  function getAdjustmentFactors(sportFocus, modalities) {
    // Default: no adjustment
    let cnsMultiplier = 1.0;
    let tssMultiplier = 1.0;
    
    if(!sportFocus) return {cnsMultiplier, tssMultiplier};
    
    const hasStrength = modalities.chest || modalities.back || modalities.legs;
    const hasPower = modalities.track;
    const hasEndurance = modalities.bike;
    const hasSkill = modalities.bjj;
    
    // Adjust based on sport focus preferences
    switch(sportFocus) {
      case 'Hybrid':
        // Balanced - no adjustment needed
        cnsMultiplier = 1.0;
        tssMultiplier = 1.0;
        break;
        
      case 'Strength':
        // Higher tolerance for strength work, lower for cardio
        if(hasStrength && !hasEndurance) {
          cnsMultiplier = 0.90; // Less CNS stress from strength when it's your focus
          tssMultiplier = 0.95;
        }
        if(hasEndurance && !hasStrength) {
          cnsMultiplier = 1.10; // More taxing when not your focus
          tssMultiplier = 1.10;
        }
        break;
        
      case 'Endurance':
        // Higher tolerance for cardio, lower for heavy strength
        if(hasEndurance && !hasStrength) {
          cnsMultiplier = 0.90;
          tssMultiplier = 0.95;
        }
        if(hasStrength && !hasEndurance) {
          cnsMultiplier = 1.10;
          tssMultiplier = 1.05;
        }
        break;
        
      case 'MMA':
        // Balanced but skill-focused
        if(hasSkill) {
          cnsMultiplier = 0.95; // Skill work is core to focus
        }
        if(hasPower) {
          cnsMultiplier = 0.95; // Power work is important
        }
        break;
        
      case 'BJJ':
        // Skill and endurance focused
        if(hasSkill) {
          cnsMultiplier = 0.90;
          tssMultiplier = 0.95;
        }
        if(hasEndurance) {
          cnsMultiplier = 0.95;
        }
        break;
        
      case 'Hypertrophy':
        // Volume tolerance, recovery important
        if(hasStrength) {
          cnsMultiplier = 0.95;
          tssMultiplier = 1.0;
        }
        break;
        
      case 'General':
        // Moderate adjustments for variety
        cnsMultiplier = 0.98;
        tssMultiplier = 0.98;
        break;
    }
    
    return {cnsMultiplier, tssMultiplier};
  }
  document.getElementById('weeklyBtn').onclick=()=>{
    const end=new Date(); const start=new Date(); start.setDate(start.getDate()-6);
    let totalCNS=0,totalVOL=0,totalTSS=0,days=0; const dailyCNS=[];
    
    // Track which modalities were done this week
    const modalitiesDone = {
      chest: false,
      back: false,
      legs: false,
      track: false,
      bike: false,
      bjj: false,
      walk: false
    };
    
    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const k=toKey(d); const day=store[k];
      if(day){
        days++; 
        totalCNS+=fmt(day.totalCNS); 
        totalVOL+=fmt(day.totalVolume); 
        totalTSS+=fmt(day.tss); 
        dailyCNS.push(fmt(day.totalCNS));
        
        // Track modalities
        if(day.modalities) {
          if(day.modalities.chest) modalitiesDone.chest = true;
          if(day.modalities.back) modalitiesDone.back = true;
          if(day.modalities.legs) modalitiesDone.legs = true;
          if(day.modalities.track) modalitiesDone.track = true;
          if(day.modalities.bike) modalitiesDone.bike = true;
          if(day.modalities.bjj) modalitiesDone.bjj = true;
          if(day.modalities.walk) modalitiesDone.walk = true;
        }
      }
    }
    
    const avgCNS=days?Math.round(totalCNS/days):0; const avgTSS=days?Math.round(totalTSS/days):0;
    const mean=avgCNS; const varc=dailyCNS.length? dailyCNS.reduce((s,v)=>s+Math.pow(v-mean,2),0)/dailyCNS.length : 0;
    const std=Math.sqrt(varc); const mono=std>0?(mean/std).toFixed(2):'0.00';
    const last28=hist.slice(-28); let ac='‚Äî', warn=false;
    if(last28.length>=14){const chronic=last28.reduce((a,b)=>a+fmt(b.tss),0)/last28.length; if(chronic>0){ac=(avgTSS*7/chronic).toFixed(2); warn=parseFloat(ac)>1.30}}
    
    // Get user's sport focus
    const profile = LS.get('elite_profile', {});
    const sportFocus = profile.sport || '';
    
    // Generate recommendations based on sport focus and modalities done
    let recommendations = generateRecommendations(sportFocus, modalitiesDone);
    
    document.getElementById('weekBody').innerHTML=`
      <div class="grid2">
        <div class="kpi"><div class="muted">Total Volume (lb)</div><div class="v">${totalVOL.toLocaleString()}</div></div>
        <div class="kpi"><div class="muted">Avg daily CNS</div><div class="v">${avgCNS}</div></div>
        <div class="kpi"><div class="muted">Weekly TSS</div><div class="v">${totalTSS}</div></div>
        <div class="kpi" style="border-left-color:${warn?'#ff6b6b':'#00ffb3'}"><div class="muted">Acute:Chronic</div><div class="v" style="color:${warn?'#ff6b6b':'#00ffb3'}">${ac}</div></div>
        <div class="kpi"><div class="muted">Monotony</div><div class="v">${mono}</div></div>
      </div>
      ${warn?`<div class="sec" style="margin-top:12px"><div class="bd"><div class="danger"><b>Injury-risk warning:</b> reduce next-week volume 15‚Äì20%, add 1‚Äì2 rest days, emphasize sleep & nutrition.</div></div></div>`:''}
      ${recommendations ? `<div class="sec" style="margin-top:12px"><div class="hd">üìã Training Balance ${sportFocus ? `(${sportFocus})` : ''}</div><div class="bd">${recommendations}</div></div>` : ''}
    `;
    weekModal.classList.add('show');
  };
  
  function generateRecommendations(sportFocus, modalitiesDone) {
    if(!sportFocus) return '';
    
    let html = '';
    const missing = [];
    const complete = [];
    
    // Domain definitions
    const domains = {
      strength: {
        name: 'Strength',
        modalities: ['chest', 'back', 'legs'],
        labels: {chest: 'Chest Day', back: 'Back Day', legs: 'Legs Day'}
      },
      power: {
        name: 'Power',
        modalities: ['track'],
        labels: {track: 'Track/Plyo'}
      },
      endurance: {
        name: 'Endurance',
        modalities: ['bike'],
        labels: {bike: 'Assault Bike'}
      },
      skill: {
        name: 'Skill',
        modalities: ['bjj'],
        labels: {bjj: 'BJJ'}
      },
      recovery: {
        name: 'Recovery',
        modalities: ['walk'],
        labels: {walk: 'Walk'}
      }
    };
    
    // Requirements by sport focus
    const requirements = {
      'Hybrid': ['strength', 'power', 'endurance', 'skill', 'recovery'],
      'MMA': ['strength', 'power', 'endurance', 'skill'],
      'Strength': ['strength', 'power'],
      'Endurance': ['endurance', 'recovery'],
      'Hypertrophy': ['strength', 'recovery'],
      'BJJ': ['strength', 'skill', 'endurance'],
      'General': ['strength', 'endurance', 'recovery']
    };
    
    const required = requirements[sportFocus] || [];
    
    // Check each required domain
    required.forEach(domainKey => {
      const domain = domains[domainKey];
      const missingInDomain = [];
      let anyDone = false;
      
      domain.modalities.forEach(mod => {
        if(modalitiesDone[mod]) {
          anyDone = true;
        } else {
          missingInDomain.push(domain.labels[mod]);
        }
      });
      
      if(domainKey === 'strength') {
        // Special case: strength needs all 3
        if(modalitiesDone.chest && modalitiesDone.back && modalitiesDone.legs) {
          complete.push(`<span style="color:#00ffb3">‚úì ${domain.name} (complete)</span>`);
        } else {
          missing.push(`<span style="color:#ffbb33">‚ö† ${domain.name}: Missing ${missingInDomain.join(', ')}</span>`);
        }
      } else {
        if(anyDone) {
          complete.push(`<span style="color:#00ffb3">‚úì ${domain.name}</span>`);
        } else {
          missing.push(`<span style="color:#ff6b6b">‚úó ${domain.name}: Add ${missingInDomain.join(', ')}</span>`);
        }
      }
    });
    
    if(complete.length > 0) {
      html += '<div style="margin-bottom:8px">' + complete.join(' ‚Ä¢ ') + '</div>';
    }
    
    if(missing.length === 0) {
      html += '<div style="color:#00ffb3;font-weight:600">üéØ Perfect balance - all domains covered!</div>';
    } else {
      html += '<div style="margin-top:8px"><b>Recommended for next week:</b></div>';
      html += '<div style="margin-top:4px">' + missing.join('<br>') + '</div>';
    }
    
    return html;
  }

  renderZoneChips();
  renderCal();
  
  // Initialize bike UI with default protocol on page load
  setTimeout(function() {
    if(bikeProto) {
      applyBikeUI();
      updateProtocolInstructions();
    }
  }, 100);
</script>
</body>
</html>
